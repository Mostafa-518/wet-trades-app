import{r as m,j as e,L as x,I as b,C as V,c as k,a as L,b as q,B as O,s as z,i as G,X as Y}from"./index-BW011E6G.js";import{T as H,a as Q,b as A,c as R}from"./tabs-DnPxN0tn.js";import{u as W}from"./useSubcontractHelpers-BFWX7zcB.js";import{S as P,a as D,b as E,c as F,d as N}from"./select-Dv4-AOa7.js";import{T as _}from"./textarea-Df658Ubv.js";import{S as B}from"./search-BW_M4e0M.js";import{P as X}from"./plus-BjXUjfi5.js";import{T as J}from"./trash-2-BLffjhfG.js";const $=s=>new Intl.NumberFormat("en-US",{style:"currency",currency:"EGP",minimumFractionDigits:0}).format(s);function K({subcontracts:s,value:o,onChange:u,getProjectName:h,getSubcontractorName:n,className:j=""}){const[l,a]=m.useState(""),[r,C]=m.useState(!1),w=m.useMemo(()=>s.filter(d=>d.contractType==="subcontract"||!d.contractType),[s]),I=m.useMemo(()=>{if(!l.trim())return w;const d=l.toLowerCase().split(/\s+/).filter(Boolean);return w.filter(g=>{var S;const T=g.contractId||"",t=n(g.subcontractor)||"",c=h(g.project)||"",f=g.dateOfIssuing||"",i=((S=g.totalValue)==null?void 0:S.toString())||"",v=`${T} ${t} ${c} ${f} ${i}`.toLowerCase();return d.every(U=>v.includes(U))})},[w,l,h,n]),p=w.find(d=>d.id===o),y=d=>{if(!d)return"-";try{return new Date(d).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return d}};return e.jsxs("div",{className:`relative ${j}`,children:[e.jsx(x,{htmlFor:"parent-contract",children:"Parent Subcontract"}),e.jsxs("div",{className:"relative",children:[e.jsx(b,{id:"parent-contract",placeholder:"Search by contract number, supplier, project, date, or amount...",value:l,onChange:d=>{a(d.target.value),C(!0)},onFocus:()=>C(!0),className:"pr-10"}),e.jsx(B,{className:"absolute right-3 top-3 h-4 w-4 text-muted-foreground"})]}),p&&e.jsx(V,{className:"mt-2 bg-blue-50 border-blue-200",children:e.jsx(k,{className:"p-3",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-blue-900",children:p.contractId}),e.jsxs("div",{className:"text-sm text-blue-700",children:[n(p.subcontractor)," • ",h(p.project)]}),e.jsxs("div",{className:"text-sm text-blue-600",children:[y(p.dateOfIssuing)," • ",$(p.totalValue||0)]})]}),e.jsx("button",{type:"button",onClick:()=>{u(""),a("")},className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"Change"})]})})}),r&&l&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto",children:I.length===0?e.jsx("div",{className:"p-3 text-center text-muted-foreground",children:"No matching contracts found"}):I.map(d=>e.jsxs("button",{type:"button",className:"w-full text-left p-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0",onClick:()=>{u(d.id),C(!1),a("")},children:[e.jsx("div",{className:"font-medium",children:d.contractId}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[n(d.subcontractor)," • ",h(d.project)]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[y(d.dateOfIssuing)," • ",$(d.totalValue||0)]})]},d.id))})]})}function Z({formData:s,setFormData:o,validProjects:u,validSubcontractors:h,subcontracts:n,getProjectName:j,getSubcontractorName:l}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"contractId",children:"Contract ID"}),e.jsx(b,{id:"contractId",value:s.contractId,onChange:a=>o(r=>({...r,contractId:a.target.value})),placeholder:"Enter contract ID"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"contractType",children:"Contract Type"}),e.jsxs(P,{value:s.contractType,onValueChange:a=>o(r=>({...r,contractType:a})),children:[e.jsx(D,{children:e.jsx(E,{})}),e.jsxs(F,{children:[e.jsx(N,{value:"subcontract",children:"Subcontract"}),e.jsx(N,{value:"ADD",children:"Addendum"})]})]})]}),s.contractType==="ADD"&&e.jsx(K,{subcontracts:n,value:s.parentSubcontractId,onChange:a=>o(r=>({...r,parentSubcontractId:a})),getProjectName:j,getSubcontractorName:l}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"project",children:"Project"}),e.jsxs(P,{value:s.project,onValueChange:a=>o(r=>({...r,project:a})),children:[e.jsx(D,{children:e.jsx(E,{placeholder:"Select project"})}),e.jsx(F,{children:u.map(a=>e.jsxs(N,{value:a.id,children:[a.name," - ",a.code]},a.id))})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"subcontractor",children:"Subcontractor"}),e.jsxs(P,{value:s.subcontractor,onValueChange:a=>o(r=>({...r,subcontractor:a})),children:[e.jsx(D,{children:e.jsx(E,{placeholder:"Select subcontractor"})}),e.jsx(F,{children:h.map(a=>e.jsx(N,{value:a.id,children:a.companyName},a.id))})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"status",children:"Status"}),e.jsxs(P,{value:s.status,onValueChange:a=>o(r=>({...r,status:a})),children:[e.jsx(D,{children:e.jsx(E,{})}),e.jsxs(F,{children:[e.jsx(N,{value:"draft",children:"Draft"}),e.jsx(N,{value:"pending",children:"Pending"}),e.jsx(N,{value:"active",children:"Active"}),e.jsx(N,{value:"completed",children:"Completed"}),e.jsx(N,{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"totalValue",children:"Total Value (Calculated without wastage)"}),e.jsx(b,{id:"totalValue",type:"number",value:s.totalValue,readOnly:!0,className:"bg-gray-50",placeholder:"Auto-calculated from trade items"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"This value is calculated as QTY × Rate for all trade items (excluding wastage)"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"startDate",children:"Start Date"}),e.jsx(b,{id:"startDate",type:"date",value:s.startDate,onChange:a=>o(r=>({...r,startDate:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"endDate",children:"End Date"}),e.jsx(b,{id:"endDate",type:"date",value:s.endDate,onChange:a=>o(r=>({...r,endDate:a.target.value}))})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"dateOfIssuing",children:"Date of Issuing"}),e.jsx(b,{id:"dateOfIssuing",type:"date",value:s.dateOfIssuing,onChange:a=>o(r=>({...r,dateOfIssuing:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"pdfUrl",children:"Contract PDF Link"}),e.jsx(b,{id:"pdfUrl",type:"url",value:s.pdfUrl,onChange:a=>o(r=>({...r,pdfUrl:a.target.value})),placeholder:"Paste the SharePoint PDF link"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Example: https://orascomconstructionegypt.sharepoint.com/..."})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"description",children:"Description"}),e.jsx(_,{id:"description",value:s.description,onChange:a=>o(r=>({...r,description:a.target.value})),placeholder:"Enter description",rows:3})]})]})}function ee({selectedItems:s,onItemsChange:o,trades:u,tradeItems:h}){const[n,j]=m.useState({trade:"",item:"",quantity:"",unitPrice:"",wastagePercentage:"0"}),[l,a]=m.useState(""),[r,C]=m.useState(""),w=t=>(h==null?void 0:h.filter(c=>c.trade_id===t))||[],I=()=>!n.trade||!n.item?null:(h==null?void 0:h.find(t=>t.trade_id===n.trade&&t.name===n.item))||null,p=m.useMemo(()=>{if(!l.trim())return u||[];const t=l.toLowerCase().split(/\s+/).filter(Boolean);return(u||[]).filter(c=>t.every(f=>(c.name||"").toLowerCase().includes(f)))},[u,l]),y=m.useMemo(()=>{const t=w(n.trade);if(!r.trim())return t;const c=r.toLowerCase().split(/\s+/).filter(Boolean);return t.filter(f=>c.every(i=>`${f.name} ${f.unit||""}`.toLowerCase().includes(i)))},[n.trade,r,h]),d=()=>{const t=I(),c=u==null?void 0:u.find(M=>M.id===n.trade),f=parseFloat(n.quantity),i=parseFloat(n.unitPrice),v=parseFloat(n.wastagePercentage)||0;if(!t||!c||f<=0||i<=0)return;const S=f*i,U={id:`temp-${Date.now()}`,trade:c.name,item:t.name,unit:t.unit||"",quantity:f,unitPrice:i,total:S,wastagePercentage:v};o([...s||[],U]),j({trade:"",item:"",quantity:"",unitPrice:"",wastagePercentage:"0"})},g=t=>{o((s||[]).filter(c=>c.id!==t))},T=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"EGP",minimumFractionDigits:0}).format(t);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(V,{children:[e.jsx(L,{children:e.jsx(q,{children:"Add Trade Item"})}),e.jsxs(k,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{children:"Trade"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(B,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(b,{placeholder:"Type to filter trades...",value:l,onChange:t=>a(t.target.value),className:"pl-9"})]}),e.jsxs(P,{value:n.trade,onValueChange:t=>j(c=>({...c,trade:t,item:""})),children:[e.jsx(D,{children:e.jsx(E,{placeholder:"Select trade"})}),e.jsxs(F,{children:[p.map(t=>e.jsx(N,{value:t.id,children:t.name},t.id)),p.length===0&&l&&e.jsx("div",{className:"px-2 py-3 text-sm text-muted-foreground",children:"No trades found"})]})]})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Item"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(B,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(b,{placeholder:"Type to filter items...",value:r,onChange:t=>C(t.target.value),className:"pl-9",disabled:!n.trade})]}),e.jsxs(P,{value:n.item,onValueChange:t=>j(c=>({...c,item:t})),disabled:!n.trade,children:[e.jsx(D,{children:e.jsx(E,{placeholder:"Select item"})}),e.jsxs(F,{children:[y.map(t=>e.jsxs(N,{value:t.name,children:[t.name," (",t.unit,")"]},t.id)),y.length===0&&r&&e.jsx("div",{className:"px-2 py-3 text-sm text-muted-foreground",children:"No items found"})]})]})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Quantity"}),e.jsx(b,{type:"number",value:n.quantity,onChange:t=>j(c=>({...c,quantity:t.target.value})),placeholder:"Enter quantity"})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Unit Price (EGP)"}),e.jsx(b,{type:"number",value:n.unitPrice,onChange:t=>j(c=>({...c,unitPrice:t.target.value})),placeholder:"Enter unit price"})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Wastage %"}),e.jsx(b,{type:"number",value:n.wastagePercentage,onChange:t=>j(c=>({...c,wastagePercentage:t.target.value})),placeholder:"Enter wastage percentage",min:"0"})]})]}),e.jsxs(O,{onClick:d,className:"w-full",disabled:!n.trade||!n.item||!n.quantity||!n.unitPrice,children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Add Item"]})]})]}),(s||[]).length>0&&e.jsxs(V,{children:[e.jsx(L,{children:e.jsxs(q,{children:["Selected Items (",(s||[]).length,")"]})}),e.jsxs(k,{children:[e.jsx("div",{className:"space-y-3",children:(s||[]).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium",children:[t.trade," - ",t.item]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[t.quantity," ",t.unit," × ",T(t.unitPrice),(t.wastagePercentage||0)>0&&e.jsxs("span",{className:"ml-2 text-orange-600",children:["(Wastage: ",t.wastagePercentage,"%)"]})]}),e.jsxs("div",{className:"text-sm font-medium text-green-600",children:["Total: ",T(t.total)]})]}),e.jsx(O,{variant:"ghost",size:"sm",onClick:()=>g(t.id),className:"text-red-600 hover:text-red-700",children:e.jsx(J,{className:"h-4 w-4"})})]},t.id))}),e.jsx("div",{className:"mt-4 p-4 bg-green-50 rounded-lg border border-green-200",children:e.jsxs("div",{className:"text-lg font-bold text-green-800",children:["Contract Total: ",T((s||[]).reduce((t,c)=>t+c.total,0))]})})]})]})]})}function te({selectedResponsibilities:s,onResponsibilitiesChange:o,responsibilities:u}){const[h,n]=m.useState(""),j=l=>{const a=s||[],r=a.includes(l)?a.filter(C=>C!==l):[...a,l];o(r)};return m.useMemo(()=>{if(!h.trim())return u||[];const l=h.toLowerCase().split(/\s+/).filter(Boolean);return(u||[]).filter(a=>l.every(r=>(a.name||"").toLowerCase().includes(r)))},[u,h]),e.jsxs(V,{children:[e.jsx(L,{children:e.jsx(q,{children:"Assign Responsibilities"})}),e.jsx(k,{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(x,{children:"Select Responsibilities (Optional)"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Select responsibilities that apply to this subcontract. You can skip this step if no specific responsibilities are needed."}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:(u||[]).map(l=>e.jsx(O,{variant:(s||[]).includes(l.name)?"default":"outline",size:"sm",onClick:()=>j(l.name),className:"justify-start",children:l.name},l.id))}),(s||[]).length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-3",children:(s||[]).map(l=>e.jsx(z,{variant:"secondary",children:l},l))}),(s||[]).length===0&&e.jsx("p",{className:"text-sm text-gray-500 mt-3 italic",children:"No responsibilities selected. You can proceed without selecting any responsibilities."})]})})]})}function se({subcontract:s,onSave:o,onClose:u}){const{projects:h,subcontractors:n,subcontracts:j,trades:l,tradeItems:a,responsibilities:r}=G(),{getProjectName:C,getSubcontractorName:w}=W(),[I,p]=m.useState({contractId:"",project:"",subcontractor:"",status:"draft",totalValue:0,startDate:"",endDate:"",dateOfIssuing:"",description:"",pdfUrl:"",contractType:"subcontract",parentSubcontractId:""}),[y,d]=m.useState([]),[g,T]=m.useState([]),t=(h||[]).filter(i=>i.id&&i.name&&i.id.trim()!==""&&i.name.trim()!==""),c=(n||[]).filter(i=>i.id&&i.companyName&&i.id.trim()!==""&&i.companyName.trim()!=="");m.useEffect(()=>{if(s){const i=(s.tradeItems||[]).reduce((v,S)=>v+(S.quantity||0)*(S.unitPrice||0),0);p({contractId:s.contractId||"",project:s.project||"",subcontractor:s.subcontractor||"",status:s.status||"draft",totalValue:i,startDate:s.startDate||"",endDate:s.endDate||"",dateOfIssuing:s.dateOfIssuing||"",description:s.description||"",pdfUrl:s.pdfUrl||"",contractType:s.contractType||"subcontract",parentSubcontractId:s.parentSubcontractId||""}),d(s.tradeItems||[]),T(s.responsibilities||[])}},[s]),m.useEffect(()=>{const i=(y||[]).reduce((v,S)=>v+(S.quantity||0)*(S.unitPrice||0),0);p(v=>({...v,totalValue:i}))},[y]);const f=async i=>{i.preventDefault();try{const v={...I,tradeItems:y||[],responsibilities:g||[]};await o(s.id,v),u()}catch{}};return e.jsxs("form",{onSubmit:f,className:"space-y-6",children:[e.jsxs(H,{defaultValue:"basic",className:"w-full",children:[e.jsxs(Q,{className:"grid w-full grid-cols-3",children:[e.jsx(A,{value:"basic",children:"Basic Info"}),e.jsxs(A,{value:"trades",children:["Trade Items (",(y||[]).length,")"]}),e.jsxs(A,{value:"responsibilities",children:["Responsibilities (",(g||[]).length,")"]})]}),e.jsx(R,{value:"basic",className:"space-y-4",children:e.jsxs(V,{children:[e.jsx(L,{children:e.jsx(q,{children:"Basic Information"})}),e.jsx(k,{children:e.jsx(Z,{formData:I,setFormData:p,validProjects:t,validSubcontractors:c,subcontracts:j||[],getProjectName:C,getSubcontractorName:w})})]})}),e.jsx(R,{value:"trades",className:"space-y-4",children:e.jsx(ee,{selectedItems:y||[],onItemsChange:i=>{d(i)},trades:l||[],tradeItems:a||[]})}),e.jsx(R,{value:"responsibilities",className:"space-y-4",children:e.jsx(te,{selectedResponsibilities:g||[],onResponsibilitiesChange:i=>{T(i)},responsibilities:r||[]})})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx(O,{type:"button",variant:"outline",onClick:u,children:"Cancel"}),e.jsx(O,{type:"submit",children:"Save Changes"})]})]})}function ue({subcontract:s,open:o,onClose:u,onSave:h}){return o?e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs(V,{className:"w-full max-w-2xl max-h-[90vh] overflow-auto",children:[e.jsx(L,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(q,{children:"Edit Subcontract"}),e.jsx(O,{variant:"ghost",size:"sm",onClick:u,children:e.jsx(Y,{className:"h-4 w-4"})})]})}),e.jsx(k,{children:e.jsx(se,{subcontract:s,onSave:h,onClose:u})})]})}):null}export{K as P,te as R,ue as S,ee as T,$ as f};
