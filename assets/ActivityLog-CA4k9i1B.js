import{m as P,o as q,r as a,j as t,C as G,a as J,b as K,c as O,I as Q,B as g,a3 as u}from"./index-BW011E6G.js";import{S as b,a as w,b as _,c as A,d as E}from"./select-Dv4-AOa7.js";import{T as L}from"./TableSelectionCheckbox-CnM1ep3P.js";import"./index-DcX0hMW7.js";function ee(){const{toast:l}=P(),{userRole:U}=q(),n=U==="admin",[m,k]=a.useState([]),[y,d]=a.useState(!1),[p,D]=a.useState("all"),[v,F]=a.useState("all"),[h,T]=a.useState(""),[C,N]=a.useState({}),[x,o]=a.useState(new Set),f=async()=>{d(!0);const{data:e,error:s}=await u.from("audit_logs").select("*").order("created_at",{ascending:!1}).limit(500);s?(console.error("Failed to fetch audit logs",s),l({title:"Error",description:"Failed to load activity logs",variant:"destructive"})):k(e||[]),d(!1)};a.useEffect(()=>{f()},[]),a.useEffect(()=>{(async()=>{const s=Array.from(new Set(m.map(j=>j.user_id).filter(Boolean)));if(s.length===0){N({});return}const{data:i,error:c}=await u.from("user_profiles").select("id, full_name, email").in("id",s);if(!c&&i){const j={};i.forEach(S=>{j[S.id]={full_name:S.full_name??null,email:S.email??null}}),N(j)}})()},[m]);const r=a.useMemo(()=>m.filter(e=>{var s;return(p==="all"||e.entity===p)&&(v==="all"||e.action===v)&&(!h||((s=e.entity_id)==null?void 0:s.toLowerCase().includes(h.toLowerCase()))||e.entity.toLowerCase().includes(h.toLowerCase()))}),[m,p,v,h]),I=(e,s)=>{o(i=>{const c=new Set(i);return s?c.add(e):c.delete(e),c})},B=a.useMemo(()=>r.length>0&&r.every(e=>x.has(e.id)),[r,x]),$=e=>{if(!e){o(new Set);return}o(new Set(r.map(s=>s.id)))};a.useEffect(()=>{o(e=>{const s=new Set;return r.forEach(i=>{e.has(i.id)&&s.add(i.id)}),s})},[r]);const z=async()=>{if(!n)return;const e=Array.from(x);if(e.length===0){l({title:"No selection",description:"Select at least one activity to delete."});return}if(!confirm(`Delete ${e.length} selected activit${e.length===1?"y":"ies"}?`))return;d(!0);const{error:s}=await u.from("audit_logs").delete().in("id",e);s?(console.error("Delete selected failed",s),l({title:"Delete failed",description:s.message,variant:"destructive"})):(l({title:"Deleted",description:`Deleted ${e.length} activit${e.length===1?"y":"ies"}.`}),o(new Set),await f()),d(!1)},M=async()=>{if(n&&confirm("This will delete all activity logs. Continue?")){d(!0);try{const{error:e}=await u.rpc("admin_clear_audit_logs");if(e){const{error:s}=await u.from("audit_logs").delete().not("id","is",null);if(s)throw s}l({title:"Cleared",description:"All activity logs have been deleted."}),o(new Set),await f()}catch(e){console.error("Clear all failed",e),l({title:"Clear failed",description:(e==null?void 0:e.message)||"Could not clear logs",variant:"destructive"})}finally{d(!1)}}},R=async e=>{if(n)try{if(e.entity!=="subcontracts"){l({title:"Undo not available",description:"Undo is currently supported for subcontracts only."});return}const{error:s}=await u.rpc("admin_undo_subcontract",{p_log_id:e.id});if(s)throw s;l({title:"Undone",description:"Action has been undone."}),f()}catch(s){console.error("Undo failed",s),l({title:"Undo failed",description:(s==null?void 0:s.message)||"Could not undo action",variant:"destructive"})}},V=["all","subcontracts","projects","subcontractors","trades","trade_items"],H=["all","insert","delete"];return t.jsxs("div",{children:[t.jsxs("header",{className:"mb-4",children:[t.jsx("h1",{className:"text-2xl font-bold",children:"Activity Log"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Track all changes across key entities. Admins can undo subcontract actions."})]}),t.jsxs(G,{children:[t.jsx(J,{children:t.jsx(K,{children:"Filters"})}),t.jsxs(O,{className:"grid grid-cols-1 md:grid-cols-4 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium",children:"Entity"}),t.jsxs(b,{value:p,onValueChange:D,children:[t.jsx(w,{children:t.jsx(_,{})}),t.jsx(A,{children:V.map(e=>t.jsx(E,{value:e,children:e},e))})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium",children:"Action"}),t.jsxs(b,{value:v,onValueChange:F,children:[t.jsx(w,{children:t.jsx(_,{})}),t.jsx(A,{children:H.map(e=>t.jsx(E,{value:e,children:e},e))})]})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"text-xs font-medium",children:"Search"}),t.jsx(Q,{placeholder:"Search by entity or ID",value:h,onChange:e=>T(e.target.value)})]}),t.jsxs("div",{className:"md:col-span-4 flex flex-wrap gap-2 justify-end",children:[n&&t.jsxs(t.Fragment,{children:[t.jsx(g,{variant:"destructive",onClick:z,disabled:y||x.size===0,children:"Delete Selected"}),t.jsx(g,{variant:"destructive",onClick:M,disabled:y||m.length===0,children:"Clear All"})]}),t.jsx(g,{variant:"outline",onClick:f,disabled:y,children:"Refresh"})]})]})]}),t.jsxs("div",{className:"mt-4 border rounded-lg overflow-hidden",children:[t.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 text-xs font-semibold px-4 py-2",children:[n&&t.jsx("div",{className:"col-span-1",children:t.jsx(L,{checked:B,onCheckedChange:e=>$(!!e),ariaLabel:"Select all activities"})}),t.jsx("div",{className:"col-span-3",children:"Timestamp"}),t.jsx("div",{className:"col-span-2",children:"User"}),t.jsx("div",{className:"col-span-2",children:"Entity"}),t.jsx("div",{className:n?"col-span-1":"col-span-2",children:"Action"}),t.jsx("div",{className:"col-span-2",children:"Entity ID"}),t.jsx("div",{className:"col-span-1 text-right",children:"Undo"})]}),t.jsxs("div",{className:"divide-y",children:[r.map(e=>{var s,i;return t.jsxs("div",{className:"grid grid-cols-12 px-4 py-2 items-center text-sm",children:[n&&t.jsx("div",{className:"col-span-1",children:t.jsx(L,{checked:x.has(e.id),onCheckedChange:c=>I(e.id,!!c),ariaLabel:`Select activity ${e.id}`})}),t.jsx("div",{className:"col-span-3",children:new Date(e.created_at).toLocaleString()}),t.jsx("div",{className:"col-span-2",children:e.user_id?((s=C[e.user_id])==null?void 0:s.full_name)||((i=C[e.user_id])==null?void 0:i.email)||e.user_id.slice(0,8):"system"}),t.jsx("div",{className:"col-span-2",children:e.entity}),t.jsx("div",{className:n?"col-span-1 capitalize":"col-span-2 capitalize",children:e.action}),t.jsx("div",{className:"col-span-2 truncate",title:e.entity_id||"",children:e.entity_id||"-"}),t.jsx("div",{className:"col-span-1 text-right",children:n&&e.entity==="subcontracts"&&t.jsx(g,{size:"sm",variant:"outline",onClick:()=>R(e),children:"Undo"})})]},e.id)}),r.length===0&&t.jsx("div",{className:"px-4 py-6 text-sm text-center text-muted-foreground",children:"No activity found."})]})]})]})}export{ee as ActivityLog,ee as default};
