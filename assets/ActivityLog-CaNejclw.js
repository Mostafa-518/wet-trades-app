import{m as K,o as Q,j as t,C as w,a as b,b as A,c as E,r as i,I as W,B as y,a3 as m}from"./index-CUi0-ZAd.js";import{S as k,a as L,b as U,c as D,d as F}from"./select-DBe7YI5z.js";import{T}from"./TableSelectionCheckbox-CyseAzl3.js";import"./index-CYfJLrVV.js";function te(){const{toast:l}=K(),{userRole:I}=Q(),n=I==="admin";if(!n)return t.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:t.jsxs(w,{className:"w-full max-w-md",children:[t.jsx(b,{children:t.jsx(A,{className:"text-center",children:"Access Restricted"})}),t.jsx(E,{className:"text-center",children:t.jsx("p",{className:"text-muted-foreground",children:"Access to activity logs is restricted to administrators only for security purposes."})})]})});const[u,$]=i.useState([]),[g,d]=i.useState(!1),[p,B]=i.useState("all"),[j,M]=i.useState("all"),[h,z]=i.useState(""),[_,C]=i.useState({}),[x,o]=i.useState(new Set),N={subcontracts:"admin_undo_subcontract",projects:"admin_undo_project",subcontractors:"admin_undo_subcontractor",trades:"admin_undo_trade",trade_items:"admin_undo_trade_item"},f=async()=>{d(!0);const{data:e,error:s}=await m.from("audit_logs").select("*").order("created_at",{ascending:!1}).limit(500);s?(console.error("Failed to fetch audit logs",s),l({title:"Error",description:"Failed to load activity logs",variant:"destructive"})):$(e||[]),d(!1)};i.useEffect(()=>{f()},[]),i.useEffect(()=>{(async()=>{const s=Array.from(new Set(u.map(v=>v.user_id).filter(Boolean)));if(s.length===0){C({});return}const{data:a,error:c}=await m.from("user_profiles").select("id, full_name, email").in("id",s);if(!c&&a){const v={};a.forEach(S=>{v[S.id]={full_name:S.full_name??null,email:S.email??null}}),C(v)}})()},[u]);const r=i.useMemo(()=>u.filter(e=>{var s;return(p==="all"||e.entity===p)&&(j==="all"||e.action===j)&&(!h||((s=e.entity_id)==null?void 0:s.toLowerCase().includes(h.toLowerCase()))||e.entity.toLowerCase().includes(h.toLowerCase()))}),[u,p,j,h]),R=(e,s)=>{o(a=>{const c=new Set(a);return s?c.add(e):c.delete(e),c})},V=i.useMemo(()=>r.length>0&&r.every(e=>x.has(e.id)),[r,x]),H=e=>{if(!e){o(new Set);return}o(new Set(r.map(s=>s.id)))};i.useEffect(()=>{o(e=>{const s=new Set;return r.forEach(a=>{e.has(a.id)&&s.add(a.id)}),s})},[r]);const O=async()=>{if(!n)return;const e=Array.from(x);if(e.length===0){l({title:"No selection",description:"Select at least one activity to delete."});return}if(!confirm(`Delete ${e.length} selected activit${e.length===1?"y":"ies"}?`))return;d(!0);const{error:s}=await m.from("audit_logs").delete().in("id",e);s?(console.error("Delete selected failed",s),l({title:"Delete failed",description:s.message,variant:"destructive"})):(l({title:"Deleted",description:`Deleted ${e.length} activit${e.length===1?"y":"ies"}.`}),o(new Set),await f()),d(!1)},P=async()=>{if(n&&confirm("This will delete all activity logs. Continue?")){d(!0);try{const{error:e}=await m.rpc("admin_clear_audit_logs");if(e){const{error:s}=await m.from("audit_logs").delete().not("id","is",null);if(s)throw s}l({title:"Cleared",description:"All activity logs have been deleted."}),o(new Set),await f()}catch(e){console.error("Clear all failed",e),l({title:"Clear failed",description:(e==null?void 0:e.message)||"Could not clear logs",variant:"destructive"})}finally{d(!1)}}},q=async e=>{if(!n)return;const s=N[e.entity];if(!s){l({title:"Undo not available",description:`No undo function found for entity "${e.entity}".`});return}try{const{error:a}=await m.rpc(s,{p_log_id:e.id});if(a)throw a;l({title:"Undone",description:"Action has been undone."}),f()}catch(a){console.error("Undo failed",a),l({title:"Undo failed",description:(a==null?void 0:a.message)||"Could not undo action",variant:"destructive"})}},G=["all",...Object.keys(N)],J=["all","insert","delete"];return t.jsxs("div",{children:[t.jsxs("header",{className:"mb-4",children:[t.jsx("h1",{className:"text-2xl font-bold",children:"Activity Log"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Track all changes across key entities. Admins can undo supported actions."})]}),t.jsxs(w,{children:[t.jsx(b,{children:t.jsx(A,{children:"Filters"})}),t.jsxs(E,{className:"grid grid-cols-1 md:grid-cols-4 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium",children:"Entity"}),t.jsxs(k,{value:p,onValueChange:B,children:[t.jsx(L,{children:t.jsx(U,{})}),t.jsx(D,{children:G.map(e=>t.jsx(F,{value:e,children:e},e))})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium",children:"Action"}),t.jsxs(k,{value:j,onValueChange:M,children:[t.jsx(L,{children:t.jsx(U,{})}),t.jsx(D,{children:J.map(e=>t.jsx(F,{value:e,children:e},e))})]})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"text-xs font-medium",children:"Search"}),t.jsx(W,{placeholder:"Search by entity or ID",value:h,onChange:e=>z(e.target.value)})]}),t.jsxs("div",{className:"md:col-span-4 flex flex-wrap gap-2 justify-end",children:[n&&t.jsxs(t.Fragment,{children:[t.jsx(y,{variant:"destructive",onClick:O,disabled:g||x.size===0,children:"Delete Selected"}),t.jsx(y,{variant:"destructive",onClick:P,disabled:g||u.length===0,children:"Clear All"})]}),t.jsx(y,{variant:"outline",onClick:f,disabled:g,children:"Refresh"})]})]})]}),t.jsxs("div",{className:"mt-4 border rounded-lg overflow-hidden",children:[t.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 text-xs font-semibold px-4 py-2",children:[n&&t.jsx("div",{className:"col-span-1",children:t.jsx(T,{checked:V,onCheckedChange:e=>H(!!e),ariaLabel:"Select all activities"})}),t.jsx("div",{className:"col-span-3",children:"Timestamp"}),t.jsx("div",{className:"col-span-2",children:"User"}),t.jsx("div",{className:"col-span-2",children:"Entity"}),t.jsx("div",{className:n?"col-span-1":"col-span-2",children:"Action"}),t.jsx("div",{className:"col-span-2",children:"Entity ID"}),t.jsx("div",{className:"col-span-1 text-right",children:"Undo"})]}),t.jsxs("div",{className:"divide-y",children:[r.map(e=>{var s,a;return t.jsxs("div",{className:"grid grid-cols-12 px-4 py-2 items-center text-sm",children:[n&&t.jsx("div",{className:"col-span-1",children:t.jsx(T,{checked:x.has(e.id),onCheckedChange:c=>R(e.id,!!c),ariaLabel:`Select activity ${e.id}`})}),t.jsx("div",{className:"col-span-3",children:new Date(e.created_at).toLocaleString()}),t.jsx("div",{className:"col-span-2",children:e.user_id?((s=_[e.user_id])==null?void 0:s.full_name)||((a=_[e.user_id])==null?void 0:a.email)||e.user_id.slice(0,8):"system"}),t.jsx("div",{className:"col-span-2",children:e.entity}),t.jsx("div",{className:n?"col-span-1 capitalize":"col-span-2 capitalize",children:e.action}),t.jsx("div",{className:"col-span-2 truncate",title:e.entity_id||"",children:e.entity_id||"-"}),t.jsx("div",{className:"col-span-1 text-right",children:n&&N[e.entity]&&t.jsx(y,{size:"sm",variant:"outline",onClick:()=>q(e),children:"Undo"})})]},e.id)}),r.length===0&&t.jsx("div",{className:"px-4 py-6 text-sm text-center text-muted-foreground",children:"No activity found."})]})]})]})}export{te as ActivityLog,te as default};
