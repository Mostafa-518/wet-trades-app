import{a3 as k,j as e,B as S,T as ee,d as te,e as z,f as P,g as se,h as D,I as y,r as F,C as b,a as v,b as w,c as N,am as ne,an as ie,a4 as ae,m as re}from"./index-BPW1VvWz.js";import{u as W,e as Q,F as h,a as j,b as p,c as f,d as I}from"./form-1thndS-e.js";import{t as O,o as ce,s as q}from"./types-BwTGUGNZ.js";import{S as L,a as $,b as V,c as M,d as A}from"./select-MYwvS03t.js";import{D as le,a as de,b as oe,c as me}from"./dialog-IKdgUk5L.js";import{E as xe}from"./jspdf.es.min-E73mDSPa.js";import{u as B,w as ue}from"./xlsx-CKN5doRT.js";import"./index-C21_ivdF.js";class he{async createDraft(n){const{item_name:t,unit:i,trade_id:o,quantity:m,currency:s="EGP",location:c,specs:u,project_id:_}=n,{data:d}=await k.auth.getUser(),g=d==null?void 0:d.user;if(!g)throw new Error("You must be logged in to create an estimate");const U={user_id:g.id,status:"draft",item_name:t,unit:i,trade_id:o??null,quantity:m??null,currency:s,location:c??null,specs:u??null,project_id:_??null},{data:G,error:E}=await k.from("estimates").insert(U).select("*").single();if(E)throw E;return G}async getById(n){const{data:t,error:i}=await k.from("estimates").select("*").eq("id",n).single();if(i)throw i;return t}async listMyRecent(n=10){const{data:t}=await k.auth.getUser(),i=t==null?void 0:t.user;if(!i)throw new Error("You must be logged in");const{data:o,error:m}=await k.from("estimates").select("id, item_name, unit, status, created_at").eq("user_id",i.id).order("created_at",{ascending:!1}).limit(n);if(m)throw m;return o??[]}async estimateWithAI(n){const{data:t,error:i}=await k.functions.invoke("estimate-with-ai",{body:n});if(i)throw i;return t}async saveEstimateFromResult(n,t){var _;const i=await this.createDraft(n),o=((_=t.top_context)==null?void 0:_.map(d=>d.id))??null,{data:m,error:s}=await k.from("estimates").update({ai_rate:t.unit_rate,ai_confidence:t.confidence,ai_notes:t.rationale,final_rate:t.unit_rate,source_item_ids:o}).eq("id",i.id).select("*").single();if(s)throw s;const c=d=>{const g=(d||"").toLowerCase();return g.startsWith("material")?"material":g.startsWith("labor")?"labor":g.startsWith("equip")?"equipment":"overhead"},u=(t.breakdown||[]).map(d=>({estimate_id:i.id,type:c(d.category),name:d.name,unit:d.unit,qty:d.qty,unit_price:d.unit_price,total_price:d.total,source_ref:null}));if(u.length){const{error:d}=await k.from("estimate_line_items").insert(u);if(d)throw d}return(m==null?void 0:m.id)??i.id}async submitFeedback(n,t,i){const{data:o}=await k.auth.getUser(),m=o==null?void 0:o.user;if(!m)throw new Error("You must be logged in to submit feedback");const{error:s}=await k.from("estimate_feedback").insert({estimate_id:n,user_id:m.id,rating:t,reason:i??null});if(s)throw s}}const R=new he;function je({itemName:a,unit:n,currency:t,unitRate:i,confidence:o,rationale:m,contextSize:s,generatedAt:c,onShowContext:u}){const _=Math.round(o*100);return e.jsxs("section",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end md:justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Rate Summary"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[a," — Unit: ",n]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl font-bold",children:[i.toFixed(2)," ",t,"/",n]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Confidence: ",_,"%"]})]})]}),e.jsxs("p",{className:"text-sm leading-relaxed",children:[e.jsx("span",{className:"font-medium",children:"Rationale:"})," ",m]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[e.jsxs("div",{children:["Context: ",s," records • Generated ",new Date(c).toLocaleString()]}),u&&e.jsx(S,{size:"sm",variant:"outline",onClick:u,children:"View matched items"})]})]})}function pe({items:a,currency:n,onChange:t}){const i=(s,c)=>{const _=a.map((d,g)=>g===s?{...d,...c}:d).map((d,g)=>g===s&&(c.qty!==void 0||c.unit_price!==void 0)?{...d,total:Number(((c.qty??d.qty)*(c.unit_price??d.unit_price)).toFixed(2))}:d);t(_)},o=a.reduce((s,c)=>(s[c.category]=(s[c.category]??0)+(Number.isFinite(c.total)?c.total:0),s),{}),m=Object.values(o).reduce((s,c)=>s+c,0);return e.jsxs("div",{className:"space-y-3",children:[e.jsxs(ee,{children:[e.jsx(te,{children:e.jsxs(z,{children:[e.jsx(P,{children:"Component"}),e.jsx(P,{className:"w-24",children:"Qty"}),e.jsx(P,{className:"w-20",children:"Unit"}),e.jsxs(P,{className:"w-32",children:["Unit Price (",n,")"]}),e.jsxs(P,{className:"w-32 text-right",children:["Total (",n,")"]})]})}),e.jsx(se,{children:a.map((s,c)=>e.jsxs(z,{children:[e.jsxs(D,{children:[e.jsx("div",{className:"text-sm font-medium capitalize",children:s.category}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.name})]}),e.jsx(D,{children:e.jsx(y,{type:"number",step:"0.01",value:Number.isFinite(s.qty)?s.qty:0,onChange:u=>i(c,{qty:parseFloat(u.target.value||"0")})})}),e.jsx(D,{children:e.jsx(y,{value:s.unit,onChange:u=>i(c,{unit:u.target.value})})}),e.jsx(D,{children:e.jsx(y,{type:"number",step:"0.01",value:Number.isFinite(s.unit_price)?s.unit_price:0,onChange:u=>i(c,{unit_price:parseFloat(u.target.value||"0")})})}),e.jsx(D,{className:"text-right font-medium",children:Number.isFinite(s.total)?s.total.toFixed(2):"0.00"})]},c))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[Object.entries(o).map(([s,c])=>e.jsxs("div",{className:"flex items-center justify-between rounded-md border px-3 py-2",children:[e.jsx("div",{className:"text-sm font-medium capitalize",children:s}),e.jsxs("div",{className:"text-sm",children:[c.toFixed(2)," ",n]})]},s)),e.jsxs("div",{className:"md:col-span-3 flex items-center justify-between rounded-md border px-3 py-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Grand Total"}),e.jsxs("div",{className:"text-sm font-semibold",children:[m.toFixed(2)," ",n]})]})]}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(S,{variant:"secondary",onClick:()=>t(a),children:"Reset"})})]})}function fe({onSubmit:a}){const n=async t=>{let i;t!=="accurate"&&(i=window.prompt("Add an optional comment (press Cancel to skip)")??void 0),await a(t,i)};return e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(S,{variant:"outline",onClick:()=>n("accurate"),children:"Accurate"}),e.jsx(S,{variant:"outline",onClick:()=>n("too_high"),children:"Too high"}),e.jsx(S,{variant:"outline",onClick:()=>n("too_low"),children:"Too low"}),e.jsx(S,{variant:"outline",onClick:()=>n("wrong_composition"),children:"Wrong composition"})]})}function ge({items:a,open:n,onOpenChange:t}){return e.jsx(le,{open:n,onOpenChange:t,children:e.jsxs(de,{className:"max-w-2xl",children:[e.jsx(oe,{children:e.jsx(me,{children:"Matched Historical Items"})}),e.jsxs("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:[a.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No matched items returned."}),a.map(i=>e.jsxs("div",{className:"rounded-md border p-3",children:[e.jsxs("div",{className:"text-sm font-medium",children:[i.item_name," ",e.jsxs("span",{className:"text-muted-foreground",children:["(",i.unit,")"]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Rate: ",i.rate??"-"," ",i.currency??""," • ",new Date(i.created_at).toLocaleDateString()]})]},i.id))]})]})})}const H=ce({item_name:q().min(2,"Item name is required"),unit:q().min(1,"Unit is required"),trade_id:q().optional(),quantity:q().optional().transform(a=>a?Number(a):void 0).refine(a=>a===void 0||!Number.isNaN(a)&&a>=0,{message:"Quantity must be a positive number"}),currency:q().default("EGP"),specs:q().optional(),location:q().optional()});function Ie(){return F.useEffect(()=>{const a="AI-Powered Rate Estimator | Wet Trades Management",n="Estimate construction trade item rates using recorded items and AI-generated cost breakdowns with editable line items and live recalculation.";document.title=a;let t=document.querySelector('meta[name="description"]');t||(t=document.createElement("meta"),t.setAttribute("name","description"),document.head.appendChild(t)),t.setAttribute("content",n);let i=document.querySelector('link[rel="canonical"]');i||(i=document.createElement("link"),i.setAttribute("rel","canonical"),document.head.appendChild(i)),i.setAttribute("href",window.location.href)},[]),e.jsxs("div",{children:[e.jsxs("header",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"AI-Powered Rate Estimator"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Quickly generate accurate rate estimations for construction trade items using historical data and AI."})]}),e.jsxs("main",{className:"space-y-6",children:[e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"Create Draft Estimate"})}),e.jsx(N,{children:e.jsx(ye,{})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"Recent Drafts"})}),e.jsx(N,{children:e.jsx(be,{})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"AI Estimation"})}),e.jsx(N,{children:e.jsx(ve,{})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"Purpose & Goal"})}),e.jsx(N,{children:e.jsxs("ul",{className:"list-disc pl-5 space-y-1 text-sm",children:[e.jsx("li",{children:"Designed for quantity surveyors, estimators, procurement, and site engineers."}),e.jsx("li",{children:"Deliver a reliable unit rate (e.g., EGP/m², EGP/m³) with a transparent AI-generated breakdown."}),e.jsx("li",{children:"Performance target: 1–3s per estimation with cached fallback."})]})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"User Inputs"})}),e.jsx(N,{children:e.jsxs("ul",{className:"list-disc pl-5 space-y-1 text-sm",children:[e.jsx("li",{children:"Trade category"}),e.jsx("li",{children:"Item name"}),e.jsx("li",{children:"Unit of measurement"}),e.jsx("li",{children:"Specifications (optional)"}),e.jsx("li",{children:"Location / project type (optional)"}),e.jsx("li",{children:"Quantity (optional)"}),e.jsx("li",{children:"Advanced (optional): currency (default EGP), target margin %, uncertainty range"})]})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"Data Source & Matching"})}),e.jsx(N,{children:e.jsxs("ul",{className:"list-disc pl-5 space-y-1 text-sm",children:[e.jsx("li",{children:"Search recorded items from the database by trade and unit first."}),e.jsx("li",{children:"Combine exact/lexical matches with semantic similarity (embeddings) for top-k candidates."}),e.jsx("li",{children:"Apply time-decay weighting to prioritize recent data; optional market/inflation adjustment."})]})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"AI Breakdown Logic"})}),e.jsx(N,{children:e.jsxs("ul",{className:"list-disc pl-5 space-y-1 text-sm",children:[e.jsx("li",{children:"Analyze matched history to calculate an estimated unit rate and confidence score."}),e.jsx("li",{children:"Generate editable breakdown lines: materials, labor, equipment, overhead/profit."}),e.jsx("li",{children:"Include key assumptions and reference source items used for grounding."})]})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"Output Format & UX"})}),e.jsx(N,{children:e.jsxs("ul",{className:"list-disc pl-5 space-y-1 text-sm",children:[e.jsx("li",{children:"Rate summary: median, min–max, confidence, and top source references."}),e.jsx("li",{children:"Editable breakdown table with live recalculation, undo/redo, and reset-to-AI."}),e.jsx("li",{children:"AI notes and assumptions panel with visible inflation/market factors applied."})]})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"User Actions"})}),e.jsx(N,{children:e.jsxs("ul",{className:"list-disc pl-5 space-y-1 text-sm",children:[e.jsx("li",{children:"Save estimation (draft/final) and retrieve later."}),e.jsx("li",{children:"Export to PDF/Excel including assumptions and sources."}),e.jsx("li",{children:"Provide feedback (thumbs up/down + reason) to improve accuracy."}),e.jsx("li",{children:"Use in Subcontract: push final rate/lines into a new subcontract flow."})]})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"Technical Notes"})}),e.jsx(N,{children:e.jsxs("ul",{className:"list-disc pl-5 space-y-1 text-sm",children:[e.jsx("li",{children:"Backend: Supabase tables for estimates and line items with RLS; audit on insert/delete."}),e.jsx("li",{children:"Similarity via Edge Function (embeddings) and an AI breakdown generator function."}),e.jsx("li",{children:"Caching by input hash; client pricing engine recalculates edits instantly."})]})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"Future Enhancements"})}),e.jsx(N,{children:e.jsxs("ul",{className:"list-disc pl-5 space-y-1 text-sm",children:[e.jsx("li",{children:"Live market price APIs; scenario simulation (e.g., +10% cement)."}),e.jsx("li",{children:"Benchmarking against industry averages; token-by-token streaming for AI notes."})]})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsx(w,{children:"Pre-Implementation Discussion"})}),e.jsxs(N,{children:[e.jsx("p",{className:"text-sm mb-2",children:"All features, logic, data flow, and interactions must be reviewed and approved before coding the interactive estimator UI."}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1 text-sm",children:[e.jsx("li",{children:"Inflation index source (internal vs CPI), k similar items, and time window."}),e.jsx("li",{children:"Confidence calculation formula and export branding requirements."}),e.jsx("li",{children:"Finalize permissions for who can edit/delete estimates."})]})]})]})]})]})}function ye(){const{trades:a,isLoading:n}=ne(),t=W({resolver:O(H),defaultValues:{item_name:"",unit:"m²",trade_id:void 0,quantity:void 0,currency:"EGP",specs:"",location:""}}),{executeAsync:i,isPending:o}=ie(R.createDraft,{successMessage:"Draft estimate created"}),m=async s=>{await i(s),t.reset({...t.getValues(),item_name:""})};return e.jsx(Q,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(m),className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(h,{control:t.control,name:"trade_id",render:({field:s})=>e.jsxs(j,{children:[e.jsx(p,{children:"Trade"}),e.jsxs(L,{onValueChange:s.onChange,value:s.value,disabled:n,children:[e.jsx(f,{children:e.jsx($,{children:e.jsx(V,{placeholder:n?"Loading trades...":"Select trade (optional)"})})}),e.jsx(M,{children:a.map(c=>e.jsx(A,{value:c.id,children:c.name},c.id))})]}),e.jsx(I,{})]})}),e.jsx(h,{control:t.control,name:"item_name",render:({field:s})=>e.jsxs(j,{children:[e.jsx(p,{children:"Item name"}),e.jsx(f,{children:e.jsx(y,{placeholder:"e.g., 20mm plaster on walls",...s})}),e.jsx(I,{})]})}),e.jsx(h,{control:t.control,name:"unit",render:({field:s})=>e.jsxs(j,{children:[e.jsx(p,{children:"Unit"}),e.jsx(f,{children:e.jsx(y,{placeholder:"e.g., m²",...s})}),e.jsx(I,{})]})}),e.jsx(h,{control:t.control,name:"specs",render:({field:s})=>e.jsxs(j,{children:[e.jsx(p,{children:"Specifications (optional)"}),e.jsx(f,{children:e.jsx(y,{placeholder:"e.g., 20mm thickness, cement-sand 1:4",...s})}),e.jsx(I,{})]})}),e.jsx(h,{control:t.control,name:"location",render:({field:s})=>e.jsxs(j,{children:[e.jsx(p,{children:"Location / Project Type (optional)"}),e.jsx(f,{children:e.jsx(y,{placeholder:"e.g., Cairo, Residential",...s})}),e.jsx(I,{})]})}),e.jsx(h,{control:t.control,name:"quantity",render:({field:s})=>e.jsxs(j,{children:[e.jsx(p,{children:"Quantity (optional)"}),e.jsx(f,{children:e.jsx(y,{type:"number",step:"0.01",placeholder:"e.g., 1500",value:s.value??"",onChange:s.onChange})}),e.jsx(I,{})]})}),e.jsx(h,{control:t.control,name:"currency",render:({field:s})=>e.jsxs(j,{children:[e.jsx(p,{children:"Currency"}),e.jsxs(L,{onValueChange:s.onChange,value:s.value,children:[e.jsx(f,{children:e.jsx($,{children:e.jsx(V,{placeholder:"Select currency"})})}),e.jsxs(M,{children:[e.jsx(A,{value:"EGP",children:"EGP"}),e.jsx(A,{value:"USD",children:"USD"}),e.jsx(A,{value:"EUR",children:"EUR"})]})]}),e.jsx(I,{})]})}),e.jsx("div",{className:"md:col-span-3 flex justify-end gap-2",children:e.jsx(S,{type:"submit",disabled:o,children:"Save Draft"})})]})})}function be(){const{data:a=[],isLoading:n,error:t}=ae({queryKey:["estimates","recent"],queryFn:()=>R.listMyRecent(10),staleTime:6e4});return n?e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading recent drafts..."}):t?e.jsx("div",{className:"text-sm text-destructive",children:"Failed to load drafts"}):a.length?e.jsx("ul",{className:"space-y-2",children:a.map(i=>e.jsxs("li",{className:"flex items-center justify-between border rounded-md p-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:[i.item_name," ",e.jsxs("span",{className:"text-muted-foreground",children:["(",i.unit,")"]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Created ",new Date(i.created_at).toLocaleString()]})]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded bg-secondary text-secondary-foreground",children:i.status})]},i.id))}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No drafts yet."})}function ve(){const{toast:a}=re(),n=W({resolver:O(H),defaultValues:{item_name:"",unit:"m²",trade_id:void 0,quantity:void 0,currency:"EGP",specs:"",location:""}}),[t,i]=F.useState(null),[o,m]=F.useState([]),[s,c]=F.useState(!1),[u,_]=F.useState(!1),[d,g]=F.useState(!1),[U,G]=F.useState(null),E=F.useMemo(()=>o.reduce((r,l)=>r+(Number.isFinite(l.total)?Number(l.total):0),0),[o]),Y=async r=>{_(!0),G(null);try{const l=await R.estimateWithAI(r);i(l);const C=(l.breakdown||[]).map(x=>({category:String(x.category||"materials"),name:String(x.name||"Line"),qty:Number(x.qty??1),unit:String(x.unit||r.unit),unit_price:Number(x.unit_price??0),total:Number(x.total??0)}));m(C),a({title:"AI estimate ready",description:`Unit rate: ${(l.unit_rate??0).toFixed(2)} ${l.currency}`})}catch(l){a({title:"Failed to generate estimate",description:(l==null?void 0:l.message)??"Unknown error"})}finally{_(!1)}},K=async()=>{if(t){g(!0);try{const r=n.getValues(),l=await R.saveEstimateFromResult(r,{...t,unit_rate:E>0?E:t.unit_rate});G(l),a({title:"Estimate saved",description:"Your estimate was saved as a draft."})}catch(r){a({title:"Failed to save",description:(r==null?void 0:r.message)??"Unknown error"})}finally{g(!1)}}},X=()=>{if(!t)return;const r=t.currency,l=new xe;l.setFontSize(14),l.text("AI Rate Estimate",14,16),l.setFontSize(10),l.text(`Item: ${n.getValues().item_name}  |  Unit: ${n.getValues().unit}`,14,24);const C=(E>0?E:t.unit_rate).toFixed(2);l.text(`Unit Rate: ${C} ${r}/${n.getValues().unit}`,14,30),l.text(`Confidence: ${Math.round((t.confidence??0)*100)}%`,14,36),l.text(`Rationale: ${t.rationale}`,14,44,{maxWidth:180});let x=56;l.text("Breakdown:",14,x),x+=6,o.forEach(T=>{const Z=`${T.category} | ${T.name} | ${T.qty} ${T.unit} x ${T.unit_price.toFixed(2)} = ${Number(T.total??0).toFixed(2)} ${r}`;l.text(Z,14,x,{maxWidth:180}),x+=6,x>280&&(l.addPage(),x=16)}),l.save("rate-estimate.pdf")},J=()=>{if(!t)return;const r=o.map(x=>({Category:x.category,Name:x.name,Qty:x.qty,Unit:x.unit,UnitPrice:x.unit_price,Total:x.total})),l=B.json_to_sheet(r),C=B.book_new();B.book_append_sheet(C,l,"Breakdown"),ue(C,"rate-estimate.xlsx")};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(Q,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(Y),className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(h,{control:n.control,name:"trade_id",render:({field:r})=>e.jsxs(j,{children:[e.jsx(p,{children:"Trade"}),e.jsxs(L,{onValueChange:r.onChange,value:r.value,children:[e.jsx(f,{children:e.jsx($,{children:e.jsx(V,{placeholder:"Select trade (optional)"})})}),e.jsx(M,{})]})]})}),e.jsx(h,{control:n.control,name:"item_name",render:({field:r})=>e.jsxs(j,{children:[e.jsx(p,{children:"Item name"}),e.jsx(f,{children:e.jsx(y,{placeholder:"e.g., 20mm plaster on walls",...r})})]})}),e.jsx(h,{control:n.control,name:"unit",render:({field:r})=>e.jsxs(j,{children:[e.jsx(p,{children:"Unit"}),e.jsx(f,{children:e.jsx(y,{placeholder:"e.g., m²",...r})})]})}),e.jsx(h,{control:n.control,name:"specs",render:({field:r})=>e.jsxs(j,{children:[e.jsx(p,{children:"Specifications"}),e.jsx(f,{children:e.jsx(y,{placeholder:"e.g., 20mm thickness, cement-sand 1:4",...r})})]})}),e.jsx(h,{control:n.control,name:"location",render:({field:r})=>e.jsxs(j,{children:[e.jsx(p,{children:"Location"}),e.jsx(f,{children:e.jsx(y,{placeholder:"e.g., Cairo",...r})})]})}),e.jsx(h,{control:n.control,name:"quantity",render:({field:r})=>e.jsxs(j,{children:[e.jsx(p,{children:"Quantity"}),e.jsx(f,{children:e.jsx(y,{type:"number",step:"0.01",placeholder:"e.g., 1500",value:r.value??"",onChange:r.onChange})})]})}),e.jsx(h,{control:n.control,name:"currency",render:({field:r})=>e.jsxs(j,{children:[e.jsx(p,{children:"Currency"}),e.jsxs(L,{onValueChange:r.onChange,value:r.value,children:[e.jsx(f,{children:e.jsx($,{children:e.jsx(V,{placeholder:"Select currency"})})}),e.jsxs(M,{children:[e.jsx(A,{value:"EGP",children:"EGP"}),e.jsx(A,{value:"USD",children:"USD"}),e.jsx(A,{value:"EUR",children:"EUR"})]})]})]})}),e.jsx("div",{className:"md:col-span-3 flex justify-end gap-2",children:e.jsx(S,{type:"submit",disabled:u,children:u?"Generating…":"Generate with AI"})})]})}),t&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(je,{itemName:n.getValues().item_name,unit:n.getValues().unit,currency:t.currency,unitRate:E>0?E:t.unit_rate,confidence:t.confidence,rationale:t.rationale,contextSize:t.context_size,generatedAt:t.generated_at,onShowContext:()=>c(!0)}),e.jsx(pe,{items:o,currency:t.currency,onChange:m}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(S,{variant:"secondary",onClick:K,disabled:d,children:d?"Saving…":U?"Saved":"Save Estimate"}),e.jsx(S,{variant:"outline",onClick:X,disabled:!t,children:"Export PDF"}),e.jsx(S,{variant:"outline",onClick:J,disabled:!t,children:"Export Excel"})]}),e.jsx(fe,{onSubmit:async(r,l)=>{if(!U){a({title:"Save required",description:"Please save the estimate before submitting feedback."});return}try{await R.submitFeedback(U,r,l),a({title:"Feedback recorded",description:"Thank you!"})}catch(C){a({title:"Failed to submit feedback",description:(C==null?void 0:C.message)??"Unknown error"})}}})]}),e.jsx(ge,{items:t.top_context??[],open:s,onOpenChange:c})]})]})}export{Ie as RateEstimator,Ie as default};
