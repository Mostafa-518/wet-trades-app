import{q as be,j as e,B as D,r as S,X as pe,I as $,d as ve,e as _,f as E,h as I,C as V,a as ce,b as le,c as Y,T as Se,g as Ne,u as ye,L as k,S as Z,E as Ce,v as we,w as Ie,i as R,m as q,x as ee,y as Te,s as De,A as Pe,P as ke,k as $e,l as Ee,n as Fe}from"./index-JTitMy_e.js";import{S as Ae,f as te,R as Re,T as Me}from"./SubcontractEditModal-DrLTCF3q.js";import{F as ue}from"./file-spreadsheet-D4ZRvVr1.js";import{P as re}from"./plus-CKDFBIWZ.js";import{S as W,a as H,b as G,c as X,d as K}from"./select-EDNpX1DE.js";import{u as J}from"./useSubcontractHelpers-_CtRnaiw.js";import{S as oe}from"./search-CqTd2JrO.js";import{T as ne}from"./TableSelectionCheckbox-Cvi7sFuG.js";import{E as Le}from"./eye-B8Nu4Qtu.js";import{S as Ve}from"./square-pen-Bd2_bRmk.js";import{T as Ye}from"./trash-2-oXBX782K.js";import{f as qe,a as Oe,b as ae,c as Be,u as Ue}from"./useSubcontractFiltering-CAaiPO8K.js";import{u as ze,P as Qe}from"./PaginationControls-dUi51FeN.js";import{S as se}from"./switch-BKbWaZU7.js";import{I as _e}from"./ImportPreviewDialog-CrcHT2kb.js";import{u as Q,r as We,w as He}from"./xlsx-CKN5doRT.js";import{D as he,a as fe,b as ge,c as xe}from"./dialog-CsQAdg_b.js";import{U as Ge}from"./upload-6aSbdGye.js";import"./tabs-NvA1y9Cg.js";import"./textarea-B2U0QJQu.js";import"./index-BpvnzYIK.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=be("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);function Ke({onCreateNew:a,onFileUpload:t,onDownloadTemplate:s}){return e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Subcontracts"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(D,{variant:"outline",onClick:s,className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4"}),"Download Template"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:t,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",id:"excel-upload"}),e.jsxs(D,{variant:"outline",className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4"}),"Import from Excel"]})]}),a&&e.jsxs(D,{onClick:a,className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4"}),"New Subcontract"]})]})]})}function Je({onSearch:a,subcontracts:t}){const[s,n]=S.useState("contractId"),[o,l]=S.useState(""),[i,r]=S.useState([]),{getProjectName:c,getProjectCode:u,getSubcontractorName:m}=J(),v=[{value:"contractId",label:"Contract ID"},{value:"project",label:"Project Name"},{value:"projectCode",label:"Project Code"},{value:"subcontractor",label:"Subcontractor"},{value:"trade",label:"Trade"},{value:"item",label:"Trade Item"},{value:"status",label:"Status"}],x=S.useMemo(()=>{const f=new Set;return t.forEach(g=>{switch(s){case"contractId":g.contractId&&f.add(g.contractId);break;case"project":const y=c(g.project);y&&f.add(y);break;case"projectCode":const d=u(g.project);d&&f.add(d);break;case"subcontractor":const b=m(g.subcontractor);b&&f.add(b);break;case"trade":g.tradeItems&&g.tradeItems.length>0&&g.tradeItems.forEach(T=>{T.trade&&f.add(T.trade)});break;case"item":g.tradeItems&&g.tradeItems.length>0&&g.tradeItems.forEach(T=>{T.item&&f.add(T.item)});break;case"status":g.status&&f.add(g.status);break}}),Array.from(f).sort()},[s,t,c,u,m]),p=()=>{if(o.trim()){const f=[...i,{field:s,value:o.trim()}];r(f),l(""),a(f)}},h=f=>{const g=i.filter((y,d)=>d!==f);r(g),a(g)},j=()=>{r([]),l(""),a([])},C=f=>{n(f),l("")};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Search Field"}),e.jsxs(W,{value:s,onValueChange:C,children:[e.jsx(H,{children:e.jsx(G,{})}),e.jsx(X,{children:v.map(f=>e.jsx(K,{value:f.value,children:f.label},f.value))})]})]}),e.jsxs("div",{className:"flex-2",children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Value"}),e.jsxs(W,{value:o,onValueChange:l,children:[e.jsx(H,{children:e.jsx(G,{placeholder:"Select or type a value..."})}),e.jsx(X,{children:x.map(f=>e.jsx(K,{value:f,children:f},f))})]})]}),e.jsx(D,{onClick:p,disabled:!o.trim(),children:"Add Condition"})]}),i.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("strong",{className:"text-sm",children:"Active Search Conditions:"}),e.jsx(D,{variant:"outline",size:"sm",onClick:j,children:"Clear All"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:i.map((f,g)=>{var y;return e.jsxs("div",{className:"inline-flex items-center gap-1 bg-blue-100 text-blue-800 rounded-full px-3 py-1 text-sm",children:[e.jsxs("span",{className:"font-medium",children:[(y=v.find(d=>d.value===f.field))==null?void 0:y.label,":"]}),e.jsx("span",{children:f.value}),e.jsx("button",{onClick:()=>h(g),className:"ml-1 hover:bg-blue-200 rounded-full p-0.5",children:e.jsx(pe,{className:"h-3 w-3"})})]},g)})})]})]})}function Ze({searchTerm:a,onSimpleSearch:t,onAdvancedSearch:s,subcontracts:n}){const[o,l]=S.useState(!1);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("div",{className:"relative max-w-md flex-1",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx($,{placeholder:"Search by Contract ID, Project, Project Code, Trade, Item, or Subcontractor...",value:a,onChange:i=>t(i.target.value),className:"pl-10"})]}),e.jsx(D,{variant:"outline",onClick:()=>l(!o),children:"Advanced Search"})]}),o&&e.jsx(Je,{onSearch:s,subcontracts:n})]})}function et({allSelected:a,onToggleAll:t}){return e.jsx(ve,{children:e.jsxs(_,{children:[e.jsx(E,{children:e.jsx(ne,{checked:a,onCheckedChange:t,ariaLabel:"Select all subcontracts"})}),e.jsx(E,{children:"Contract ID"}),e.jsx(E,{children:"Date of Issuing"}),e.jsx(E,{children:"Project Name"}),e.jsx(E,{children:"Subcontractor Company"}),e.jsx(E,{children:"Trades"}),e.jsx(E,{children:"Items"}),e.jsx(E,{children:"QTY"}),e.jsx(E,{children:"Rate"}),e.jsx(E,{children:"Total Amount"}),e.jsx(E,{children:"Responsibilities"}),e.jsx(E,{children:"Actions"})]})})}function me({contractId:a,onView:t,onEdit:s,onDelete:n}){return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>t(a),children:e.jsx(Le,{className:"h-4 w-4"})}),e.jsx(D,{variant:"ghost",size:"sm",onClick:s,children:e.jsx(Ve,{className:"h-4 w-4"})}),e.jsx(D,{variant:"ghost",size:"sm",onClick:n,children:e.jsx(Ye,{className:"h-4 w-4"})})]})}const tt=S.memo(function({contract:t,isSelected:s,getProjectName:n,getSubcontractorName:o,onToggleOne:l,onViewDetail:i,onEdit:r,onDelete:c}){const u=S.useMemo(()=>n(t.project),[n,t.project]),m=S.useMemo(()=>o(t.subcontractor),[o,t.subcontractor]),v=S.useMemo(()=>qe(t.dateOfIssuing),[t.dateOfIssuing]),x=S.useMemo(()=>Oe(t.responsibilities),[t.responsibilities]),p=S.useMemo(()=>ae(t.totalValue??0),[t.totalValue]),h=S.useCallback(()=>l(t.id),[l,t.id]),j=S.useCallback(()=>i(t.id),[i,t.id]),C=S.useCallback(()=>r(t),[r,t]),f=S.useCallback(async()=>{try{await c(t.id)}catch{}},[c,t.id]);return t.tradeItems&&t.tradeItems.length>0?e.jsx(e.Fragment,{children:t.tradeItems.map((g,y)=>e.jsxs(_,{className:"cursor-pointer hover:bg-muted/50",onClick:j,children:[y===0&&e.jsxs(e.Fragment,{children:[e.jsx(I,{rowSpan:t.tradeItems.length,onClick:d=>d.stopPropagation(),children:e.jsx(ne,{checked:s,onCheckedChange:h,ariaLabel:`Select contract ${t.contractId}`})}),e.jsx(I,{rowSpan:t.tradeItems.length,className:"font-medium text-blue-600",children:t.contractId}),e.jsx(I,{rowSpan:t.tradeItems.length,children:v}),e.jsx(I,{rowSpan:t.tradeItems.length,children:u}),e.jsx(I,{rowSpan:t.tradeItems.length,children:m})]}),e.jsx(I,{children:g.trade||"-"}),e.jsx(I,{children:g.item||"-"}),e.jsxs(I,{className:"text-right",children:[g.quantity??"-"," ",g.unit||""]}),e.jsx(I,{className:"text-right",children:ae(g.unitPrice??0)}),e.jsx(I,{className:"text-right font-medium",children:ae(Be(g.quantity??0,g.unitPrice??0))}),y===0&&e.jsxs(e.Fragment,{children:[e.jsx(I,{rowSpan:t.tradeItems.length,children:x}),e.jsx(I,{rowSpan:t.tradeItems.length,onClick:d=>d.stopPropagation(),children:e.jsx(me,{contractId:t.id,onView:j,onEdit:C,onDelete:f})})]})]},`${t.id}-${g.id}`))}):e.jsxs(_,{className:"cursor-pointer hover:bg-muted/50",onClick:j,children:[e.jsx(I,{onClick:g=>g.stopPropagation(),children:e.jsx(ne,{checked:s,onCheckedChange:h,ariaLabel:`Select contract ${t.contractId}`})}),e.jsx(I,{className:"font-medium text-blue-600",children:t.contractId}),e.jsx(I,{children:v}),e.jsx(I,{children:u}),e.jsx(I,{children:m}),e.jsx(I,{className:"text-muted-foreground",children:"-"}),e.jsx(I,{className:"text-muted-foreground",children:"-"}),e.jsx(I,{className:"text-muted-foreground",children:"-"}),e.jsx(I,{className:"text-muted-foreground",children:"-"}),e.jsx(I,{className:"text-right font-medium",children:p}),e.jsx(I,{children:x}),e.jsx(I,{onClick:g=>g.stopPropagation(),children:e.jsx(me,{contractId:t.id,onView:j,onEdit:C,onDelete:f})})]},t.id)});function at({searchTerm:a,showAdvancedSearch:t}){return e.jsx(_,{children:e.jsx(I,{colSpan:12,className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:a||t?"No subcontracts found matching your search.":"No subcontracts found."})})})}function st({filteredData:a,selectedIds:t,searchTerm:s,showAdvancedSearch:n,allSelected:o,getProjectName:l,getSubcontractorName:i,onToggleAll:r,onToggleOne:c,onViewDetail:u,onEdit:m,onDelete:v,onBulkDelete:x}){const{currentPage:p,totalPages:h,paginatedData:j,goToPage:C,hasNextPage:f,hasPreviousPage:g,totalItems:y,itemsPerPage:d}=ze({data:a,itemsPerPage:5});return e.jsxs(V,{children:[e.jsx(ce,{children:e.jsxs(le,{children:["Subcontracts (",a.length,")"]})}),e.jsxs(Y,{className:"space-y-4",children:[e.jsx(Qe,{currentPage:p,totalPages:h,onPageChange:C,hasNextPage:f,hasPreviousPage:g,totalItems:y,itemsPerPage:d}),t.size>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2",children:[e.jsxs("span",{className:"font-medium",children:[t.size," selected"]}),e.jsx(D,{variant:"destructive",size:"sm",onClick:x,className:"ml-2",children:"Delete Selected"})]}),e.jsx("div",{className:"border rounded-lg overflow-auto",children:e.jsxs(Se,{children:[e.jsx(et,{allSelected:o,onToggleAll:r}),e.jsx(Ne,{children:j.length===0?e.jsx(at,{searchTerm:s,showAdvancedSearch:n}):j.map(b=>e.jsx(tt,{contract:b,isSelected:t.has(b.id),getProjectName:l,getSubcontractorName:i,onToggleOne:c,onViewDetail:u,onEdit:m,onDelete:v},b.id))})]})})]})]})}function rt({filteredData:a}){const{formValues:t,getSwitchProps:s}=ye({showCurrency:!0,compactView:!1},{customKey:"subcontract-summary-settings"}),n=i=>t.showCurrency?new Intl.NumberFormat("en-US",{style:"currency",currency:"EGP",minimumFractionDigits:0}).format(i):i.toLocaleString(),o=a.reduce((i,r)=>i+r.totalValue,0),l=a.filter(i=>i.status==="active").length;return t.compactView?e.jsx(V,{className:"p-2",children:e.jsx(Y,{className:"p-2",children:e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("span",{children:[a.length," Contracts"]}),e.jsx("span",{className:"font-semibold text-green-600",children:n(o)}),e.jsxs("span",{children:[l," Active"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{...s("compactView")}),e.jsx(k,{className:"text-xs",children:"Compact"})]})]})})}):e.jsxs(V,{children:[e.jsx(ce,{children:e.jsxs(le,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Contract Summary"}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{...s("showCurrency")}),e.jsx(k,{children:"Show Currency"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{...s("compactView")}),e.jsx(k,{children:"Compact View"})]})]})]})}),e.jsx(Y,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold",children:a.length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total Contracts"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:n(o)}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total Value"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:l}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Active Contracts"})]})]})})]})}function ot({size:a="md",text:t="Loading...",className:s=""}){const n={sm:"h-4 w-4",md:"h-8 w-8",lg:"h-12 w-12"};return e.jsxs("div",{className:`flex flex-col items-center justify-center space-y-3 ${s}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:`animate-spin rounded-full border-2 border-primary border-t-transparent ${n[a]}`}),e.jsx("div",{className:`absolute inset-0 rounded-full border-2 border-muted ${n[a]}`})]}),t&&e.jsx("p",{className:"text-sm text-muted-foreground animate-pulse",children:t})]})}function nt(){return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsx(V,{className:"w-full max-w-sm",children:e.jsxs(Y,{className:"p-8",children:[e.jsx(ot,{size:"lg",text:"Processing import...",className:"py-4"}),e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsx(Z,{className:"h-2 w-full"}),e.jsx(Z,{className:"h-2 w-3/4"}),e.jsx(Z,{className:"h-2 w-1/2"})]})]})})})}function ct({tableName:a,onRetry:t}){const s=()=>{t?t():window.location.reload()};return e.jsx(V,{className:"my-4",children:e.jsxs(Y,{className:"p-8 text-center",children:[e.jsx(we,{className:"h-8 w-8 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"font-medium mb-2",children:"Table Error"}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:[a?`The ${a} table`:"This table"," failed to load. Please try refreshing."]}),e.jsxs(D,{onClick:s,variant:"outline",size:"sm",className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-4 w-4"}),"Retry"]})]})})}function lt({children:a,tableName:t,onRetry:s}){return e.jsx(Ce,{fallback:e.jsx(ct,{tableName:t,onRetry:s}),children:a})}function it(){const{getProjectName:a,getProjectCode:t,getSubcontractorName:s}=J();return{checkBasicFieldsMatch:(r,c)=>{const u=a(r.project),m=t(r.project),v=s(r.subcontractor);return r.contractId.toLowerCase().includes(c)||u.toLowerCase().includes(c)||m.toLowerCase().includes(c)||v.toLowerCase().includes(c)},checkResponsibilitiesMatch:(r,c)=>r.responsibilities&&r.responsibilities.length>0&&r.responsibilities.some(u=>u&&u.toLowerCase().includes(c)),checkTradeItemsMatch:(r,c)=>r.tradeItems&&r.tradeItems.length>0&&r.tradeItems.some(u=>{const m=u.trade&&u.trade.toLowerCase().includes(c),v=u.item&&u.item.toLowerCase().includes(c);return m||v}),evaluateAdvancedCondition:(r,c)=>{const u=a(r.project),m=t(r.project),v=s(r.subcontractor),x=c.value.toLowerCase();switch(c.field){case"contractId":return r.contractId.toLowerCase().includes(x);case"project":return u.toLowerCase().includes(x);case"projectCode":return m.toLowerCase().includes(x);case"subcontractor":return v.toLowerCase().includes(x);case"trade":return r.tradeItems&&r.tradeItems.length>0&&r.tradeItems.some(p=>p.trade&&p.trade.toLowerCase().includes(x));case"item":return r.tradeItems&&r.tradeItems.length>0&&r.tradeItems.some(p=>p.item&&p.item.toLowerCase().includes(x));case"responsibilities":return r.responsibilities&&r.responsibilities.length>0&&r.responsibilities.some(p=>p&&p.toLowerCase().includes(x));case"status":return r.status.toLowerCase().includes(x);default:return!1}}}}function dt(){return{filterTradeItems:(s,n,o,l)=>{if(!s.tradeItems||s.tradeItems.length===0)return s;let i=s.tradeItems;return(o||l)&&(i=s.tradeItems.filter(r=>o?r.trade&&r.trade.toLowerCase().includes(n):l?r.item&&r.item.toLowerCase().includes(n):!1)),{...s,tradeItems:i}},filterTradeItemsForAdvancedSearch:(s,n,o,l,i)=>{let r=s.tradeItems||[];return n&&o?r=r.filter(c=>{const u=c.trade&&c.trade.toLowerCase().includes(l),m=c.item&&c.item.toLowerCase().includes(i);return u&&m}):n?r=r.filter(c=>c.trade&&c.trade.toLowerCase().includes(l)):o&&(r=r.filter(c=>c.item&&c.item.toLowerCase().includes(i))),{...s,tradeItems:r}}}}function ut(a){const[t,s]=S.useState(""),[n,o]=S.useState(a),[l,i]=S.useState([]),{checkBasicFieldsMatch:r,checkResponsibilitiesMatch:c,checkTradeItemsMatch:u,evaluateAdvancedCondition:m}=it(),{filterTradeItems:v,filterTradeItemsForAdvancedSearch:x}=dt();S.useEffect(()=>{l.length>0?h(l):t.trim()?p(t):o(a)},[a]);const p=j=>{if(s(j),i([]),!j.trim()){o(a);return}const C=j.toLowerCase(),f=a.map(g=>{const y=r(g,C),d=u(g,C),b=c(g,C);return y||b?g:d?v(g,C,!0,!0):null}).filter(Boolean);o(f)},h=j=>{if(i(j),s(""),j.length===0){o(a);return}const C=a.map(f=>{let g=!1,y=!1,d="",b="";return j.every(P=>{switch(P.field){case"trade":return g=!0,d=P.value.toLowerCase(),m(f,P);case"item":return y=!0,b=P.value.toLowerCase(),m(f,P);default:return m(f,P)}})?g||y?x(f,g,y,d,b):f:null}).filter(Boolean);o(C)};return{searchTerm:t,filteredData:n,handleSimpleSearch:p,handleAdvancedSearch:h}}function mt(a,t){const[s,n]=S.useState(new Set),o=a.length>0&&a.every(c=>s.has(c.id));return{selectedIds:s,allSelected:o,toggleAll:()=>{n(o?new Set:new Set(a.map(c=>c.id)))},toggleOne:c=>{n(u=>{const m=new Set(u);return m.has(c)?m.delete(c):m.add(c),m})},handleBulkDelete:async()=>{try{await t(Array.from(s)),n(new Set)}catch{}}}}function pt(a){const[t,s]=S.useState(null),[n,o]=S.useState(!1);return{editingSubcontract:t,showAdvancedSearch:n,handleEdit:r=>{s(r)},handleSaveEdit:async(r,c)=>{await a(r,c),s(null)},setEditingSubcontract:s,setShowAdvancedSearch:o}}function ht(a){const{subcontracts:t,updateSubcontract:s,deleteSubcontract:n,deleteManySubcontracts:o,isLoading:l}=R(),{getProjectName:i,getProjectCode:r,getSubcontractorName:c}=J(),u=Ue(t,a),{searchTerm:m,filteredData:v,handleSimpleSearch:x,handleAdvancedSearch:p}=ut(u),{selectedIds:h,allSelected:j,toggleAll:C,toggleOne:f,handleBulkDelete:g}=mt(v,o),{editingSubcontract:y,showAdvancedSearch:d,handleEdit:b,handleSaveEdit:T,setEditingSubcontract:P,setShowAdvancedSearch:F}=pt(s);return S.useMemo(()=>({subcontracts:u,filteredData:v,searchTerm:m,showAdvancedSearch:d,editingSubcontract:y,selectedIds:h,allSelected:j,isLoading:l,getProjectName:i,getProjectCode:r,getSubcontractorName:c,handleSimpleSearch:x,handleAdvancedSearch:p,handleEdit:b,handleSaveEdit:T,toggleAll:C,toggleOne:f,handleBulkDelete:g,deleteSubcontract:n,setEditingSubcontract:P,setShowAdvancedSearch:F}),[u,v,m,d,y,h,j,l,i,r,c,x,p,b,T,C,f,g,n,P,F])}const ft=async a=>{console.log("Starting to parse Excel file:",a.name,a.size);try{const t=await a.arrayBuffer(),s=We(t,{type:"array"});if(!s.SheetNames||s.SheetNames.length===0)throw new Error("No worksheets found in the Excel file");const n=s.SheetNames[0],o=s.Sheets[n];console.log("Raw worksheet:",o);const l=Q.sheet_to_json(o,{header:1,defval:"",raw:!1});if(console.log("Raw data as arrays:",l),!l||l.length===0)throw new Error("No data found in the Excel file");return l}catch(t){throw console.error("Error parsing Excel file:",t),new Error(`Failed to parse Excel file: ${t instanceof Error?t.message:"Unknown error"}`)}},gt=a=>(console.log("Validating Excel file:",a.name,a.type,a.size),[".xlsx",".xls"].some(n=>a.name.toLowerCase().endsWith(n))?a.size>10*1024*1024?"Please upload a file smaller than 10MB":a.size===0?"The uploaded file is empty":null:"Please upload an Excel file (.xlsx or .xls)"),xt=a=>{try{const t=Q.json_to_sheet(a),s=Q.book_new();return Q.book_append_sheet(s,t,"Subcontracts"),s}catch(t){throw console.error("Error creating Excel template:",t),new Error("Failed to create Excel template")}},jt=a=>(console.log("Mapping raw data rows:",a),a.filter(t=>{const s=t&&t.length>0&&t.some(n=>n&&String(n).trim());return console.log("Row has data:",s,t),s}).map((t,s)=>{console.log(`Processing row ${s+1}:`,t);const n={};return n["Date of Issuing"]=t[0]?String(t[0]).trim():"",n["Project Name"]=t[1]?String(t[1]).trim():"",n["Subcontractor Company"]=t[2]?String(t[2]).trim():"",n["Type of contract"]=t[3]?String(t[3]).trim():"",n.Trades=t[4]?String(t[4]).trim():"",n.Items=t[5]?String(t[5]).trim():"",n.QTY=t[6]?isNaN(Number(t[6]))?0:Number(t[6]):0,n.Rate=t[7]?isNaN(Number(t[7]))?0:Number(t[7]):0,n.wastage=t[8]?isNaN(Number(t[8]))?0:Number(t[8]):0,n.Responsibilities=t[9]?String(t[9]).trim():"",console.log(`Mapped row ${s+1}:`,n),n})),bt=a=>{console.log("Processing merged cells for data:",a);const t=[];let s={"Date of Issuing":"","Project Name":"","Subcontractor Company":"","Type of contract":""};for(let n=0;n<a.length;n++){const o=a[n];console.log(`Processing merged cells for row ${n+1}:`,o);const l={"Date of Issuing":o["Date of Issuing"]||s["Date of Issuing"],"Project Name":o["Project Name"]||s["Project Name"],"Subcontractor Company":o["Subcontractor Company"]||s["Subcontractor Company"],"Type of contract":o["Type of contract"]||s["Type of contract"],Trades:o.Trades||"",Items:o.Items||"",QTY:o.QTY||0,Rate:o.Rate||0,wastage:o.wastage||0,Responsibilities:o.Responsibilities||""};o["Date of Issuing"]&&(s["Date of Issuing"]=o["Date of Issuing"]),o["Project Name"]&&(s["Project Name"]=o["Project Name"]),o["Subcontractor Company"]&&(s["Subcontractor Company"]=o["Subcontractor Company"]),o["Type of contract"]&&(s["Type of contract"]=o["Type of contract"]),l.Trades||l.Items||l["Project Name"]?(t.push(l),console.log(`Added processed row ${n+1}:`,l)):console.log(`Skipped empty row ${n+1}`)}return console.log("Final processed data:",t),t},vt=a=>{const t={};return a.forEach((s,n)=>{console.log(`Grouping row ${n+1}:`,s);const o=`${s["Date of Issuing"]}_${s["Project Name"]}_${s["Subcontractor Company"]}_${s["Type of contract"]}`;t[o]||(t[o]=[]),t[o].push(s)}),console.log("Grouped contracts:",t),t},St=(a,t)=>{const s=[];console.log(`Validating row ${t}:`,a),(a["Project Name"]||a["Subcontractor Company"]||a["Type of contract"])&&((!a["Project Name"]||!a["Project Name"].trim())&&s.push("Project Name is required"),(!a["Subcontractor Company"]||!a["Subcontractor Company"].trim())&&s.push("Subcontractor Company is required"),(!a["Type of contract"]||!a["Type of contract"].trim())&&s.push("Type of contract is required")),(a.Trades||a.Items||a.QTY||a.Rate)&&((!a.Trades||!a.Trades.trim())&&s.push("Trades is required when trade data is present"),(!a.Items||!a.Items.trim())&&s.push("Items is required when trade data is present"));const l=a.QTY;if(l!=null&&String(l).trim()!==""){const c=Number(l);isNaN(c)?s.push(`QTY must be a valid number, got: "${l}"`):c<0&&s.push("QTY must be a non-negative number")}const i=a.Rate;if(i!=null&&String(i).trim()!==""){const c=Number(i);isNaN(c)?s.push(`Rate must be a valid number, got: "${i}"`):c<0&&s.push("Rate must be a non-negative number")}const r=a.wastage;if(r!=null&&String(r).trim()!==""){const c=Number(r);isNaN(c)?s.push(`Wastage must be a valid number, got: "${r}"`):(c<0||c>100)&&s.push("Wastage must be a number between 0 and 100")}if(a["Date of Issuing"]&&a["Date of Issuing"].trim()){const c=a["Date of Issuing"].trim(),u=[c,c.replace(/\//g,"-"),c.replace(/\./g,"-"),c.replace(/\s+/g,"-")];let m=!1;for(const v of u){const x=new Date(v);if(!isNaN(x.getTime())&&x.getFullYear()>1900){m=!0;break}}m||s.push(`Date of Issuing must be a valid date, got: "${c}". Try formats like YYYY-MM-DD, MM/DD/YYYY, or DD.MM.YYYY`)}if(a["Type of contract"]&&a["Type of contract"].trim()){const c=a["Type of contract"].trim().toLowerCase(),u=["subcontract","add","addendum"];u.includes(c)||s.push(`Type of contract must be one of: ${u.join(", ")}, got: "${a["Type of contract"]}"`)}return s.length>0&&console.log(`Validation errors for row ${t}:`,s),s},Nt=a=>{const t=[];if(console.log("Validating contract data:",a),(!a["Project Name"]||!a["Project Name"].trim())&&t.push("Project Name is required"),(!a["Subcontractor Company"]||!a["Subcontractor Company"].trim())&&t.push("Subcontractor Company is required"),(!a["Type of contract"]||!a["Type of contract"].trim())&&t.push("Type of contract is required"),a["Date of Issuing"]&&a["Date of Issuing"].trim()){const s=a["Date of Issuing"].trim(),n=[s,s.replace(/\//g,"-"),s.replace(/\./g,"-"),s.replace(/\s+/g,"-")];let o=!1;for(const l of n){const i=new Date(l);if(!isNaN(i.getTime())&&i.getFullYear()>1900){o=!0;break}}o||t.push(`Invalid date format: "${s}". Please use YYYY-MM-DD, MM/DD/YYYY, or DD.MM.YYYY`)}if(a["Type of contract"]&&a["Type of contract"].trim()){const s=a["Type of contract"].trim().toLowerCase(),n=["subcontract","add","addendum"];n.includes(s)||t.push(`Invalid contract type: "${a["Type of contract"]}". Must be one of: ${n.join(", ")}`)}return t.length>0&&console.log("Contract validation errors:",t),t},yt=async(a,t,s,n,o)=>{let l=0,i=0;const r=[],c=new Set;console.log("Starting import process with data:",a),console.log("Available projects:",s.map(m=>({id:m.id,name:m.name,code:m.code}))),console.log("Available subcontractors:",n.map(m=>({id:m.id,name:m.companyName})));const u=vt(a);console.log("Contract groups:",Object.keys(u));for(const[m,v]of Object.entries(u))try{console.log(`Processing contract group: ${m}`);const x=v[0];console.log("Contract row:",x);const p=Nt(x);if(p.length>0){i++,r.push(`Contract "${m}": ${p.join(", ")}`),console.error(`Contract validation failed for ${m}:`,p);continue}const h=x["Project Name"].trim(),j=s.find(N=>N.name&&N.name.toLowerCase().trim()===h.toLowerCase());if(!j){i++;const N=s.map(w=>w.name).join(", ");r.push(`Contract "${m}": Project "${h}" not found. Available projects: ${N}`),console.error(`Project not found: "${h}". Available:`,s.map(w=>w.name));continue}if(!j.code){i++,r.push(`Contract "${m}": Project "${h}" doesn't have a project code required for contract ID generation`),console.error(`Project "${h}" missing code:`,j);continue}const C=x["Subcontractor Company"].trim(),f=n.find(N=>N.companyName&&N.companyName.toLowerCase().trim()===C.toLowerCase());if(!f){i++;const N=n.map(w=>w.companyName).join(", ");r.push(`Contract "${m}": Subcontractor "${C}" not found. Available subcontractors: ${N}`),console.error(`Subcontractor not found: "${C}". Available:`,n.map(w=>w.companyName));continue}console.log(`Found project: ${j.name} (ID: ${j.id}, Code: ${j.code})`),console.log(`Found subcontractor: ${f.companyName} (ID: ${f.id})`);const g=[];let y=!1;const d=[];for(let N=0;N<v.length;N++){const w=v[N];if(console.log(`Processing trade item row ${N+1}:`,w),!w.Trades&&!w.Items&&!w.QTY&&!w.Rate){console.log(`Skipping row ${N+1} - no trade data`);continue}const M=St(w,N+1);if(M.length>0){d.push(`Row ${N+1}: ${M.join(", ")}`),console.error(`Row validation failed for row ${N+1}:`,M);continue}const A=Number(w.QTY)||1,ie=Number(w.Rate)||0,je=Number(w.wastage)||0,de={id:`imported-${Date.now()}-${N}-${Math.random().toString(36).substr(2,9)}`,trade:w.Trades.trim(),item:w.Items.trim(),unit:"unit",quantity:A,unitPrice:ie,total:A*ie,wastagePercentage:je};console.log("Created trade item:",de),g.push(de),y=!0}if(!y){i++;const N=d.length>0?`No valid trade items found. Errors: ${d.join("; ")}`:"No valid trade items found";r.push(`Contract "${m}": ${N}`),console.error(`No valid trade items for contract ${m}. Row errors:`,d);continue}const b=g.reduce((N,w)=>N+w.total,0);console.log(`Total contract value: ${b}`);const T=x.Responsibilities?x.Responsibilities.split(",").map(N=>N.trim()).filter(N=>N.length>0):[];let P=new Date().toISOString().split("T")[0];if(x["Date of Issuing"]&&x["Date of Issuing"].trim()){const N=x["Date of Issuing"].trim(),w=[N,N.replace(/\//g,"-"),N.replace(/\./g,"-"),N.replace(/\s+/g,"-")];for(const M of w){const A=new Date(M);if(!isNaN(A.getTime())&&A.getFullYear()>1900){P=A.toISOString().split("T")[0];break}}}let F="subcontract";if(x["Type of contract"]){const N=x["Type of contract"].trim().toLowerCase();(N==="add"||N==="addendum")&&(F="ADD")}let U=0,O="";const B=100;do{if(U++,U>B)throw new Error(`Failed to generate unique contract ID after ${B} attempts`);O=`TEMP-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}while(c.has(O));c.add(O);const z={project:j.id,subcontractor:f.id,tradeItems:g,responsibilities:T,totalValue:b,status:"draft",startDate:new Date().toISOString().split("T")[0],endDate:new Date(Date.now()+30*24*60*60*1e3).toISOString().split("T")[0],dateOfIssuing:P,description:`Imported ${F==="ADD"?"addendum":"subcontract"} for ${j.name} with ${f.companyName}`,contractType:F,parentSubcontractId:void 0};console.log("Final subcontract data:",z);const L=await t(z);L&&L.contractId&&(c.add(L.contractId),console.log(`Successfully imported contract: ${m} with ID: ${L.contractId}`)),l++}catch(x){i++;const p=x instanceof Error?x.message:"Unknown error";r.push(`Contract "${m}": ${p}`),console.error(`Error importing contract ${m}:`,x)}if(console.log(`Import completed: ${l} success, ${i} errors`),console.log("All errors:",r),l>0&&o({title:"Import completed",description:`Successfully imported ${l} subcontract(s)${i>0?`, ${i} failed`:""}`}),r.length>0){console.error("Import errors:",r);const m=r.slice(0,3).join(`
`),v=r.length>3?`
...and ${r.length-3} more errors`:"";o({title:"Import errors",description:`${i} contracts failed to import:
${m}${v}

Check console for full details.`,variant:"destructive"})}};function Ct(){const[a,t]=S.useState(!1),[s,n]=S.useState([]),[o,l]=S.useState(!1),{toast:i}=q(),{addSubcontract:r,projects:c,subcontractors:u}=R();return{isImporting:a,importData:s,showPreview:o,setShowPreview:l,handleFileUpload:async p=>{var C;const h=(C=p.target.files)==null?void 0:C[0];if(!h){console.log("No file selected");return}console.log("File selected for upload:",h.name,h.size,h.type);const j=gt(h);if(j){console.error("File validation failed:",j),i({title:"Invalid file",description:j,variant:"destructive"});return}try{t(!0),console.log("Starting import process...");const f=await ft(h);if(console.log("Parsed raw data:",f),!f||f.length<=1){console.warn("No data found in file"),i({title:"No data found",description:"The Excel file appears to be empty or contains only headers.",variant:"destructive"});return}const g=f.slice(1);console.log("Data rows after skipping header:",g);const y=jt(g);if(console.log("Mapped data:",y),y.length===0){console.warn("No valid rows found after mapping"),i({title:"No valid data",description:"No valid rows found in the Excel file.",variant:"destructive"});return}const d=bt(y);if(console.log("Processed data with merged cells:",d),d.length===0){console.warn("No valid data after processing merged cells"),i({title:"No valid data",description:"No valid subcontract data found in the file after processing.",variant:"destructive"});return}console.log("Setting import data and showing preview"),n(d),l(!0),i({title:"File processed",description:`Found ${d.length} records ready for import.`})}catch(f){console.error("Error parsing Excel file:",f);const g=f instanceof Error?f.message:"Unknown error occurred";i({title:"Import failed",description:`Failed to parse Excel file: ${g}`,variant:"destructive"})}finally{t(!1),p.target.value=""}},processImport:async p=>{console.log("Starting import process with data:",p),t(!0),l(!1);try{ee(),await yt(p,r,c,u,i),console.log("Import process completed successfully"),ee()}catch(h){console.error("Import processing error:",h);const j=h instanceof Error?h.message:"Unknown error occurred";i({title:"Import failed",description:`An error occurred while processing the import: ${j}`,variant:"destructive"}),ee()}finally{t(!1)}},downloadTemplate:()=>{console.log("Downloading template...");try{const h=xt([{"Date of Issuing":"2024-01-15","Project Name":"Sample Project","Subcontractor Company":"Sample Company","Type of contract":"subcontract",Trades:"Masonry",Items:"Brick Work",QTY:100,Rate:50,wastage:5,Responsibilities:"Material supply, Labor"}]);He(h,"subcontract_import_template.xlsx"),i({title:"Template downloaded",description:"Excel template has been downloaded successfully."})}catch(p){console.error("Error downloading template:",p),i({title:"Download failed",description:"Failed to download template file.",variant:"destructive"})}}}}const wt=S.memo(function({onCreateNew:t,onViewDetail:s,reportFilters:n}){const{subcontracts:o,filteredData:l,searchTerm:i,showAdvancedSearch:r,editingSubcontract:c,selectedIds:u,allSelected:m,isLoading:v,getProjectName:x,getProjectCode:p,getSubcontractorName:h,handleSimpleSearch:j,handleAdvancedSearch:C,handleEdit:f,handleSaveEdit:g,toggleAll:y,toggleOne:d,handleBulkDelete:b,deleteSubcontract:T,setEditingSubcontract:P}=ht(n),{isImporting:F,importData:U,showPreview:O,setShowPreview:B,handleFileUpload:z,processImport:L,downloadTemplate:N}=Ct(),w=S.useMemo(()=>[{key:"Date of Issuing",label:"Date of Issuing"},{key:"Project Name",label:"Project Name"},{key:"Subcontractor Company",label:"Subcontractor Company"},{key:"Type of contract",label:"Type of Contract"},{key:"Trades",label:"Trades"},{key:"Items",label:"Items"},{key:"QTY",label:"Quantity"},{key:"Rate",label:"Rate"},{key:"wastage",label:"Wastage %"},{key:"Responsibilities",label:"Responsibilities"}],[]),M=S.useCallback(()=>{P(null)},[P]),A=S.useCallback(()=>{B(!1)},[B]);return v?e.jsx(Te,{}):e.jsx(lt,{tableName:"Subcontracts",onRetry:()=>window.location.reload(),children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ke,{onCreateNew:t,onFileUpload:z,onDownloadTemplate:N}),e.jsx(rt,{filteredData:l}),e.jsx(Ze,{searchTerm:i,onSimpleSearch:j,onAdvancedSearch:C,subcontracts:o}),e.jsx(st,{filteredData:l,selectedIds:u,searchTerm:i,showAdvancedSearch:r,allSelected:m,getProjectName:x,getProjectCode:p,getSubcontractorName:h,onToggleAll:y,onToggleOne:d,onViewDetail:s,onEdit:f,onDelete:T,onBulkDelete:b}),c&&e.jsx(Ae,{subcontract:c,open:!!c,onClose:M,onSave:g}),e.jsx(_e,{open:O,onClose:A,data:U,columns:w,onImport:L}),F&&e.jsx(nt,{})]})})});function It({open:a,onClose:t,onProjectCreated:s}){const{addProject:n}=R(),{toast:o}=q(),[l,i]=S.useState({name:"",code:"",location:""}),r=async u=>{if(u.preventDefault(),!l.name||!l.code||!l.location){o({title:"Missing Information",description:"Please fill all required fields",variant:"destructive"});return}try{await n(l),o({title:"Project Created",description:`${l.name} has been created successfully`}),s(l.name),i({name:"",code:"",location:""}),t()}catch{o({title:"Error",description:"Failed to create project",variant:"destructive"})}},c=(u,m)=>{i(v=>({...v,[u]:m}))};return e.jsx(he,{open:a,onOpenChange:t,children:e.jsxs(fe,{className:"max-w-md",children:[e.jsx(ge,{children:e.jsx(xe,{children:"Create New Project"})}),e.jsxs("form",{onSubmit:r,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"project-name",children:"Project Name *"}),e.jsx($,{id:"project-name",value:l.name,onChange:u=>c("name",u.target.value),placeholder:"Enter project name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"project-code",children:"Project Code *"}),e.jsx($,{id:"project-code",value:l.code,onChange:u=>c("code",u.target.value),placeholder:"Enter project code",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"project-location",children:"Location *"}),e.jsx($,{id:"project-location",value:l.location,onChange:u=>c("location",u.target.value),placeholder:"Enter project location",required:!0})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(D,{type:"submit",className:"flex-1",children:"Create Project"}),e.jsx(D,{type:"button",variant:"outline",onClick:t,children:"Cancel"})]})]})]})})}function Tt({open:a,onClose:t,onSubcontractorCreated:s}){const{addSubcontractor:n}=R(),{toast:o}=q(),[l,i]=S.useState({companyName:"",representativeName:"",commercialRegistration:"",taxCardNo:"",email:"",phone:""}),r=async u=>{if(u.preventDefault(),!l.companyName||!l.representativeName||!l.phone){o({title:"Missing Information",description:"Please fill required fields (Company Name, Representative Name, Phone)",variant:"destructive"});return}try{await n(l),o({title:"Subcontractor Created",description:`${l.companyName} has been created successfully`}),s(l.companyName),i({companyName:"",representativeName:"",commercialRegistration:"",taxCardNo:"",email:"",phone:""}),t()}catch{o({title:"Error",description:"Failed to create subcontractor",variant:"destructive"})}},c=(u,m)=>{i(v=>({...v,[u]:m}))};return e.jsx(he,{open:a,onOpenChange:t,children:e.jsxs(fe,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ge,{children:e.jsx(xe,{children:"Create New Subcontractor"})}),e.jsxs("form",{onSubmit:r,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-company",children:"Company Name *"}),e.jsx($,{id:"sub-company",value:l.companyName,onChange:u=>c("companyName",u.target.value),placeholder:"Enter company name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-representative",children:"Representative Name *"}),e.jsx($,{id:"sub-representative",value:l.representativeName,onChange:u=>c("representativeName",u.target.value),placeholder:"Enter representative name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-commercial",children:"Commercial Registration"}),e.jsx($,{id:"sub-commercial",value:l.commercialRegistration,onChange:u=>c("commercialRegistration",u.target.value),placeholder:"Enter commercial registration"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-tax",children:"Tax Card No."}),e.jsx($,{id:"sub-tax",value:l.taxCardNo,onChange:u=>c("taxCardNo",u.target.value),placeholder:"Enter tax card number"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-phone",children:"Phone *"}),e.jsx($,{id:"sub-phone",value:l.phone,onChange:u=>c("phone",u.target.value),placeholder:"Enter phone number",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-email",children:"Email"}),e.jsx($,{id:"sub-email",type:"email",value:l.email,onChange:u=>c("email",u.target.value),placeholder:"Enter email address"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(D,{type:"submit",className:"flex-1",children:"Create Subcontractor"}),e.jsx(D,{type:"button",variant:"outline",onClick:t,children:"Cancel"})]})]})]})})}function Dt({formData:a,setFormData:t}){const{projects:s,subcontractors:n}=R(),[o,l]=S.useState(!1),[i,r]=S.useState(!1),[c,u]=S.useState(""),[m,v]=S.useState(""),x=s.filter(d=>d.id&&d.name&&d.id.trim()!==""&&d.name.trim()!==""),p=n.filter(d=>d.id&&d.companyName&&d.id.trim()!==""&&d.companyName.trim()!==""),h=S.useMemo(()=>{if(!c.trim())return x;const d=c.toLowerCase();return x.filter(b=>b.name.toLowerCase().includes(d)||b.code.toLowerCase().includes(d))},[x,c]),j=S.useMemo(()=>{if(!m.trim())return p;const d=m.toLowerCase();return p.filter(b=>b.companyName.toLowerCase().includes(d)||b.commercialRegistration&&b.commercialRegistration.toLowerCase().includes(d)||b.taxCardNo&&b.taxCardNo.toLowerCase().includes(d))},[p,m]),C=d=>{const b=x.find(T=>T.name===d);b&&t(T=>({...T,project:b.id}))},f=d=>{const b=p.find(T=>T.companyName===d);b&&t(T=>({...T,subcontractor:b.id}))},g=x.find(d=>d.id===a.project),y=p.find(d=>d.id===a.subcontractor);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(k,{htmlFor:"project",children:"Select Project"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx($,{placeholder:"Search by project name or code...",value:c,onChange:d=>u(d.target.value),className:"pl-10"})]}),e.jsxs(W,{value:a.project,onValueChange:d=>t(b=>({...b,project:d})),children:[e.jsx(H,{children:e.jsx(G,{placeholder:"Choose a project...",children:g?g.name:"Choose a project..."})}),e.jsxs(X,{children:[h.map(d=>e.jsx(K,{value:d.id,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:d.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[d.code," • ",d.location]})]})},d.id)),h.length===0&&c&&e.jsxs("div",{className:"px-2 py-3 text-sm text-muted-foreground",children:['No projects found matching "',c,'"']})]})]}),e.jsxs(D,{type:"button",variant:"outline",size:"sm",onClick:()=>l(!0),className:"w-full flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4"}),"Create New Project"]})]})]}),e.jsxs("div",{children:[e.jsx(k,{htmlFor:"subcontractor",children:"Select Subcontractor"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx($,{placeholder:"Search by name, commercial registration, or tax card...",value:m,onChange:d=>v(d.target.value),className:"pl-10"})]}),e.jsxs(W,{value:a.subcontractor,onValueChange:d=>t(b=>({...b,subcontractor:d})),children:[e.jsx(H,{children:e.jsx(G,{placeholder:"Choose a subcontractor...",children:y?y.companyName:"Choose a subcontractor..."})}),e.jsxs(X,{children:[j.map(d=>e.jsx(K,{value:d.id,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:d.companyName}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[d.representativeName," • ",d.phone,d.commercialRegistration&&` • CR: ${d.commercialRegistration}`,d.taxCardNo&&` • Tax: ${d.taxCardNo}`]})]})},d.id)),j.length===0&&m&&e.jsxs("div",{className:"px-2 py-3 text-sm text-muted-foreground",children:['No subcontractors found matching "',m,'"']})]})]}),e.jsxs(D,{type:"button",variant:"outline",size:"sm",onClick:()=>r(!0),className:"w-full flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4"}),"Create New Subcontractor"]})]})]}),e.jsx(It,{open:o,onClose:()=>l(!1),onProjectCreated:C}),e.jsx(Tt,{open:i,onClose:()=>r(!1),onSubcontractorCreated:f})]})}function Pt({formData:a,setFormData:t,totalAmount:s,onFileUpload:n,renderExtraFields:o}){const{getProjectName:l,getSubcontractorName:i}=J();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(k,{htmlFor:"pdf",children:"Upload Contract PDF"}),e.jsxs("div",{className:"mt-2",children:[e.jsx($,{type:"file",accept:".pdf",onChange:n,className:"hidden",id:"pdf-upload"}),e.jsxs(D,{variant:"outline",onClick:()=>{var r;return(r=document.getElementById("pdf-upload"))==null?void 0:r.click()},className:"w-full flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4"}),a.pdfFile?a.pdfFile.name:"Choose PDF file..."]})]})]}),o&&e.jsx("div",{children:o}),e.jsxs("div",{className:"border rounded-lg p-4 space-y-4",children:[e.jsx("h3",{className:"font-semibold",children:"Contract Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Project:"})," ",l(a.project)]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Subcontractor:"})," ",i(a.subcontractor)]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Total Items:"})," ",a.tradeItems.length]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("strong",{children:"Contract Total:"})," ",e.jsx("span",{className:"text-lg font-semibold text-primary",children:te(s)})]})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Trade Items:"}),e.jsx("div",{className:"mt-2 space-y-1",children:a.tradeItems.map(r=>e.jsxs("div",{className:"text-sm bg-muted p-2 rounded",children:[r.trade," - ",r.item,": ",r.quantity," ",r.unit," × ",te(r.unitPrice)," = ",te(r.total)]},r.id))})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Responsibilities:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:a.responsibilities.map(r=>e.jsx(De,{variant:"outline",className:"text-xs",children:r},r))})]})]})]})}function kt({formData:a,setFormData:t}){const{subcontracts:s}=R(),n=()=>{if(a.contractType==="ADD"&&a.parentSubcontractId){const o=Array.isArray(s)?s.find(l=>l.id===a.parentSubcontractId):null;if(o){const i=((Array.isArray(s)?s.filter(r=>r.parentSubcontractId===a.parentSubcontractId&&r.contractType==="ADD"):[]).length+1).toString().padStart(2,"0");return`${o.contractId}-ADD${i}`}}return null};return e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-medium mb-1",children:"Type of Contract"}),e.jsxs("select",{className:"border rounded px-3 py-2 w-full",value:a.contractType,onChange:o=>t(l=>({...l,contractType:o.target.value,...o.target.value==="ADD"?{}:{addendumNumber:"",parentSubcontractId:""}})),children:[e.jsx("option",{value:"subcontract",children:"Subcontract"}),e.jsx("option",{value:"ADD",children:"Addendum"})]})]}),a.contractType==="ADD"&&e.jsxs("div",{children:[e.jsx("label",{className:"block font-medium mb-1",children:"Parent Subcontract *"}),e.jsxs("select",{className:"border rounded px-3 py-2 w-full",value:a.parentSubcontractId||"",onChange:o=>t(l=>({...l,parentSubcontractId:o.target.value})),required:a.contractType==="ADD",children:[e.jsx("option",{value:"",children:"Select parent subcontract..."}),Array.isArray(s)?s.filter(o=>o.contractType==="subcontract").map(o=>e.jsxs("option",{value:o.id,children:[o.contractId," - ",o.description]},o.id)):null]}),n()&&e.jsxs("p",{className:"text-sm text-blue-600 mt-1 font-medium",children:["Generated ID will be: ",n()]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Format: [parent-contract-number]-ADDXX (e.g., ID-0504-0001-ADD01)"})]})]})}function $t({steps:a,currentStep:t}){return e.jsx("div",{className:"flex items-center justify-between mt-4",children:a.map((s,n)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium ${n+1<=t?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"}`,children:n+1}),e.jsx("div",{className:`ml-2 text-sm ${n+1===t?"font-medium":"text-muted-foreground"}`,children:s}),n<a.length-1&&e.jsx("div",{className:`mx-4 h-0.5 w-8 ${n+1<t?"bg-primary":"bg-muted"}`})]},n))})}function Et({currentStep:a,stepsCount:t,isSaving:s,onPrev:n,onNext:o,onSave:l}){return e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[e.jsxs(D,{variant:"outline",onClick:n,disabled:a===1||s,className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4"}),"Previous"]}),a<t?e.jsxs(D,{onClick:o,className:"flex items-center gap-2",disabled:s,children:["Next",e.jsx(Xe,{className:"h-4 w-4"})]}):e.jsx(D,{onClick:l,className:"bg-green-600 hover:bg-green-700",disabled:s,children:s?"Saving...":"Save Subcontract"})]})}function Ft({formData:a,currentStep:t,steps:s,isSaving:n,onClose:o,onPrev:l,onNext:i,onSave:r,children:c}){return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs(V,{className:"w-full max-w-6xl max-h-[90vh] overflow-auto",children:[e.jsxs(ce,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(le,{children:["Create New ",a.contractType==="ADD"?"Addendum":"Subcontract"]}),e.jsx(D,{variant:"ghost",size:"sm",onClick:o,children:e.jsx(pe,{className:"h-4 w-4"})})]}),e.jsx($t,{steps:s,currentStep:t})]}),e.jsxs(Y,{className:"space-y-6",children:[c,e.jsx(Et,{currentStep:t,stepsCount:s.length,isSaving:n,onPrev:l,onNext:i,onSave:r})]})]})})}function At(){const[a,t]=S.useState(1),[s,n]=S.useState({project:"",subcontractor:"",tradeItems:[],responsibilities:[],pdfFile:null,dateOfIssuing:void 0,contractType:"subcontract",addendumNumber:"",parentSubcontractId:""}),[o,l]=S.useState(!1),i=["Project & Subcontractor","Trade & Items","Responsibilities","Documents & Review"];return{currentStep:a,formData:s,setFormData:n,isSaving:o,setIsSaving:l,steps:i,handleNext:m=>{m()&&t(v=>Math.min(v+1,i.length))},handlePrev:()=>{t(m=>Math.max(m-1,1))},getTotalAmount:()=>s.tradeItems.reduce((v,x)=>v+x.total,0)}}function Rt(){const{toast:a}=q();return{validateStep:(n,o)=>{switch(n){case 1:return!o.project||!o.subcontractor?(a({title:"Missing Information",description:"Please select both project and subcontractor",variant:"destructive"}),!1):o.contractType==="ADD"&&!o.parentSubcontractId?(a({title:"Missing Parent Contract",description:"Please select a parent subcontract for this addendum",variant:"destructive"}),!1):!0;case 2:return o.tradeItems.length===0?(a({title:"Missing Information",description:"Please add at least one trade item",variant:"destructive"}),!1):!0;case 3:return!0;default:return!0}},validateFinalSave:n=>!n.project||!n.subcontractor?(a({title:"Invalid Data",description:"Project and subcontractor must be selected",variant:"destructive"}),!1):n.contractType==="ADD"&&!n.parentSubcontractId?(a({title:"Invalid Addendum",description:"Parent subcontract must be selected for addendum",variant:"destructive"}),!1):!0}}function Mt({onClose:a,onSave:t}){const{toast:s}=q(),{trades:n,tradeItems:o,responsibilities:l}=R(),{currentStep:i,formData:r,setFormData:c,isSaving:u,setIsSaving:m,steps:v,handleNext:x,handlePrev:p,getTotalAmount:h}=At(),{validateStep:j,validateFinalSave:C}=Rt(),f=d=>{var T;const b=(T=d.target.files)==null?void 0:T[0];b&&b.type==="application/pdf"?(c(P=>({...P,pdfFile:b})),s({title:"File Uploaded",description:`${b.name} uploaded successfully`})):s({title:"Invalid File",description:"Please upload a PDF file",variant:"destructive"})},g=async()=>{if(!j(i,r)||!C(r))return;const d={contractId:"",project:r.project,subcontractor:r.subcontractor,tradeItems:r.tradeItems,responsibilities:r.responsibilities,totalValue:h(),status:"draft",startDate:new Date().toISOString().split("T")[0],endDate:new Date(Date.now()+30*24*60*60*1e3).toISOString().split("T")[0],dateOfIssuing:r.dateOfIssuing||new Date().toISOString().split("T")[0],description:`${r.contractType==="ADD"?"Addendum":"Subcontract"} for ${r.project} with ${r.subcontractor}`,contractType:r.contractType||"subcontract",addendumNumber:r.contractType==="ADD"&&r.addendumNumber||void 0,parentSubcontractId:r.contractType==="ADD"&&r.parentSubcontractId||void 0};try{m(!0),await t(d),s({title:"Success",description:`${r.contractType==="ADD"?"Addendum":"Subcontract"} saved and will appear in the table.`}),a()}catch(b){s({title:"Save failed",description:(b==null?void 0:b.message)||`Could not save ${r.contractType==="ADD"?"addendum":"subcontract"}.`,variant:"destructive"})}finally{m(!1)}},y=()=>{switch(i){case 1:return e.jsx(Dt,{formData:r,setFormData:c});case 2:return e.jsx(Me,{selectedItems:r.tradeItems,onItemsChange:d=>{c(b=>({...b,tradeItems:d}))},trades:n||[],tradeItems:o||[]});case 3:return e.jsx(Re,{selectedResponsibilities:r.responsibilities,onResponsibilitiesChange:d=>{c(b=>({...b,responsibilities:d}))},responsibilities:l||[]});case 4:return e.jsx(Pt,{formData:r,setFormData:c,totalAmount:h(),onFileUpload:f,renderExtraFields:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block font-medium mb-1",children:"Date of Issuing"}),e.jsx("input",{type:"date",className:"border rounded px-3 py-2 w-full",value:r.dateOfIssuing||"",onChange:d=>{c(b=>({...b,dateOfIssuing:d.target.value}))},required:!0})]}),e.jsx("div",{className:"mt-4",children:e.jsx(kt,{formData:r,setFormData:c})})]})});default:return null}};return e.jsx(Ft,{formData:r,currentStep:i,steps:v,isSaving:u,onClose:a,onPrev:p,onNext:()=>{x(()=>j(i,r))},onSave:g,children:y()})}function Lt(){const a=$e(),t=Ee(),[s,n]=S.useState(!1),[o,l]=S.useState(null),{addSubcontract:i}=R(),{toast:r}=q(),{profile:c}=Fe(),u=(c==null?void 0:c.role)!=="viewer";S.useEffect(()=>{console.log("Subcontracts page - parsing URL parameters:",t.search),l(null);try{const p=new URLSearchParams(t.search),h={};if(p.get("month")&&(h.month=p.get("month"),console.log("Found month filter:",h.month)),p.get("year")&&(h.year=p.get("year"),console.log("Found year filter:",h.year)),p.get("location")&&(h.location=p.get("location"),console.log("Found location filter:",h.location)),p.get("trades")&&(h.trades=p.get("trades"),console.log("Found trades filter:",h.trades)),p.get("projectName")&&(h.projectName=decodeURIComponent(p.get("projectName")||""),console.log("Found projectName filter:",h.projectName)),p.get("projectCode")&&(h.projectCode=p.get("projectCode"),console.log("Found projectCode filter:",h.projectCode)),p.get("facilities"))try{const j=decodeURIComponent(p.get("facilities")||"");j!=null&&j.startsWith("[")&&j.endsWith("]")?h.facilities=JSON.parse(j):j?h.facilities=j.split(",").filter(C=>C.trim()):h.facilities=[],console.log("Found facilities filter:",h.facilities)}catch(j){console.error("Error parsing facilities parameter:",j),h.facilities=[]}console.log("Final parsed filters:",h),Object.keys(h).length>0?(l(h),console.log("Setting report filters:",h)):console.log("No filters found in URL")}catch(p){console.error("Error parsing URL parameters:",p),l(null)}},[t.search]);const m=()=>{if(console.log("Create new subcontract clicked, canModify:",u),!u){console.log("User cannot modify - showing toast"),r({title:"Access Denied",description:"You don't have permission to create subcontracts",variant:"destructive"});return}console.log("Opening stepper modal"),n(!0)},v=p=>{console.log("Viewing subcontract detail:",p),a(`/subcontracts/${p}`)},x=async p=>{console.log("handleSaveSubcontract called with data:",p);try{console.log("Calling addSubcontract..."),await i(p),console.log("addSubcontract completed successfully"),n(!1)}catch(h){console.error("Error in handleSaveSubcontract:",h)}};return console.log("Subcontracts page render - showStepper:",s,"canModify:",u),s?e.jsx(Mt,{onSave:x,onClose:()=>{console.log("Closing stepper"),n(!1)}}):e.jsx(wt,{onCreateNew:u?m:void 0,onViewDetail:v,reportFilters:o})}function oa(){return e.jsx(ke,{pageName:"Subcontracts",children:e.jsx(Lt,{})})}export{oa as Subcontracts};
