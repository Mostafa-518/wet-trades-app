import{m as P,o as q,r as i,j as t,C as G,a as J,b as K,c as Q,I as W,B as y,a3 as u}from"./index-BPW1VvWz.js";import{S as b,a as w,b as A,c as E,d as k}from"./select-MYwvS03t.js";import{T as L}from"./TableSelectionCheckbox-Bh5CbQdB.js";import"./index-C21_ivdF.js";function te(){const{toast:n}=P(),{userRole:U}=q(),l=U==="admin",[m,D]=i.useState([]),[g,d]=i.useState(!1),[p,F]=i.useState("all"),[v,T]=i.useState("all"),[h,I]=i.useState(""),[N,C]=i.useState({}),[x,o]=i.useState(new Set),S={subcontracts:"admin_undo_subcontract",projects:"admin_undo_project",subcontractors:"admin_undo_subcontractor",trades:"admin_undo_trade",trade_items:"admin_undo_trade_item"},f=async()=>{d(!0);const{data:e,error:s}=await u.from("audit_logs").select("*").order("created_at",{ascending:!1}).limit(500);s?(console.error("Failed to fetch audit logs",s),n({title:"Error",description:"Failed to load activity logs",variant:"destructive"})):D(e||[]),d(!1)};i.useEffect(()=>{f()},[]),i.useEffect(()=>{(async()=>{const s=Array.from(new Set(m.map(j=>j.user_id).filter(Boolean)));if(s.length===0){C({});return}const{data:a,error:c}=await u.from("user_profiles").select("id, full_name, email").in("id",s);if(!c&&a){const j={};a.forEach(_=>{j[_.id]={full_name:_.full_name??null,email:_.email??null}}),C(j)}})()},[m]);const r=i.useMemo(()=>m.filter(e=>{var s;return(p==="all"||e.entity===p)&&(v==="all"||e.action===v)&&(!h||((s=e.entity_id)==null?void 0:s.toLowerCase().includes(h.toLowerCase()))||e.entity.toLowerCase().includes(h.toLowerCase()))}),[m,p,v,h]),$=(e,s)=>{o(a=>{const c=new Set(a);return s?c.add(e):c.delete(e),c})},B=i.useMemo(()=>r.length>0&&r.every(e=>x.has(e.id)),[r,x]),M=e=>{if(!e){o(new Set);return}o(new Set(r.map(s=>s.id)))};i.useEffect(()=>{o(e=>{const s=new Set;return r.forEach(a=>{e.has(a.id)&&s.add(a.id)}),s})},[r]);const z=async()=>{if(!l)return;const e=Array.from(x);if(e.length===0){n({title:"No selection",description:"Select at least one activity to delete."});return}if(!confirm(`Delete ${e.length} selected activit${e.length===1?"y":"ies"}?`))return;d(!0);const{error:s}=await u.from("audit_logs").delete().in("id",e);s?(console.error("Delete selected failed",s),n({title:"Delete failed",description:s.message,variant:"destructive"})):(n({title:"Deleted",description:`Deleted ${e.length} activit${e.length===1?"y":"ies"}.`}),o(new Set),await f()),d(!1)},R=async()=>{if(l&&confirm("This will delete all activity logs. Continue?")){d(!0);try{const{error:e}=await u.rpc("admin_clear_audit_logs");if(e){const{error:s}=await u.from("audit_logs").delete().not("id","is",null);if(s)throw s}n({title:"Cleared",description:"All activity logs have been deleted."}),o(new Set),await f()}catch(e){console.error("Clear all failed",e),n({title:"Clear failed",description:(e==null?void 0:e.message)||"Could not clear logs",variant:"destructive"})}finally{d(!1)}}},V=async e=>{if(!l)return;const s=S[e.entity];if(!s){n({title:"Undo not available",description:`No undo function found for entity "${e.entity}".`});return}try{const{error:a}=await u.rpc(s,{p_log_id:e.id});if(a)throw a;n({title:"Undone",description:"Action has been undone."}),f()}catch(a){console.error("Undo failed",a),n({title:"Undo failed",description:(a==null?void 0:a.message)||"Could not undo action",variant:"destructive"})}},H=["all",...Object.keys(S)],O=["all","insert","delete"];return t.jsxs("div",{children:[t.jsxs("header",{className:"mb-4",children:[t.jsx("h1",{className:"text-2xl font-bold",children:"Activity Log"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Track all changes across key entities. Admins can undo supported actions."})]}),t.jsxs(G,{children:[t.jsx(J,{children:t.jsx(K,{children:"Filters"})}),t.jsxs(Q,{className:"grid grid-cols-1 md:grid-cols-4 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium",children:"Entity"}),t.jsxs(b,{value:p,onValueChange:F,children:[t.jsx(w,{children:t.jsx(A,{})}),t.jsx(E,{children:H.map(e=>t.jsx(k,{value:e,children:e},e))})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium",children:"Action"}),t.jsxs(b,{value:v,onValueChange:T,children:[t.jsx(w,{children:t.jsx(A,{})}),t.jsx(E,{children:O.map(e=>t.jsx(k,{value:e,children:e},e))})]})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"text-xs font-medium",children:"Search"}),t.jsx(W,{placeholder:"Search by entity or ID",value:h,onChange:e=>I(e.target.value)})]}),t.jsxs("div",{className:"md:col-span-4 flex flex-wrap gap-2 justify-end",children:[l&&t.jsxs(t.Fragment,{children:[t.jsx(y,{variant:"destructive",onClick:z,disabled:g||x.size===0,children:"Delete Selected"}),t.jsx(y,{variant:"destructive",onClick:R,disabled:g||m.length===0,children:"Clear All"})]}),t.jsx(y,{variant:"outline",onClick:f,disabled:g,children:"Refresh"})]})]})]}),t.jsxs("div",{className:"mt-4 border rounded-lg overflow-hidden",children:[t.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 text-xs font-semibold px-4 py-2",children:[l&&t.jsx("div",{className:"col-span-1",children:t.jsx(L,{checked:B,onCheckedChange:e=>M(!!e),ariaLabel:"Select all activities"})}),t.jsx("div",{className:"col-span-3",children:"Timestamp"}),t.jsx("div",{className:"col-span-2",children:"User"}),t.jsx("div",{className:"col-span-2",children:"Entity"}),t.jsx("div",{className:l?"col-span-1":"col-span-2",children:"Action"}),t.jsx("div",{className:"col-span-2",children:"Entity ID"}),t.jsx("div",{className:"col-span-1 text-right",children:"Undo"})]}),t.jsxs("div",{className:"divide-y",children:[r.map(e=>{var s,a;return t.jsxs("div",{className:"grid grid-cols-12 px-4 py-2 items-center text-sm",children:[l&&t.jsx("div",{className:"col-span-1",children:t.jsx(L,{checked:x.has(e.id),onCheckedChange:c=>$(e.id,!!c),ariaLabel:`Select activity ${e.id}`})}),t.jsx("div",{className:"col-span-3",children:new Date(e.created_at).toLocaleString()}),t.jsx("div",{className:"col-span-2",children:e.user_id?((s=N[e.user_id])==null?void 0:s.full_name)||((a=N[e.user_id])==null?void 0:a.email)||e.user_id.slice(0,8):"system"}),t.jsx("div",{className:"col-span-2",children:e.entity}),t.jsx("div",{className:l?"col-span-1 capitalize":"col-span-2 capitalize",children:e.action}),t.jsx("div",{className:"col-span-2 truncate",title:e.entity_id||"",children:e.entity_id||"-"}),t.jsx("div",{className:"col-span-1 text-right",children:l&&S[e.entity]&&t.jsx(y,{size:"sm",variant:"outline",onClick:()=>V(e),children:"Undo"})})]},e.id)}),r.length===0&&t.jsx("div",{className:"px-4 py-6 text-sm text-center text-muted-foreground",children:"No activity found."})]})]})]})}export{te as ActivityLog,te as default};
