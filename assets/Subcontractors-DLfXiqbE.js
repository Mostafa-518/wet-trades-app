import{j as e,B as k,I as L,C as _,a as U,b as M,c as z,T as H,d as O,e as P,f as y,g as V,h as v,i as R,m as F,r as j,k as q,n as J}from"./index-B-fhMUS3.js";import{I as X}from"./ImportPreviewDialog-Cb8V2nZm.js";import{F as A}from"./file-spreadsheet-DeB7C_iY.js";import{P as G}from"./plus-D9UoAsOA.js";import{S as K}from"./search-B_p41cST.js";import{T as B}from"./TableSelectionCheckbox-BgQxpWSU.js";import{u as Q,P as W}from"./PaginationControls-C3_hrcS1.js";import{E as Y}from"./eye-CHQHiNQu.js";import{S as Z}from"./square-pen-OK-kRDBn.js";import{T as ee}from"./trash-2-CtRfNH7u.js";import{u as I,w as te,r as ae}from"./xlsx-CKN5doRT.js";import{S as re}from"./SubcontractorForm-BFHvnhNQ.js";import"./dialog-_KqJokic.js";import"./index-DFB4SIWy.js";import"./form-DN9n8LfF.js";import"./types-CmXXCkfK.js";function se({onCreateNew:c,onFileUpload:o,onDownloadTemplate:i}){return e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Subcontractors"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(k,{variant:"outline",onClick:i,className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-4 w-4"}),"Download Template"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:o,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",id:"excel-upload"}),e.jsxs(k,{variant:"outline",className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-4 w-4"}),"Import Excel"]})]}),c&&e.jsxs(k,{onClick:c,className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),"New Subcontractor"]})]})]})}function oe({searchTerm:c,setSearchTerm:o,searchBy:i,setSearchBy:m}){return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(K,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(L,{placeholder:"Search subcontractors...",value:c,onChange:u=>o(u.target.value),className:"pl-10"})]}),e.jsxs("select",{value:i,onChange:u=>m(u.target.value),className:"px-3 py-2 border border-input bg-background rounded-md text-sm",children:[e.jsx("option",{value:"name",children:"Business Name"}),e.jsx("option",{value:"companyName",children:"Company Name"}),e.jsx("option",{value:"representative",children:"Representative"}),e.jsx("option",{value:"commercialRegistration",children:"Commercial Registration"}),e.jsx("option",{value:"taxCardNo",children:"Tax Card No."}),e.jsx("option",{value:"email",children:"Email"}),e.jsx("option",{value:"phone",children:"Phone"})]})]})}function ne({selectedCount:c,onBulkDelete:o}){return c===0?null:e.jsxs("div",{className:"p-2 bg-red-50 border-b flex items-center gap-2",children:[e.jsxs("span",{className:"font-medium",children:[c," selected"]}),e.jsx(k,{variant:"destructive",size:"sm",onClick:o,children:"Delete Selected"})]})}function le({filteredSubcontractors:c,selectedIds:o,allSelected:i,onToggleAll:m,onToggleOne:u,onViewDetail:x,onEdit:S,onDelete:N,searchTerm:p}){const{currentPage:s,totalPages:r,paginatedData:n,goToPage:f,hasNextPage:g,hasPreviousPage:t,totalItems:l,itemsPerPage:d}=Q({data:c,itemsPerPage:5});return e.jsxs(_,{children:[e.jsx(U,{children:e.jsxs(M,{children:["Subcontractors (",c.length,")"]})}),e.jsxs(z,{className:"space-y-4",children:[e.jsx(W,{currentPage:s,totalPages:r,onPageChange:f,hasNextPage:g,hasPreviousPage:t,totalItems:l,itemsPerPage:d}),e.jsxs(H,{children:[e.jsx(O,{children:e.jsxs(P,{children:[e.jsx(y,{children:e.jsx(B,{checked:i,onCheckedChange:m,ariaLabel:"Select all subcontractors"})}),e.jsx(y,{children:"Company Name"}),e.jsx(y,{children:"Representative"}),e.jsx(y,{children:"Commercial Registration"}),e.jsx(y,{children:"Tax Card No."}),e.jsx(y,{children:"Email"}),e.jsx(y,{children:"Phone"}),e.jsx(y,{children:"Actions"})]})}),e.jsxs(V,{children:[n.map(a=>e.jsxs(P,{children:[e.jsx(v,{children:e.jsx(B,{checked:o.has(a.id),onCheckedChange:()=>u(a.id),ariaLabel:`Select subcontractor ${a.companyName}`})}),e.jsx(v,{className:"font-medium",children:a.companyName}),e.jsx(v,{children:a.representativeName}),e.jsx(v,{children:a.commercialRegistration}),e.jsx(v,{children:a.taxCardNo}),e.jsx(v,{children:a.email}),e.jsx(v,{children:a.phone}),e.jsx(v,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(k,{variant:"ghost",size:"sm",onClick:()=>x(a.id),className:"h-8 w-8 p-0",children:e.jsx(Y,{className:"h-4 w-4"})}),S&&e.jsx(k,{variant:"ghost",size:"sm",onClick:()=>S(a),className:"h-8 w-8 p-0",children:e.jsx(Z,{className:"h-4 w-4"})}),N&&e.jsx(k,{variant:"ghost",size:"sm",onClick:()=>N(a.id),className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(ee,{className:"h-4 w-4"})})]})})]},a.id)),n.length===0&&e.jsx(P,{children:e.jsx(v,{colSpan:8,className:"text-center py-8 text-muted-foreground",children:p?"No subcontractors found matching your search.":"No subcontractors found."})})]})]})]})]})}function ce(){const{subcontractors:c,deleteSubcontractor:o}=R(),{toast:i}=F(),[m,u]=j.useState(""),[x,S]=j.useState("companyName"),[N,p]=j.useState(new Set),s=c.filter(t=>{if(!m)return!0;const l=m.toLowerCase();switch(x){case"companyName":return t.companyName.toLowerCase().includes(l);case"commercialRegistration":return t.commercialRegistration.toLowerCase().includes(l);case"taxCardNo":return t.taxCardNo.toLowerCase().includes(l);case"representative":return t.representativeName.toLowerCase().includes(l);case"email":return t.email.toLowerCase().includes(l);case"phone":return t.phone.toLowerCase().includes(l);default:return!0}}),r=s.length>0&&s.every(t=>N.has(t.id));return{searchTerm:m,setSearchTerm:u,searchBy:x,setSearchBy:S,selectedIds:N,setSelectedIds:p,filteredSubcontractors:s,allSelected:r,toggleAll:()=>{p(r?new Set:new Set(s.map(t=>t.id)))},toggleOne:t=>{p(l=>{const d=new Set(l);return d.has(t)?d.delete(t):d.add(t),d})},handleBulkDelete:async()=>{try{for(const t of N)await o(t);i({title:"Deleted",description:"Subcontractors deleted successfully"}),p(new Set)}catch{i({title:"Error",description:"Failed to delete selected subcontractors",variant:"destructive"})}}}}function ie(){const{addSubcontractor:c}=R(),{toast:o}=F(),[i,m]=j.useState(!1),[u,x]=j.useState([]);return{showImportDialog:i,setShowImportDialog:m,importData:u,setImportData:x,handleFileUpload:s=>{var f;const r=(f=s.target.files)==null?void 0:f[0];if(!r)return;const n=new FileReader;n.onload=g=>{var t;try{const l=new Uint8Array((t=g.target)==null?void 0:t.result),d=ae(l,{type:"array"}),a=d.SheetNames[0],C=d.Sheets[a],T=I.sheet_to_json(C,{header:1,defval:"",raw:!1}).filter((h,D)=>h&&h.length>0&&h.some(E=>E&&String(E).trim())).map((h,D)=>({companyName:String(h[0]||"").trim(),representativeName:String(h[1]||"").trim(),commercialRegistration:String(h[2]||"").trim(),taxCardNo:String(h[3]||"").trim(),phone:String(h[4]||"").trim(),email:String(h[5]||"").trim()})).filter(h=>h.companyName&&h.companyName.length>0);if(T.length===0){o({title:"No Data Found",description:"No valid company names found in the Excel file. Please ensure your data contains company names in the first column.",variant:"destructive"});return}x(T),m(!0),o({title:"File Processed",description:`Found ${T.length} records to import`})}catch(l){console.error("Import error:",l),o({title:"Import Error",description:"Failed to parse Excel file. Please check the format and try again.",variant:"destructive"})}},n.onerror=g=>{console.error("FileReader error:",g),o({title:"File Read Error",description:"Failed to read the Excel file. Please try again.",variant:"destructive"})},n.readAsArrayBuffer(r),s.target.value=""},handleImport:async s=>{var g,t,l,d,a;if(!s||s.length===0){o({title:"Import Error",description:"No data to import",variant:"destructive"});return}let r=0,n=0;const f=[];for(const[C,b]of s.entries())try{if(!b.companyName||!b.companyName.trim()){f.push(`Row ${C+1}: Missing company name`),n++;continue}const w={companyName:b.companyName.trim(),representativeName:((g=b.representativeName)==null?void 0:g.trim())||"",commercialRegistration:((t=b.commercialRegistration)==null?void 0:t.trim())||"",taxCardNo:((l=b.taxCardNo)==null?void 0:l.trim())||"",email:((d=b.email)==null?void 0:d.trim())||"",phone:((a=b.phone)==null?void 0:a.trim())||""};await c(w),r++}catch(w){const T=w instanceof Error?w.message:"Unknown error";f.push(`Row ${C+1}: ${b.companyName||"Unknown"} - ${T}`),n++}r>0?o({title:"Import Completed",description:`${r} subcontractor${r!==1?"s":""} imported successfully${n>0?`. ${n} failed.`:""}`}):o({title:"Import Failed",description:n>0?`All ${n} items failed to import. Please check the data format.`:"No items could be imported.",variant:"destructive"}),m(!1),x([])},downloadTemplate:()=>{const s=[["Company Name","Representative Name","Commercial Registration","Tax Card No.","Phone Contact","Mail"],["Sample Company Ltd.","John Doe","CR-001-2024","TAX-001-2024","+20 100 123 4567","john@example.com"]],r=I.aoa_to_sheet(s),n=I.book_new();I.book_append_sheet(n,r,"Subcontractors Template"),te(n,"subcontractors_template.xlsx")}}}const me=j.memo(function({onCreateNew:o,onViewDetail:i,onEdit:m,onDelete:u}){const{searchTerm:x,setSearchTerm:S,searchBy:N,setSearchBy:p,selectedIds:s,filteredSubcontractors:r,allSelected:n,toggleAll:f,toggleOne:g,handleBulkDelete:t}=ce(),{showImportDialog:l,setShowImportDialog:d,importData:a,setImportData:C,handleFileUpload:b,handleImport:w,downloadTemplate:T}=ie(),h=j.useMemo(()=>[{key:"companyName",label:"Company Name"},{key:"representativeName",label:"Representative Name"},{key:"commercialRegistration",label:"Commercial Registration"},{key:"taxCardNo",label:"Tax Card No."},{key:"phone",label:"Phone Contact"},{key:"email",label:"Mail"}],[]),D=j.useCallback(()=>{d(!1),C([])},[d,C]);return e.jsxs("div",{className:"space-y-4",children:[e.jsx(se,{onCreateNew:o,onFileUpload:b,onDownloadTemplate:T}),e.jsx(oe,{searchTerm:x,setSearchTerm:S,searchBy:N,setSearchBy:p}),e.jsx(ne,{selectedCount:s.size,onBulkDelete:t}),e.jsx(le,{filteredSubcontractors:r,selectedIds:s,allSelected:n,onToggleAll:f,onToggleOne:g,onViewDetail:i,onEdit:m,onDelete:u,searchTerm:x}),e.jsx(X,{open:l,onClose:D,data:a,columns:h,onImport:w})]})});function ke(){const c=q(),[o,i]=j.useState(!1),[m,u]=j.useState(null),{addSubcontractor:x,updateSubcontractor:S,deleteSubcontractor:N}=R(),{toast:p}=F(),{profile:s}=J(),r=(s==null?void 0:s.role)!=="viewer",n=()=>{r&&(u(null),i(!0))},f=a=>{c(`/subcontractors/${a}`)},g=a=>{r&&(u(a),i(!0))},t=a=>{r&&(N(a),p({title:"Subcontractor deleted",description:"The subcontractor has been removed successfully."}))},l=a=>{m?(S(m.id,a),p({title:"Subcontractor updated",description:"The subcontractor has been updated successfully."})):(x(a),p({title:"Subcontractor created",description:"A new subcontractor has been created successfully."})),i(!1),u(null)},d=()=>{i(!1),u(null)};return o?e.jsx(re,{subcontractor:m,onSubmit:l,onCancel:d}):e.jsx(me,{onCreateNew:r?n:void 0,onViewDetail:f,onEdit:r?g:void 0,onDelete:r?t:void 0})}export{ke as Subcontractors};
