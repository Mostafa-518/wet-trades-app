import{r as d,j as e,C as $,a as q,b as V,c as Q,B as _,I as E,T as ke,d as Me,e as z,f as j,g as Oe,h as v,Y as Le,Z as Ie,$ as $e,s as F,z as Y,G as qe,J as Ve,a0 as Qe,M as g,N as J,m as ze,a1 as Ke,a2 as L,a3 as Be,l as Ge,n as He,o as We,a4 as Ye,R as Je}from"./index-BW011E6G.js";import{P as Ze}from"./plus-BjXUjfi5.js";import{S as Xe}from"./search-BW_M4e0M.js";import{C as ea,f as aa,U as ta}from"./UserDetailView-BiEr3bFl.js";import{C as sa}from"./calendar-e18J0cHa.js";import{E as ra}from"./eye-DwuUZgn9.js";import{S as la}from"./square-pen-DiJGTOgi.js";import{T as na}from"./trash-2-BLffjhfG.js";import{f as Z,R as oa,P as ia,W as ca,C as da,T as ma,g as ua,h as X,O as pa,i as xa,D as ha,a as ga,b as fa,c as ja,d as va}from"./dialog-BwxTDunR.js";import{u as ya,e as Na,F as y,a as N,b as w,c as b,d as A}from"./form-B5Z4MJa0.js";import{t as wa,o as ba,s as D,e as K}from"./types-DDVGcL2r.js";import{S as B,a as G,b as H,c as W,d as C}from"./select-Dv4-AOa7.js";import{A as Aa}from"./AvatarUpload-BbvstCN8.js";import{U as k}from"./userService-9xAvHOf0.js";import{P as Da}from"./PermissionGuard-CuIWz_PQ.js";import"./user-BA4CemyU.js";import"./phone-I22mKhc4.js";import"./formatDistance-BGkT52mR.js";import"./index-DcX0hMW7.js";function Ca({users:a,onAdd:t,onEdit:s,onDelete:o,onView:i,loading:r=!1,canModify:c=!0}){const[n,u]=d.useState(""),m=a.filter(l=>l.name.toLowerCase().includes(n.toLowerCase())||l.email.toLowerCase().includes(n.toLowerCase())||l.department.toLowerCase().includes(n.toLowerCase())||l.role.toLowerCase().includes(n.toLowerCase())),f=l=>{switch(l){case"active":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300";case"inactive":return"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300";case"suspended":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300";default:return"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300"}},S=l=>{switch(l){case"admin":return"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300";case"manager":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300";case"viewer":return"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300";default:return"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300"}},M=l=>l.split(" ").map(T=>T[0]).join("").toUpperCase().slice(0,2),U=l=>{try{const T=new Date(l);return aa(T,{addSuffix:!0})}catch{return"Never"}};return r?e.jsxs($,{children:[e.jsx(q,{children:e.jsx(V,{children:"Users Management"})}),e.jsx(Q,{children:e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading users..."})})})]}):e.jsxs($,{children:[e.jsxs(q,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx(V,{className:"text-xl font-semibold",children:"Users Management"}),c&&t&&e.jsxs(_,{onClick:t,className:"w-full sm:w-auto",children:[e.jsx(Ze,{className:"h-4 w-4 mr-2"}),"Add User"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Xe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(E,{placeholder:"Search users...",value:n,onChange:l=>u(l.target.value),className:"max-w-sm"})]})]}),e.jsxs(Q,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ke,{children:[e.jsx(Me,{children:e.jsxs(z,{children:[e.jsx(j,{className:"w-[250px]",children:"User"}),e.jsx(j,{className:"hidden sm:table-cell",children:"Role"}),e.jsx(j,{className:"hidden md:table-cell",children:"Department"}),e.jsx(j,{className:"hidden lg:table-cell",children:"Status"}),e.jsx(j,{className:"hidden xl:table-cell",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ea,{className:"h-4 w-4"}),"Last Login"]})}),e.jsx(j,{className:"hidden xl:table-cell",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(sa,{className:"h-4 w-4"}),"Created"]})}),e.jsx(j,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Oe,{children:m.map(l=>e.jsxs(z,{className:"hover:bg-muted/50",children:[e.jsx(v,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Le,{className:"h-10 w-10",children:[e.jsx(Ie,{src:l.avatar,alt:l.name}),e.jsx($e,{className:"text-sm font-medium",children:M(l.name)})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"font-medium truncate",children:l.name}),e.jsx("div",{className:"text-sm text-muted-foreground truncate",children:l.email}),e.jsxs("div",{className:"flex gap-2 mt-1 sm:hidden",children:[e.jsx(F,{variant:"secondary",className:`${S(l.role)} text-xs`,children:l.role}),e.jsx(F,{variant:"secondary",className:`${f(l.status)} text-xs`,children:l.status})]})]})]})}),e.jsx(v,{className:"hidden sm:table-cell",children:e.jsx(F,{variant:"secondary",className:S(l.role),children:l.role.charAt(0).toUpperCase()+l.role.slice(1)})}),e.jsx(v,{className:"hidden md:table-cell",children:l.department}),e.jsx(v,{className:"hidden lg:table-cell",children:e.jsx(F,{variant:"secondary",className:f(l.status),children:l.status.charAt(0).toUpperCase()+l.status.slice(1)})}),e.jsx(v,{className:"hidden xl:table-cell",children:e.jsx("div",{className:"text-sm",children:l.lastLogin?U(l.lastLogin):"Never"})}),e.jsx(v,{className:"hidden xl:table-cell",children:e.jsx("div",{className:"text-sm",children:U(l.createdAt)})}),e.jsx(v,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>i(l),className:"h-8 w-8 p-0",children:e.jsx(ra,{className:"h-4 w-4"})}),c&&s&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>s(l),className:"h-8 w-8 p-0",children:e.jsx(la,{className:"h-4 w-4"})}),c&&o&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>o(l.id),className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950",children:e.jsx(na,{className:"h-4 w-4"})})]})})]},l.id))})]})}),m.length===0&&e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"No users found."})})]})]})}var ee="AlertDialog",[Sa,mt]=qe(ee,[Z]),h=Z(),ae=a=>{const{__scopeAlertDialog:t,...s}=a,o=h(t);return e.jsx(oa,{...o,...s,modal:!0})};ae.displayName=ee;var Ua="AlertDialogTrigger",Ta=d.forwardRef((a,t)=>{const{__scopeAlertDialog:s,...o}=a,i=h(s);return e.jsx(xa,{...i,...o,ref:t})});Ta.displayName=Ua;var Ea="AlertDialogPortal",te=a=>{const{__scopeAlertDialog:t,...s}=a,o=h(t);return e.jsx(ia,{...o,...s})};te.displayName=Ea;var _a="AlertDialogOverlay",se=d.forwardRef((a,t)=>{const{__scopeAlertDialog:s,...o}=a,i=h(s);return e.jsx(pa,{...i,...o,ref:t})});se.displayName=_a;var P="AlertDialogContent",[Pa,Ra]=Sa(P),Fa=Qe("AlertDialogContent"),re=d.forwardRef((a,t)=>{const{__scopeAlertDialog:s,children:o,...i}=a,r=h(s),c=d.useRef(null),n=Y(t,c),u=d.useRef(null);return e.jsx(ca,{contentName:P,titleName:le,docsSlug:"alert-dialog",children:e.jsx(Pa,{scope:s,cancelRef:u,children:e.jsxs(da,{role:"alertdialog",...r,...i,ref:n,onOpenAutoFocus:Ve(i.onOpenAutoFocus,m=>{var f;m.preventDefault(),(f=u.current)==null||f.focus({preventScroll:!0})}),onPointerDownOutside:m=>m.preventDefault(),onInteractOutside:m=>m.preventDefault(),children:[e.jsx(Fa,{children:o}),e.jsx(Ma,{contentRef:c})]})})})});re.displayName=P;var le="AlertDialogTitle",ne=d.forwardRef((a,t)=>{const{__scopeAlertDialog:s,...o}=a,i=h(s);return e.jsx(ma,{...i,...o,ref:t})});ne.displayName=le;var oe="AlertDialogDescription",ie=d.forwardRef((a,t)=>{const{__scopeAlertDialog:s,...o}=a,i=h(s);return e.jsx(ua,{...i,...o,ref:t})});ie.displayName=oe;var ka="AlertDialogAction",ce=d.forwardRef((a,t)=>{const{__scopeAlertDialog:s,...o}=a,i=h(s);return e.jsx(X,{...i,...o,ref:t})});ce.displayName=ka;var de="AlertDialogCancel",me=d.forwardRef((a,t)=>{const{__scopeAlertDialog:s,...o}=a,{cancelRef:i}=Ra(de,s),r=h(s),c=Y(t,i);return e.jsx(X,{...r,...o,ref:c})});me.displayName=de;var Ma=({contentRef:a})=>{const t=`\`${P}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${P}\` by passing a \`${oe}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${P}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return d.useEffect(()=>{var o;document.getElementById((o=a.current)==null?void 0:o.getAttribute("aria-describedby"))||console.warn(t)},[t,a]),null},Oa=ae,La=te,ue=se,pe=re,xe=ce,he=me,ge=ne,fe=ie;const Ia=Oa,$a=La,je=d.forwardRef(({className:a,...t},s)=>e.jsx(ue,{className:g("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...t,ref:s}));je.displayName=ue.displayName;const ve=d.forwardRef(({className:a,...t},s)=>e.jsxs($a,{children:[e.jsx(je,{}),e.jsx(pe,{ref:s,className:g("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...t})]}));ve.displayName=pe.displayName;const ye=({className:a,...t})=>e.jsx("div",{className:g("flex flex-col space-y-2 text-center sm:text-left",a),...t});ye.displayName="AlertDialogHeader";const Ne=({className:a,...t})=>e.jsx("div",{className:g("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...t});Ne.displayName="AlertDialogFooter";const we=d.forwardRef(({className:a,...t},s)=>e.jsx(ge,{ref:s,className:g("text-lg font-semibold",a),...t}));we.displayName=ge.displayName;const be=d.forwardRef(({className:a,...t},s)=>e.jsx(fe,{ref:s,className:g("text-sm text-muted-foreground",a),...t}));be.displayName=fe.displayName;const Ae=d.forwardRef(({className:a,...t},s)=>e.jsx(xe,{ref:s,className:g(J(),a),...t}));Ae.displayName=xe.displayName;const De=d.forwardRef(({className:a,...t},s)=>e.jsx(he,{ref:s,className:g(J({variant:"outline"}),"mt-2 sm:mt-0",a),...t}));De.displayName=he.displayName;const qa=a=>ba({name:D().min(2,"Name must be at least 2 characters"),email:D().email("Invalid email address"),role:K(["admin","procurement_manager","procurement_engineer","viewer"]),department:D().optional(),status:K(["active","inactive","suspended"]),phone:D().optional(),password:a?D().optional():D().optional().refine(t=>!t||t.length>=6,{message:"Password must be at least 6 characters"}),avatar:D().optional()});function Va({user:a,onSubmit:t,onCancel:s}){const[o,i]=d.useState((a==null?void 0:a.avatar)||null),r=ya({resolver:wa(qa(!!a)),defaultValues:{name:(a==null?void 0:a.name)||"",email:(a==null?void 0:a.email)||"",role:(a==null?void 0:a.role)||"viewer",department:(a==null?void 0:a.department)||"General",status:(a==null?void 0:a.status)||"active",phone:(a==null?void 0:a.phone)||"",password:"",avatar:(a==null?void 0:a.avatar)||""}}),c=async n=>{try{const u={...n,avatar:o||void 0};await t(u)}catch(u){throw u}};return e.jsx(Na,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(c),className:"space-y-6",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Aa,{currentAvatar:o||void 0,name:r.watch("name")||"User",onAvatarChange:i})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6",children:[e.jsx(y,{control:r.control,name:"name",render:({field:n})=>e.jsxs(N,{children:[e.jsx(w,{children:"Full Name"}),e.jsx(b,{children:e.jsx(E,{placeholder:"Enter full name",...n})}),e.jsx(A,{})]})}),e.jsx(y,{control:r.control,name:"email",render:({field:n})=>e.jsxs(N,{children:[e.jsx(w,{children:"Email Address"}),e.jsx(b,{children:e.jsx(E,{type:"email",placeholder:"Enter email address",...n})}),e.jsx(A,{})]})}),e.jsx(y,{control:r.control,name:"role",render:({field:n})=>e.jsxs(N,{children:[e.jsx(w,{children:"Role"}),e.jsxs(B,{onValueChange:n.onChange,defaultValue:n.value,children:[e.jsx(b,{children:e.jsx(G,{children:e.jsx(H,{placeholder:"Select role"})})}),e.jsxs(W,{children:[e.jsx(C,{value:"admin",children:"Admin"}),e.jsx(C,{value:"procurement_manager",children:"Procurement Manager"}),e.jsx(C,{value:"procurement_engineer",children:"Procurement Engineer"}),e.jsx(C,{value:"viewer",children:"Viewer"})]})]}),e.jsx(A,{})]})}),e.jsx(y,{control:r.control,name:"department",render:({field:n})=>e.jsxs(N,{children:[e.jsx(w,{children:"Department"}),e.jsx(b,{children:e.jsx(E,{placeholder:"Enter department",...n})}),e.jsx(A,{})]})}),e.jsx(y,{control:r.control,name:"status",render:({field:n})=>e.jsxs(N,{children:[e.jsx(w,{children:"Status"}),e.jsxs(B,{onValueChange:n.onChange,defaultValue:n.value,children:[e.jsx(b,{children:e.jsx(G,{children:e.jsx(H,{placeholder:"Select status"})})}),e.jsxs(W,{children:[e.jsx(C,{value:"active",children:"Active"}),e.jsx(C,{value:"inactive",children:"Inactive"}),e.jsx(C,{value:"suspended",children:"Suspended"})]})]}),e.jsx(A,{})]})}),e.jsx(y,{control:r.control,name:"phone",render:({field:n})=>e.jsxs(N,{children:[e.jsx(w,{children:"Phone Number"}),e.jsx(b,{children:e.jsx(E,{placeholder:"Enter phone number",...n})}),e.jsx(A,{})]})}),!a&&e.jsx(y,{control:r.control,name:"password",render:({field:n})=>e.jsxs(N,{className:"md:col-span-2",children:[e.jsx(w,{children:"Temporary Password"}),e.jsx(b,{children:e.jsx(E,{type:"password",placeholder:"Enter temporary password",...n})}),e.jsx(A,{}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Leave empty to use default password (TempPassword123!). User should change it on first login."})]})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3 pt-4",children:[e.jsx(_,{type:"button",variant:"outline",onClick:s,className:"w-full sm:w-auto",children:"Cancel"}),e.jsx(_,{type:"submit",disabled:r.formState.isSubmitting,className:"w-full sm:w-auto",children:r.formState.isSubmitting?a?"Updating...":"Creating...":a?"Update User":"Create User"})]})]})})}function Qa({isFormOpen:a,setIsFormOpen:t,isDeleteDialogOpen:s,setIsDeleteDialogOpen:o,editingUser:i,onFormSubmit:r,onFormCancel:c,onConfirmDelete:n,canModify:u,isDeleting:m}){return e.jsxs(e.Fragment,{children:[e.jsx(ha,{open:a,onOpenChange:t,children:e.jsxs(ga,{className:"max-w-2xl",children:[e.jsxs(fa,{children:[e.jsx(ja,{children:i?"Edit User":"Add New User"}),e.jsx(va,{children:i?"Update user information and permissions.":"Create a new user account with the required information."})]}),e.jsx(Va,{user:i||void 0,onSubmit:r,onCancel:c})]})}),e.jsx(Ia,{open:s,onOpenChange:o,children:e.jsxs(ve,{children:[e.jsxs(ye,{children:[e.jsx(we,{children:"Are you sure?"}),e.jsx(be,{children:"This action cannot be undone. This will permanently delete the user account and remove all associated data."})]}),e.jsxs(Ne,{children:[e.jsx(De,{children:"Cancel"}),u&&e.jsx(Ae,{onClick:n,disabled:m,children:"Delete"})]})]})})]})}function za(){const{toast:a}=ze(),t=Ke(),s=L({mutationFn:async r=>{console.log("Creating new user with data:",r);const c=r.password||"TempPassword123!",{data:n,error:u}=await Be.auth.signUp({email:r.email,password:c,options:{emailRedirectTo:`${window.location.origin}/`,data:{full_name:r.name}}});if(u)throw console.error("Error creating user:",u),new Error(u.message);if(console.log("User created:",n.user),n.user){await new Promise(m=>setTimeout(m,2e3));try{await k.update(n.user.id,{full_name:r.name,role:r.role,phone:r.phone,avatar_url:r.avatar}),console.log("Profile updated with additional data")}catch(m){console.warn("Could not update additional profile data:",m)}}return n.user},onSuccess:()=>{t.invalidateQueries({queryKey:["users"]}),t.invalidateQueries({queryKey:["userProfile"]}),a({title:"User created",description:"The new user has been successfully created. They will receive a confirmation email."})},onError:r=>{console.error("Create user mutation error:",r),a({title:"Error",description:r.message||"Failed to create user. Please check the email and try again.",variant:"destructive"})}}),o=L({mutationFn:async({id:r,userData:c})=>{console.log("Updating user with ID:",r,"Data:",c);const n={full_name:c.name,email:c.email,role:c.role,phone:c.phone,avatar_url:c.avatar};console.log("Mapped update data:",n);const u=await k.update(r,n);return console.log("Update result:",u),u},onSuccess:r=>{console.log("User update successful:",r),t.invalidateQueries({queryKey:["users"]}),t.invalidateQueries({queryKey:["userProfile"]}),t.invalidateQueries({queryKey:["auth"]}),t.refetchQueries({queryKey:["users"]}),a({title:"User updated",description:"The user has been successfully updated."})},onError:r=>{console.error("Update user mutation error:",r),a({title:"Error",description:r.message||"Failed to update user",variant:"destructive"})}}),i=L({mutationFn:async r=>await k.delete(r),onSuccess:()=>{t.invalidateQueries({queryKey:["users"]}),t.invalidateQueries({queryKey:["userProfile"]}),a({title:"User profile deleted",description:"The user profile has been successfully deleted."})},onError:r=>{console.error("Delete user mutation error:",r),a({title:"Error",description:r.message||"Failed to delete user",variant:"destructive"})}});return{createUserMutation:s,updateUserMutation:o,deleteUserMutation:i}}function Ka(){const a=Ge(),{profile:t}=He(),{canManageUsers:s}=We(),{createUserMutation:o,updateUserMutation:i,deleteUserMutation:r}=za(),[c,n]=d.useState(null),[u,m]=d.useState(!1),[f,S]=d.useState(!1),[M,U]=d.useState(!1),[l,T]=d.useState(null),[O,R]=d.useState(null),{data:Ce=[],isLoading:Se}=Ye({queryKey:["users"],queryFn:async()=>(await k.getAll()).map(x=>({id:x.id,name:x.full_name||"",email:x.email||"",role:x.role,phone:x.phone||"",department:"General",status:"active",createdAt:x.created_at,lastLogin:x.last_login,avatar:x.avatar_url})),staleTime:0,refetchOnWindowFocus:!0});Je.useEffect(()=>{var p;(p=a.state)!=null&&p.editUser&&(R(a.state.editUser),m(!0))},[a.state]);const Ue=()=>{R(null),m(!0)},I=p=>{R(p),m(!0),S(!1)},Te=p=>{n(p),S(!0)},Ee=p=>{T(p),U(!0)},_e=()=>{l&&r.mutate(l),U(!1),T(null)},Pe=async p=>{try{O?await i.mutateAsync({id:O.id,userData:p}):await o.mutateAsync(p),m(!1),R(null)}catch{}},Re=()=>{m(!1),R(null)},Fe=()=>{S(!1),n(null)};return f&&c?e.jsx(ta,{user:c,onBack:Fe,onEdit:s?I:()=>{}}):e.jsxs(e.Fragment,{children:[e.jsx(Ca,{users:Ce,onAdd:s?Ue:void 0,onEdit:s?I:void 0,onDelete:s?Ee:void 0,onView:Te,loading:Se,canModify:s}),e.jsx(Qa,{isFormOpen:u,setIsFormOpen:m,isDeleteDialogOpen:M,setIsDeleteDialogOpen:U,editingUser:O,onFormSubmit:Pe,onFormCancel:Re,onConfirmDelete:_e,canModify:s,isDeleting:r.isPending})]})}function ut(){return e.jsx(Da,{permission:"manage_users",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"User Management"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage user accounts, roles, and permissions for your organization."})]}),e.jsx(Ka,{})]})})}export{ut as Users};
