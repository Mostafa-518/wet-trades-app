import{m as v,a1 as f,n as y,a4 as b,a2 as R,j as a,C as l,a as c,b as d,c as m,s as u,B as N}from"./index-CUi0-ZAd.js";import{U as g}from"./userService-DCmGY_gB.js";import{P as w}from"./PermissionGuard-DBI3Qweg.js";const C={read:"View Data",create:"Create Records",update:"Update Records",delete:"Delete Records",manage_users:"Manage Users",view_reports:"View Reports",manage_projects:"Manage Projects",manage_subcontractors:"Manage Subcontractors",manage_trades:"Manage Trades",manage_responsibilities:"Manage Responsibilities",manage_subcontracts:"Manage Subcontracts"};function P(){const{toast:i}=v(),o=f(),{profile:t}=y(),{data:p=[],isLoading:x}=b({queryKey:["users"],queryFn:async()=>(await g.getAll()).map(s=>({id:s.id,name:s.full_name||"",email:s.email||"",role:s.role,phone:s.phone||"",department:"General",status:"active",createdAt:s.created_at,lastLogin:s.last_login,avatar:s.avatar_url}))}),r=R({mutationFn:async({userId:e,role:s})=>{console.log("=== Role Update Started ==="),console.log("Updating user role:",{userId:e,role:s});try{const n=await g.update(e,{role:s});return console.log("Role update service result:",n),n}catch(n){throw console.error("Role update service error:",n),n}},onSuccess:(e,s)=>{console.log("=== Role Update Success ==="),console.log("Role update successful:",e),console.log("Variables:",s),o.invalidateQueries({queryKey:["users"]}),o.invalidateQueries({queryKey:["userProfile"]}),o.refetchQueries({queryKey:["users"]}),i({title:"Role updated",description:`User role has been successfully updated to ${s.role.replace("_"," ")}.`})},onError:e=>{console.error("=== Role Update Error ==="),console.error("Role update error:",e),console.error("Error details:",{message:e==null?void 0:e.message,code:e==null?void 0:e.code,details:e==null?void 0:e.details,hint:e==null?void 0:e.hint}),i({title:"Error",description:e.message||"Failed to update user role. Please check your permissions.",variant:"destructive"})}}),h=(e,s)=>{if(console.log("=== handleRoleChange called ==="),console.log("Role change requested:",{userId:e,newRole:s}),console.log("Current profile:",t),console.log("Is mutation pending?",r.isPending),e===(t==null?void 0:t.id)){console.log("Blocking self-role modification"),i({title:"Error",description:"You cannot modify your own role",variant:"destructive"});return}console.log("Calling mutation with:",{userId:e,role:s}),r.mutate({userId:e,role:s})},_=e=>({admin:["read","create","update","delete","manage_users","view_reports","manage_projects","manage_subcontractors","manage_trades","manage_responsibilities","manage_subcontracts"],procurement_manager:["read","create","update","delete","view_reports","manage_projects","manage_subcontractors","manage_trades","manage_responsibilities","manage_subcontracts"],procurement_engineer:["read","create","update","delete","view_reports","manage_subcontractors","manage_trades","manage_responsibilities","manage_subcontracts"],viewer:["read","view_reports"]})[e]||[];return x?a.jsx("div",{children:"Loading..."}):a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{children:[a.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Role & Permission Management"}),a.jsx("p",{className:"text-muted-foreground",children:"Manage user roles and their associated permissions."})]}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:["admin","procurement_manager","procurement_engineer","viewer"].map(e=>a.jsxs(l,{children:[a.jsx(c,{children:a.jsx(d,{className:"capitalize",children:e.replace("_"," ")})}),a.jsx(m,{children:a.jsxs("div",{className:"space-y-2",children:[a.jsx("div",{className:"text-sm font-medium",children:"Permissions:"}),a.jsx("div",{className:"flex flex-wrap gap-1",children:_(e).map(s=>a.jsx(u,{variant:"secondary",className:"text-xs",children:C[s]},s))})]})})]},e))}),a.jsxs(l,{children:[a.jsx(c,{children:a.jsx(d,{children:"User Role Assignment"})}),a.jsx(m,{children:a.jsx("div",{className:"space-y-4",children:p.map(e=>a.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("div",{className:"font-medium",children:e.name}),a.jsx("div",{className:"text-sm text-muted-foreground",children:e.email})]}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx(u,{variant:e.role==="admin"?"default":e.role==="procurement_manager"||e.role==="procurement_engineer"?"secondary":"outline",children:e.role.replace("_"," ")}),a.jsx("div",{className:"flex gap-2",children:["admin","procurement_manager","procurement_engineer","viewer"].map(s=>{const n=e.id===(t==null?void 0:t.id),j=r.isPending||n;return a.jsx(N,{variant:e.role===s?"default":"outline",size:"sm",onClick:()=>h(e.id,s),disabled:j,title:n?"Cannot modify your own role":void 0,children:s.replace("_"," ")},s)})})]})]},e.id))})})]})]})}function E(){return a.jsx(w,{permission:"manage_users",children:a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Admin Control Panel"}),a.jsx("p",{className:"text-muted-foreground",children:"Manage user roles and control system access permissions."})]}),a.jsx(P,{})]})})}export{E as RoleManagementPage};
