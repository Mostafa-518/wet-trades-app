import{q as be,j as e,B as D,r as v,X as pe,I as $,d as ve,e as _,f as E,h as T,C as V,a as ce,b as le,c as Y,T as Se,g as Ne,u as ye,L as k,S as Z,E as Ce,v as we,w as Ie,i as M,m as q,x as ee,y as Te,s as De,A as Pe,P as ke,k as $e,l as Ee,n as Ae}from"./index-BPW1VvWz.js";import{S as Fe,f as te,P as Me,R as Re,T as Le}from"./SubcontractEditModal-D_PCY77h.js";import{F as ue}from"./file-spreadsheet-DdKk_E2b.js";import{P as re}from"./plus-CSoG-sTs.js";import{S as W,a as H,b as G,c as X,d as K}from"./select-MYwvS03t.js";import{u as J}from"./useSubcontractHelpers-B_sc0bGH.js";import{S as oe}from"./search-Ch82RnhM.js";import{T as ne}from"./TableSelectionCheckbox-Bh5CbQdB.js";import{E as Ve}from"./eye-B-LzYir9.js";import{S as Ye}from"./square-pen-DFR6Yo74.js";import{T as qe}from"./trash-2-BWsomAQA.js";import{f as Oe,a as Be,b as ae,c as Ue,u as ze}from"./useSubcontractFiltering-CToR7nyq.js";import{u as Qe,P as _e}from"./PaginationControls-DRJUmRXk.js";import{S as se}from"./switch-DXEd272X.js";import{I as We}from"./ImportPreviewDialog-Bg3CV-t5.js";import{u as Q,r as He,w as Ge}from"./xlsx-CKN5doRT.js";import{D as he,a as fe,b as ge,c as xe}from"./dialog-IKdgUk5L.js";import"./tabs-B6xfFTeD.js";import"./textarea-CZbeP3TU.js";import"./index-C21_ivdF.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=be("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);function Ke({onCreateNew:a,onFileUpload:t,onDownloadTemplate:s}){return e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Subcontracts"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(D,{variant:"outline",onClick:s,className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4"}),"Download Template"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:t,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",id:"excel-upload"}),e.jsxs(D,{variant:"outline",className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4"}),"Import from Excel"]})]}),a&&e.jsxs(D,{onClick:a,className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4"}),"New Subcontract"]})]})]})}function Je({onSearch:a,subcontracts:t}){const[s,n]=v.useState("contractId"),[c,l]=v.useState(""),[i,r]=v.useState([]),{getProjectName:o,getProjectCode:d,getSubcontractorName:m}=J(),b=[{value:"contractId",label:"Contract ID"},{value:"project",label:"Project Name"},{value:"projectCode",label:"Project Code"},{value:"subcontractor",label:"Subcontractor"},{value:"trade",label:"Trade"},{value:"item",label:"Trade Item"},{value:"status",label:"Status"}],x=v.useMemo(()=>{const f=new Set;return t.forEach(g=>{switch(s){case"contractId":g.contractId&&f.add(g.contractId);break;case"project":const S=o(g.project);S&&f.add(S);break;case"projectCode":const u=d(g.project);u&&f.add(u);break;case"subcontractor":const N=m(g.subcontractor);N&&f.add(N);break;case"trade":g.tradeItems&&g.tradeItems.length>0&&g.tradeItems.forEach(w=>{w.trade&&f.add(w.trade)});break;case"item":g.tradeItems&&g.tradeItems.length>0&&g.tradeItems.forEach(w=>{w.item&&f.add(w.item)});break;case"status":g.status&&f.add(g.status);break}}),Array.from(f).sort()},[s,t,o,d,m]),p=()=>{if(c.trim()){const f=[...i,{field:s,value:c.trim()}];r(f),l(""),a(f)}},h=f=>{const g=i.filter((S,u)=>u!==f);r(g),a(g)},j=()=>{r([]),l(""),a([])},C=f=>{n(f),l("")};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Search Field"}),e.jsxs(W,{value:s,onValueChange:C,children:[e.jsx(H,{children:e.jsx(G,{})}),e.jsx(X,{children:b.map(f=>e.jsx(K,{value:f.value,children:f.label},f.value))})]})]}),e.jsxs("div",{className:"flex-2",children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Value"}),e.jsxs(W,{value:c,onValueChange:l,children:[e.jsx(H,{children:e.jsx(G,{placeholder:"Select or type a value..."})}),e.jsx(X,{children:x.map(f=>e.jsx(K,{value:f,children:f},f))})]})]}),e.jsx(D,{onClick:p,disabled:!c.trim(),children:"Add Condition"})]}),i.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("strong",{className:"text-sm",children:"Active Search Conditions:"}),e.jsx(D,{variant:"outline",size:"sm",onClick:j,children:"Clear All"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:i.map((f,g)=>{var S;return e.jsxs("div",{className:"inline-flex items-center gap-1 bg-blue-100 text-blue-800 rounded-full px-3 py-1 text-sm",children:[e.jsxs("span",{className:"font-medium",children:[(S=b.find(u=>u.value===f.field))==null?void 0:S.label,":"]}),e.jsx("span",{children:f.value}),e.jsx("button",{onClick:()=>h(g),className:"ml-1 hover:bg-blue-200 rounded-full p-0.5",children:e.jsx(pe,{className:"h-3 w-3"})})]},g)})})]})]})}function Ze({searchTerm:a,onSimpleSearch:t,onAdvancedSearch:s,subcontracts:n}){const[c,l]=v.useState(!1);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("div",{className:"relative max-w-md flex-1",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx($,{placeholder:"Search by Contract ID, Project, Project Code, Trade, Item, or Subcontractor...",value:a,onChange:i=>t(i.target.value),className:"pl-10"})]}),e.jsx(D,{variant:"outline",onClick:()=>l(!c),children:"Advanced Search"})]}),c&&e.jsx(Je,{onSearch:s,subcontracts:n})]})}function et({allSelected:a,onToggleAll:t}){return e.jsx(ve,{children:e.jsxs(_,{children:[e.jsx(E,{children:e.jsx(ne,{checked:a,onCheckedChange:t,ariaLabel:"Select all subcontracts"})}),e.jsx(E,{children:"Contract ID"}),e.jsx(E,{children:"Date of Issuing"}),e.jsx(E,{children:"Project Name"}),e.jsx(E,{children:"Subcontractor Company"}),e.jsx(E,{children:"Trades"}),e.jsx(E,{children:"Items"}),e.jsx(E,{children:"QTY"}),e.jsx(E,{children:"Rate"}),e.jsx(E,{children:"Total Amount"}),e.jsx(E,{children:"Responsibilities"}),e.jsx(E,{children:"Actions"})]})})}function me({contractId:a,onView:t,onEdit:s,onDelete:n}){return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>t(a),children:e.jsx(Ve,{className:"h-4 w-4"})}),e.jsx(D,{variant:"ghost",size:"sm",onClick:s,children:e.jsx(Ye,{className:"h-4 w-4"})}),e.jsx(D,{variant:"ghost",size:"sm",onClick:n,children:e.jsx(qe,{className:"h-4 w-4"})})]})}const tt=v.memo(function({contract:t,isSelected:s,getProjectName:n,getSubcontractorName:c,onToggleOne:l,onViewDetail:i,onEdit:r,onDelete:o}){const d=v.useMemo(()=>n(t.project),[n,t.project]),m=v.useMemo(()=>c(t.subcontractor),[c,t.subcontractor]),b=v.useMemo(()=>Oe(t.dateOfIssuing),[t.dateOfIssuing]),x=v.useMemo(()=>Be(t.responsibilities),[t.responsibilities]),p=v.useMemo(()=>ae(t.totalValue??0),[t.totalValue]),h=v.useCallback(()=>l(t.id),[l,t.id]),j=v.useCallback(()=>i(t.id),[i,t.id]),C=v.useCallback(()=>r(t),[r,t]),f=v.useCallback(async()=>{try{await o(t.id)}catch{}},[o,t.id]);return t.tradeItems&&t.tradeItems.length>0?e.jsx(e.Fragment,{children:t.tradeItems.map((g,S)=>e.jsxs(_,{className:"cursor-pointer hover:bg-muted/50",onClick:j,children:[S===0&&e.jsxs(e.Fragment,{children:[e.jsx(T,{rowSpan:t.tradeItems.length,onClick:u=>u.stopPropagation(),children:e.jsx(ne,{checked:s,onCheckedChange:h,ariaLabel:`Select contract ${t.contractId}`})}),e.jsx(T,{rowSpan:t.tradeItems.length,className:"font-medium text-blue-600",children:t.contractId}),e.jsx(T,{rowSpan:t.tradeItems.length,children:b}),e.jsx(T,{rowSpan:t.tradeItems.length,children:d}),e.jsx(T,{rowSpan:t.tradeItems.length,children:m})]}),e.jsx(T,{children:g.trade||"-"}),e.jsx(T,{children:g.item||"-"}),e.jsxs(T,{className:"text-right",children:[g.quantity??"-"," ",g.unit||""]}),e.jsx(T,{className:"text-right",children:ae(g.unitPrice??0)}),e.jsx(T,{className:"text-right font-medium",children:ae(Ue(g.quantity??0,g.unitPrice??0))}),S===0&&e.jsxs(e.Fragment,{children:[e.jsx(T,{rowSpan:t.tradeItems.length,children:x}),e.jsx(T,{rowSpan:t.tradeItems.length,onClick:u=>u.stopPropagation(),children:e.jsx(me,{contractId:t.id,onView:j,onEdit:C,onDelete:f})})]})]},`${t.id}-${g.id}`))}):e.jsxs(_,{className:"cursor-pointer hover:bg-muted/50",onClick:j,children:[e.jsx(T,{onClick:g=>g.stopPropagation(),children:e.jsx(ne,{checked:s,onCheckedChange:h,ariaLabel:`Select contract ${t.contractId}`})}),e.jsx(T,{className:"font-medium text-blue-600",children:t.contractId}),e.jsx(T,{children:b}),e.jsx(T,{children:d}),e.jsx(T,{children:m}),e.jsx(T,{className:"text-muted-foreground",children:"-"}),e.jsx(T,{className:"text-muted-foreground",children:"-"}),e.jsx(T,{className:"text-muted-foreground",children:"-"}),e.jsx(T,{className:"text-muted-foreground",children:"-"}),e.jsx(T,{className:"text-right font-medium",children:p}),e.jsx(T,{children:x}),e.jsx(T,{onClick:g=>g.stopPropagation(),children:e.jsx(me,{contractId:t.id,onView:j,onEdit:C,onDelete:f})})]},t.id)});function at({searchTerm:a,showAdvancedSearch:t}){return e.jsx(_,{children:e.jsx(T,{colSpan:12,className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:a||t?"No subcontracts found matching your search.":"No subcontracts found."})})})}function st({filteredData:a,selectedIds:t,searchTerm:s,showAdvancedSearch:n,allSelected:c,getProjectName:l,getSubcontractorName:i,onToggleAll:r,onToggleOne:o,onViewDetail:d,onEdit:m,onDelete:b,onBulkDelete:x}){const{currentPage:p,totalPages:h,paginatedData:j,goToPage:C,hasNextPage:f,hasPreviousPage:g,totalItems:S,itemsPerPage:u}=Qe({data:a,itemsPerPage:5});return e.jsxs(V,{children:[e.jsx(ce,{children:e.jsxs(le,{children:["Subcontracts (",a.length,")"]})}),e.jsxs(Y,{className:"space-y-4",children:[e.jsx(_e,{currentPage:p,totalPages:h,onPageChange:C,hasNextPage:f,hasPreviousPage:g,totalItems:S,itemsPerPage:u}),t.size>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2",children:[e.jsxs("span",{className:"font-medium",children:[t.size," selected"]}),e.jsx(D,{variant:"destructive",size:"sm",onClick:x,className:"ml-2",children:"Delete Selected"})]}),e.jsx("div",{className:"border rounded-lg overflow-auto",children:e.jsxs(Se,{children:[e.jsx(et,{allSelected:c,onToggleAll:r}),e.jsx(Ne,{children:j.length===0?e.jsx(at,{searchTerm:s,showAdvancedSearch:n}):j.map(N=>e.jsx(tt,{contract:N,isSelected:t.has(N.id),getProjectName:l,getSubcontractorName:i,onToggleOne:o,onViewDetail:d,onEdit:m,onDelete:b},N.id))})]})})]})]})}function rt({filteredData:a}){const{formValues:t,getSwitchProps:s}=ye({showCurrency:!0,compactView:!1},{customKey:"subcontract-summary-settings"}),n=i=>t.showCurrency?new Intl.NumberFormat("en-US",{style:"currency",currency:"EGP",minimumFractionDigits:0}).format(i):i.toLocaleString(),c=a.reduce((i,r)=>i+r.totalValue,0),l=a.filter(i=>i.status==="active").length;return t.compactView?e.jsx(V,{className:"p-2",children:e.jsx(Y,{className:"p-2",children:e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("span",{children:[a.length," Contracts"]}),e.jsx("span",{className:"font-semibold text-green-600",children:n(c)}),e.jsxs("span",{children:[l," Active"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{...s("compactView")}),e.jsx(k,{className:"text-xs",children:"Compact"})]})]})})}):e.jsxs(V,{children:[e.jsx(ce,{children:e.jsxs(le,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Contract Summary"}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{...s("showCurrency")}),e.jsx(k,{children:"Show Currency"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{...s("compactView")}),e.jsx(k,{children:"Compact View"})]})]})]})}),e.jsx(Y,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold",children:a.length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total Contracts"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:n(c)}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total Value"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:l}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Active Contracts"})]})]})})]})}function ot({size:a="md",text:t="Loading...",className:s=""}){const n={sm:"h-4 w-4",md:"h-8 w-8",lg:"h-12 w-12"};return e.jsxs("div",{className:`flex flex-col items-center justify-center space-y-3 ${s}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:`animate-spin rounded-full border-2 border-primary border-t-transparent ${n[a]}`}),e.jsx("div",{className:`absolute inset-0 rounded-full border-2 border-muted ${n[a]}`})]}),t&&e.jsx("p",{className:"text-sm text-muted-foreground animate-pulse",children:t})]})}function nt(){return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsx(V,{className:"w-full max-w-sm",children:e.jsxs(Y,{className:"p-8",children:[e.jsx(ot,{size:"lg",text:"Processing import...",className:"py-4"}),e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsx(Z,{className:"h-2 w-full"}),e.jsx(Z,{className:"h-2 w-3/4"}),e.jsx(Z,{className:"h-2 w-1/2"})]})]})})})}function ct({tableName:a,onRetry:t}){const s=()=>{t?t():window.location.reload()};return e.jsx(V,{className:"my-4",children:e.jsxs(Y,{className:"p-8 text-center",children:[e.jsx(we,{className:"h-8 w-8 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"font-medium mb-2",children:"Table Error"}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:[a?`The ${a} table`:"This table"," failed to load. Please try refreshing."]}),e.jsxs(D,{onClick:s,variant:"outline",size:"sm",className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-4 w-4"}),"Retry"]})]})})}function lt({children:a,tableName:t,onRetry:s}){return e.jsx(Ce,{fallback:e.jsx(ct,{tableName:t,onRetry:s}),children:a})}function it(){const{getProjectName:a,getProjectCode:t,getSubcontractorName:s}=J();return{checkBasicFieldsMatch:(r,o)=>{const d=a(r.project),m=t(r.project),b=s(r.subcontractor);return r.contractId.toLowerCase().includes(o)||d.toLowerCase().includes(o)||m.toLowerCase().includes(o)||b.toLowerCase().includes(o)},checkResponsibilitiesMatch:(r,o)=>r.responsibilities&&r.responsibilities.length>0&&r.responsibilities.some(d=>d&&d.toLowerCase().includes(o)),checkTradeItemsMatch:(r,o)=>r.tradeItems&&r.tradeItems.length>0&&r.tradeItems.some(d=>{const m=d.trade&&d.trade.toLowerCase().includes(o),b=d.item&&d.item.toLowerCase().includes(o);return m||b}),evaluateAdvancedCondition:(r,o)=>{const d=a(r.project),m=t(r.project),b=s(r.subcontractor),x=o.value.toLowerCase();switch(o.field){case"contractId":return r.contractId.toLowerCase().includes(x);case"project":return d.toLowerCase().includes(x);case"projectCode":return m.toLowerCase().includes(x);case"subcontractor":return b.toLowerCase().includes(x);case"trade":return r.tradeItems&&r.tradeItems.length>0&&r.tradeItems.some(p=>p.trade&&p.trade.toLowerCase().includes(x));case"item":return r.tradeItems&&r.tradeItems.length>0&&r.tradeItems.some(p=>p.item&&p.item.toLowerCase().includes(x));case"responsibilities":return r.responsibilities&&r.responsibilities.length>0&&r.responsibilities.some(p=>p&&p.toLowerCase().includes(x));case"status":return r.status.toLowerCase().includes(x);default:return!1}}}}function dt(){return{filterTradeItems:(s,n,c,l)=>{if(!s.tradeItems||s.tradeItems.length===0)return s;let i=s.tradeItems;return(c||l)&&(i=s.tradeItems.filter(r=>c?r.trade&&r.trade.toLowerCase().includes(n):l?r.item&&r.item.toLowerCase().includes(n):!1)),{...s,tradeItems:i}},filterTradeItemsForAdvancedSearch:(s,n,c,l,i)=>{let r=s.tradeItems||[];return n&&c?r=r.filter(o=>{const d=o.trade&&o.trade.toLowerCase().includes(l),m=o.item&&o.item.toLowerCase().includes(i);return d&&m}):n?r=r.filter(o=>o.trade&&o.trade.toLowerCase().includes(l)):c&&(r=r.filter(o=>o.item&&o.item.toLowerCase().includes(i))),{...s,tradeItems:r}}}}function ut(a){const[t,s]=v.useState(""),[n,c]=v.useState(a),[l,i]=v.useState([]),{checkBasicFieldsMatch:r,checkResponsibilitiesMatch:o,checkTradeItemsMatch:d,evaluateAdvancedCondition:m}=it(),{filterTradeItems:b,filterTradeItemsForAdvancedSearch:x}=dt();v.useEffect(()=>{l.length>0?h(l):t.trim()?p(t):c(a)},[a]);const p=j=>{if(s(j),i([]),!j.trim()){c(a);return}const C=j.toLowerCase(),f=a.map(g=>{const S=r(g,C),u=d(g,C),N=o(g,C);return S||N?g:u?b(g,C,!0,!0):null}).filter(Boolean);c(f)},h=j=>{if(i(j),s(""),j.length===0){c(a);return}const C=a.map(f=>{let g=!1,S=!1,u="",N="";return j.every(P=>{switch(P.field){case"trade":return g=!0,u=P.value.toLowerCase(),m(f,P);case"item":return S=!0,N=P.value.toLowerCase(),m(f,P);default:return m(f,P)}})?g||S?x(f,g,S,u,N):f:null}).filter(Boolean);c(C)};return{searchTerm:t,filteredData:n,handleSimpleSearch:p,handleAdvancedSearch:h}}function mt(a,t){const[s,n]=v.useState(new Set),c=a.length>0&&a.every(o=>s.has(o.id));return{selectedIds:s,allSelected:c,toggleAll:()=>{n(c?new Set:new Set(a.map(o=>o.id)))},toggleOne:o=>{n(d=>{const m=new Set(d);return m.has(o)?m.delete(o):m.add(o),m})},handleBulkDelete:async()=>{try{await t(Array.from(s)),n(new Set)}catch{}}}}function pt(a){const[t,s]=v.useState(null),[n,c]=v.useState(!1);return{editingSubcontract:t,showAdvancedSearch:n,handleEdit:r=>{s(r)},handleSaveEdit:async(r,o)=>{await a(r,o),s(null)},setEditingSubcontract:s,setShowAdvancedSearch:c}}function ht(a){const{subcontracts:t,updateSubcontract:s,deleteSubcontract:n,deleteManySubcontracts:c,isLoading:l}=M(),{getProjectName:i,getProjectCode:r,getSubcontractorName:o}=J(),d=ze(t,a),{searchTerm:m,filteredData:b,handleSimpleSearch:x,handleAdvancedSearch:p}=ut(d),{selectedIds:h,allSelected:j,toggleAll:C,toggleOne:f,handleBulkDelete:g}=mt(b,c),{editingSubcontract:S,showAdvancedSearch:u,handleEdit:N,handleSaveEdit:w,setEditingSubcontract:P,setShowAdvancedSearch:A}=pt(s);return v.useMemo(()=>({subcontracts:d,filteredData:b,searchTerm:m,showAdvancedSearch:u,editingSubcontract:S,selectedIds:h,allSelected:j,isLoading:l,getProjectName:i,getProjectCode:r,getSubcontractorName:o,handleSimpleSearch:x,handleAdvancedSearch:p,handleEdit:N,handleSaveEdit:w,toggleAll:C,toggleOne:f,handleBulkDelete:g,deleteSubcontract:n,setEditingSubcontract:P,setShowAdvancedSearch:A}),[d,b,m,u,S,h,j,l,i,r,o,x,p,N,w,C,f,g,n,P,A])}const ft=async a=>{console.log("Starting to parse Excel file:",a.name,a.size);try{const t=await a.arrayBuffer(),s=He(t,{type:"array"});if(!s.SheetNames||s.SheetNames.length===0)throw new Error("No worksheets found in the Excel file");const n=s.SheetNames[0],c=s.Sheets[n];console.log("Raw worksheet:",c);const l=Q.sheet_to_json(c,{header:1,defval:"",raw:!1});if(console.log("Raw data as arrays:",l),!l||l.length===0)throw new Error("No data found in the Excel file");return l}catch(t){throw console.error("Error parsing Excel file:",t),new Error(`Failed to parse Excel file: ${t instanceof Error?t.message:"Unknown error"}`)}},gt=a=>(console.log("Validating Excel file:",a.name,a.type,a.size),[".xlsx",".xls"].some(n=>a.name.toLowerCase().endsWith(n))?a.size>10*1024*1024?"Please upload a file smaller than 10MB":a.size===0?"The uploaded file is empty":null:"Please upload an Excel file (.xlsx or .xls)"),xt=a=>{try{const t=Q.json_to_sheet(a),s=Q.book_new();return Q.book_append_sheet(s,t,"Subcontracts"),s}catch(t){throw console.error("Error creating Excel template:",t),new Error("Failed to create Excel template")}},jt=a=>(console.log("Mapping raw data rows:",a),a.filter(t=>{const s=t&&t.length>0&&t.some(n=>n&&String(n).trim());return console.log("Row has data:",s,t),s}).map((t,s)=>{console.log(`Processing row ${s+1}:`,t);const n={};return n["Date of Issuing"]=t[0]?String(t[0]).trim():"",n["Project Name"]=t[1]?String(t[1]).trim():"",n["Subcontractor Company"]=t[2]?String(t[2]).trim():"",n["Type of contract"]=t[3]?String(t[3]).trim():"",n.Trades=t[4]?String(t[4]).trim():"",n.Items=t[5]?String(t[5]).trim():"",n.QTY=t[6]?isNaN(Number(t[6]))?0:Number(t[6]):0,n.Rate=t[7]?isNaN(Number(t[7]))?0:Number(t[7]):0,n.wastage=t[8]?isNaN(Number(t[8]))?0:Number(t[8]):0,n.Responsibilities=t[9]?String(t[9]).trim():"",console.log(`Mapped row ${s+1}:`,n),n})),bt=a=>{console.log("Processing merged cells for data:",a);const t=[];let s={"Date of Issuing":"","Project Name":"","Subcontractor Company":"","Type of contract":""};for(let n=0;n<a.length;n++){const c=a[n];console.log(`Processing merged cells for row ${n+1}:`,c);const l={"Date of Issuing":c["Date of Issuing"]||s["Date of Issuing"],"Project Name":c["Project Name"]||s["Project Name"],"Subcontractor Company":c["Subcontractor Company"]||s["Subcontractor Company"],"Type of contract":c["Type of contract"]||s["Type of contract"],Trades:c.Trades||"",Items:c.Items||"",QTY:c.QTY||0,Rate:c.Rate||0,wastage:c.wastage||0,Responsibilities:c.Responsibilities||""};c["Date of Issuing"]&&(s["Date of Issuing"]=c["Date of Issuing"]),c["Project Name"]&&(s["Project Name"]=c["Project Name"]),c["Subcontractor Company"]&&(s["Subcontractor Company"]=c["Subcontractor Company"]),c["Type of contract"]&&(s["Type of contract"]=c["Type of contract"]),l.Trades||l.Items||l["Project Name"]?(t.push(l),console.log(`Added processed row ${n+1}:`,l)):console.log(`Skipped empty row ${n+1}`)}return console.log("Final processed data:",t),t},vt=a=>{const t={};return a.forEach((s,n)=>{console.log(`Grouping row ${n+1}:`,s);const c=`${s["Date of Issuing"]}_${s["Project Name"]}_${s["Subcontractor Company"]}_${s["Type of contract"]}`;t[c]||(t[c]=[]),t[c].push(s)}),console.log("Grouped contracts:",t),t},St=(a,t)=>{const s=[];console.log(`Validating row ${t}:`,a),(a["Project Name"]||a["Subcontractor Company"]||a["Type of contract"])&&((!a["Project Name"]||!a["Project Name"].trim())&&s.push("Project Name is required"),(!a["Subcontractor Company"]||!a["Subcontractor Company"].trim())&&s.push("Subcontractor Company is required"),(!a["Type of contract"]||!a["Type of contract"].trim())&&s.push("Type of contract is required")),(a.Trades||a.Items||a.QTY||a.Rate)&&((!a.Trades||!a.Trades.trim())&&s.push("Trades is required when trade data is present"),(!a.Items||!a.Items.trim())&&s.push("Items is required when trade data is present"));const l=a.QTY;if(l!=null&&String(l).trim()!==""){const o=Number(l);isNaN(o)?s.push(`QTY must be a valid number, got: "${l}"`):o<0&&s.push("QTY must be a non-negative number")}const i=a.Rate;if(i!=null&&String(i).trim()!==""){const o=Number(i);isNaN(o)?s.push(`Rate must be a valid number, got: "${i}"`):o<0&&s.push("Rate must be a non-negative number")}const r=a.wastage;if(r!=null&&String(r).trim()!==""){const o=Number(r);isNaN(o)?s.push(`Wastage must be a valid number, got: "${r}"`):(o<0||o>100)&&s.push("Wastage must be a number between 0 and 100")}if(a["Date of Issuing"]&&a["Date of Issuing"].trim()){const o=a["Date of Issuing"].trim(),d=[o,o.replace(/\//g,"-"),o.replace(/\./g,"-"),o.replace(/\s+/g,"-")];let m=!1;for(const b of d){const x=new Date(b);if(!isNaN(x.getTime())&&x.getFullYear()>1900){m=!0;break}}m||s.push(`Date of Issuing must be a valid date, got: "${o}". Try formats like YYYY-MM-DD, MM/DD/YYYY, or DD.MM.YYYY`)}if(a["Type of contract"]&&a["Type of contract"].trim()){const o=a["Type of contract"].trim().toLowerCase(),d=["subcontract","add","addendum"];d.includes(o)||s.push(`Type of contract must be one of: ${d.join(", ")}, got: "${a["Type of contract"]}"`)}return s.length>0&&console.log(`Validation errors for row ${t}:`,s),s},Nt=a=>{const t=[];if(console.log("Validating contract data:",a),(!a["Project Name"]||!a["Project Name"].trim())&&t.push("Project Name is required"),(!a["Subcontractor Company"]||!a["Subcontractor Company"].trim())&&t.push("Subcontractor Company is required"),(!a["Type of contract"]||!a["Type of contract"].trim())&&t.push("Type of contract is required"),a["Date of Issuing"]&&a["Date of Issuing"].trim()){const s=a["Date of Issuing"].trim(),n=[s,s.replace(/\//g,"-"),s.replace(/\./g,"-"),s.replace(/\s+/g,"-")];let c=!1;for(const l of n){const i=new Date(l);if(!isNaN(i.getTime())&&i.getFullYear()>1900){c=!0;break}}c||t.push(`Invalid date format: "${s}". Please use YYYY-MM-DD, MM/DD/YYYY, or DD.MM.YYYY`)}if(a["Type of contract"]&&a["Type of contract"].trim()){const s=a["Type of contract"].trim().toLowerCase(),n=["subcontract","add","addendum"];n.includes(s)||t.push(`Invalid contract type: "${a["Type of contract"]}". Must be one of: ${n.join(", ")}`)}return t.length>0&&console.log("Contract validation errors:",t),t},yt=async(a,t,s,n,c)=>{let l=0,i=0;const r=[],o=new Set;console.log("Starting import process with data:",a),console.log("Available projects:",s.map(m=>({id:m.id,name:m.name,code:m.code}))),console.log("Available subcontractors:",n.map(m=>({id:m.id,name:m.companyName})));const d=vt(a);console.log("Contract groups:",Object.keys(d));for(const[m,b]of Object.entries(d))try{console.log(`Processing contract group: ${m}`);const x=b[0];console.log("Contract row:",x);const p=Nt(x);if(p.length>0){i++,r.push(`Contract "${m}": ${p.join(", ")}`),console.error(`Contract validation failed for ${m}:`,p);continue}const h=x["Project Name"].trim(),j=s.find(y=>y.name&&y.name.toLowerCase().trim()===h.toLowerCase());if(!j){i++;const y=s.map(I=>I.name).join(", ");r.push(`Contract "${m}": Project "${h}" not found. Available projects: ${y}`),console.error(`Project not found: "${h}". Available:`,s.map(I=>I.name));continue}if(!j.code){i++,r.push(`Contract "${m}": Project "${h}" doesn't have a project code required for contract ID generation`),console.error(`Project "${h}" missing code:`,j);continue}const C=x["Subcontractor Company"].trim(),f=n.find(y=>y.companyName&&y.companyName.toLowerCase().trim()===C.toLowerCase());if(!f){i++;const y=n.map(I=>I.companyName).join(", ");r.push(`Contract "${m}": Subcontractor "${C}" not found. Available subcontractors: ${y}`),console.error(`Subcontractor not found: "${C}". Available:`,n.map(I=>I.companyName));continue}console.log(`Found project: ${j.name} (ID: ${j.id}, Code: ${j.code})`),console.log(`Found subcontractor: ${f.companyName} (ID: ${f.id})`);const g=[];let S=!1;const u=[];for(let y=0;y<b.length;y++){const I=b[y];if(console.log(`Processing trade item row ${y+1}:`,I),!I.Trades&&!I.Items&&!I.QTY&&!I.Rate){console.log(`Skipping row ${y+1} - no trade data`);continue}const R=St(I,y+1);if(R.length>0){u.push(`Row ${y+1}: ${R.join(", ")}`),console.error(`Row validation failed for row ${y+1}:`,R);continue}const F=Number(I.QTY)||1,ie=Number(I.Rate)||0,je=Number(I.wastage)||0,de={id:`imported-${Date.now()}-${y}-${Math.random().toString(36).substr(2,9)}`,trade:I.Trades.trim(),item:I.Items.trim(),unit:"unit",quantity:F,unitPrice:ie,total:F*ie,wastagePercentage:je};console.log("Created trade item:",de),g.push(de),S=!0}if(!S){i++;const y=u.length>0?`No valid trade items found. Errors: ${u.join("; ")}`:"No valid trade items found";r.push(`Contract "${m}": ${y}`),console.error(`No valid trade items for contract ${m}. Row errors:`,u);continue}const N=g.reduce((y,I)=>y+I.total,0);console.log(`Total contract value: ${N}`);const w=x.Responsibilities?x.Responsibilities.split(",").map(y=>y.trim()).filter(y=>y.length>0):[];let P=new Date().toISOString().split("T")[0];if(x["Date of Issuing"]&&x["Date of Issuing"].trim()){const y=x["Date of Issuing"].trim(),I=[y,y.replace(/\//g,"-"),y.replace(/\./g,"-"),y.replace(/\s+/g,"-")];for(const R of I){const F=new Date(R);if(!isNaN(F.getTime())&&F.getFullYear()>1900){P=F.toISOString().split("T")[0];break}}}let A="subcontract";if(x["Type of contract"]){const y=x["Type of contract"].trim().toLowerCase();(y==="add"||y==="addendum")&&(A="ADD")}let U=0,O="";const B=100;do{if(U++,U>B)throw new Error(`Failed to generate unique contract ID after ${B} attempts`);O=`TEMP-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}while(o.has(O));o.add(O);const z={project:j.id,subcontractor:f.id,tradeItems:g,responsibilities:w,totalValue:N,status:"draft",startDate:new Date().toISOString().split("T")[0],endDate:new Date(Date.now()+30*24*60*60*1e3).toISOString().split("T")[0],dateOfIssuing:P,description:`Imported ${A==="ADD"?"addendum":"subcontract"} for ${j.name} with ${f.companyName}`,contractType:A,parentSubcontractId:void 0};console.log("Final subcontract data:",z);const L=await t(z);L&&L.contractId&&(o.add(L.contractId),console.log(`Successfully imported contract: ${m} with ID: ${L.contractId}`)),l++}catch(x){i++;const p=x instanceof Error?x.message:"Unknown error";r.push(`Contract "${m}": ${p}`),console.error(`Error importing contract ${m}:`,x)}if(console.log(`Import completed: ${l} success, ${i} errors`),console.log("All errors:",r),l>0&&c({title:"Import completed",description:`Successfully imported ${l} subcontract(s)${i>0?`, ${i} failed`:""}`}),r.length>0){console.error("Import errors:",r);const m=r.slice(0,3).join(`
`),b=r.length>3?`
...and ${r.length-3} more errors`:"";c({title:"Import errors",description:`${i} contracts failed to import:
${m}${b}

Check console for full details.`,variant:"destructive"})}};function Ct(){const[a,t]=v.useState(!1),[s,n]=v.useState([]),[c,l]=v.useState(!1),{toast:i}=q(),{addSubcontract:r,projects:o,subcontractors:d}=M();return{isImporting:a,importData:s,showPreview:c,setShowPreview:l,handleFileUpload:async p=>{var C;const h=(C=p.target.files)==null?void 0:C[0];if(!h){console.log("No file selected");return}console.log("File selected for upload:",h.name,h.size,h.type);const j=gt(h);if(j){console.error("File validation failed:",j),i({title:"Invalid file",description:j,variant:"destructive"});return}try{t(!0),console.log("Starting import process...");const f=await ft(h);if(console.log("Parsed raw data:",f),!f||f.length<=1){console.warn("No data found in file"),i({title:"No data found",description:"The Excel file appears to be empty or contains only headers.",variant:"destructive"});return}const g=f.slice(1);console.log("Data rows after skipping header:",g);const S=jt(g);if(console.log("Mapped data:",S),S.length===0){console.warn("No valid rows found after mapping"),i({title:"No valid data",description:"No valid rows found in the Excel file.",variant:"destructive"});return}const u=bt(S);if(console.log("Processed data with merged cells:",u),u.length===0){console.warn("No valid data after processing merged cells"),i({title:"No valid data",description:"No valid subcontract data found in the file after processing.",variant:"destructive"});return}console.log("Setting import data and showing preview"),n(u),l(!0),i({title:"File processed",description:`Found ${u.length} records ready for import.`})}catch(f){console.error("Error parsing Excel file:",f);const g=f instanceof Error?f.message:"Unknown error occurred";i({title:"Import failed",description:`Failed to parse Excel file: ${g}`,variant:"destructive"})}finally{t(!1),p.target.value=""}},processImport:async p=>{console.log("Starting import process with data:",p),t(!0),l(!1);try{ee(),await yt(p,r,o,d,i),console.log("Import process completed successfully"),ee()}catch(h){console.error("Import processing error:",h);const j=h instanceof Error?h.message:"Unknown error occurred";i({title:"Import failed",description:`An error occurred while processing the import: ${j}`,variant:"destructive"}),ee()}finally{t(!1)}},downloadTemplate:()=>{console.log("Downloading template...");try{const h=xt([{"Date of Issuing":"2024-01-15","Project Name":"Sample Project","Subcontractor Company":"Sample Company","Type of contract":"subcontract",Trades:"Masonry",Items:"Brick Work",QTY:100,Rate:50,wastage:5,Responsibilities:"Material supply, Labor"}]);Ge(h,"subcontract_import_template.xlsx"),i({title:"Template downloaded",description:"Excel template has been downloaded successfully."})}catch(p){console.error("Error downloading template:",p),i({title:"Download failed",description:"Failed to download template file.",variant:"destructive"})}}}}const wt=v.memo(function({onCreateNew:t,onViewDetail:s,reportFilters:n}){const{subcontracts:c,filteredData:l,searchTerm:i,showAdvancedSearch:r,editingSubcontract:o,selectedIds:d,allSelected:m,isLoading:b,getProjectName:x,getProjectCode:p,getSubcontractorName:h,handleSimpleSearch:j,handleAdvancedSearch:C,handleEdit:f,handleSaveEdit:g,toggleAll:S,toggleOne:u,handleBulkDelete:N,deleteSubcontract:w,setEditingSubcontract:P}=ht(n),{isImporting:A,importData:U,showPreview:O,setShowPreview:B,handleFileUpload:z,processImport:L,downloadTemplate:y}=Ct(),I=v.useMemo(()=>[{key:"Date of Issuing",label:"Date of Issuing"},{key:"Project Name",label:"Project Name"},{key:"Subcontractor Company",label:"Subcontractor Company"},{key:"Type of contract",label:"Type of Contract"},{key:"Trades",label:"Trades"},{key:"Items",label:"Items"},{key:"QTY",label:"Quantity"},{key:"Rate",label:"Rate"},{key:"wastage",label:"Wastage %"},{key:"Responsibilities",label:"Responsibilities"}],[]),R=v.useCallback(()=>{P(null)},[P]),F=v.useCallback(()=>{B(!1)},[B]);return b?e.jsx(Te,{}):e.jsx(lt,{tableName:"Subcontracts",onRetry:()=>window.location.reload(),children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ke,{onCreateNew:t,onFileUpload:z,onDownloadTemplate:y}),e.jsx(rt,{filteredData:l}),e.jsx(Ze,{searchTerm:i,onSimpleSearch:j,onAdvancedSearch:C,subcontracts:c}),e.jsx(st,{filteredData:l,selectedIds:d,searchTerm:i,showAdvancedSearch:r,allSelected:m,getProjectName:x,getProjectCode:p,getSubcontractorName:h,onToggleAll:S,onToggleOne:u,onViewDetail:s,onEdit:f,onDelete:w,onBulkDelete:N}),o&&e.jsx(Fe,{subcontract:o,open:!!o,onClose:R,onSave:g}),e.jsx(We,{open:O,onClose:F,data:U,columns:I,onImport:L}),A&&e.jsx(nt,{})]})})});function It({open:a,onClose:t,onProjectCreated:s}){const{addProject:n}=M(),{toast:c}=q(),[l,i]=v.useState({name:"",code:"",location:""}),r=async d=>{if(d.preventDefault(),!l.name||!l.code||!l.location){c({title:"Missing Information",description:"Please fill all required fields",variant:"destructive"});return}try{await n(l),c({title:"Project Created",description:`${l.name} has been created successfully`}),s(l.name),i({name:"",code:"",location:""}),t()}catch{c({title:"Error",description:"Failed to create project",variant:"destructive"})}},o=(d,m)=>{i(b=>({...b,[d]:m}))};return e.jsx(he,{open:a,onOpenChange:t,children:e.jsxs(fe,{className:"max-w-md",children:[e.jsx(ge,{children:e.jsx(xe,{children:"Create New Project"})}),e.jsxs("form",{onSubmit:r,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"project-name",children:"Project Name *"}),e.jsx($,{id:"project-name",value:l.name,onChange:d=>o("name",d.target.value),placeholder:"Enter project name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"project-code",children:"Project Code *"}),e.jsx($,{id:"project-code",value:l.code,onChange:d=>o("code",d.target.value),placeholder:"Enter project code",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"project-location",children:"Location *"}),e.jsx($,{id:"project-location",value:l.location,onChange:d=>o("location",d.target.value),placeholder:"Enter project location",required:!0})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(D,{type:"submit",className:"flex-1",children:"Create Project"}),e.jsx(D,{type:"button",variant:"outline",onClick:t,children:"Cancel"})]})]})]})})}function Tt({open:a,onClose:t,onSubcontractorCreated:s}){const{addSubcontractor:n}=M(),{toast:c}=q(),[l,i]=v.useState({companyName:"",representativeName:"",commercialRegistration:"",taxCardNo:"",email:"",phone:""}),r=async d=>{if(d.preventDefault(),!l.companyName||!l.representativeName||!l.phone){c({title:"Missing Information",description:"Please fill required fields (Company Name, Representative Name, Phone)",variant:"destructive"});return}try{await n(l),c({title:"Subcontractor Created",description:`${l.companyName} has been created successfully`}),s(l.companyName),i({companyName:"",representativeName:"",commercialRegistration:"",taxCardNo:"",email:"",phone:""}),t()}catch{c({title:"Error",description:"Failed to create subcontractor",variant:"destructive"})}},o=(d,m)=>{i(b=>({...b,[d]:m}))};return e.jsx(he,{open:a,onOpenChange:t,children:e.jsxs(fe,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ge,{children:e.jsx(xe,{children:"Create New Subcontractor"})}),e.jsxs("form",{onSubmit:r,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-company",children:"Company Name *"}),e.jsx($,{id:"sub-company",value:l.companyName,onChange:d=>o("companyName",d.target.value),placeholder:"Enter company name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-representative",children:"Representative Name *"}),e.jsx($,{id:"sub-representative",value:l.representativeName,onChange:d=>o("representativeName",d.target.value),placeholder:"Enter representative name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-commercial",children:"Commercial Registration"}),e.jsx($,{id:"sub-commercial",value:l.commercialRegistration,onChange:d=>o("commercialRegistration",d.target.value),placeholder:"Enter commercial registration"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-tax",children:"Tax Card No."}),e.jsx($,{id:"sub-tax",value:l.taxCardNo,onChange:d=>o("taxCardNo",d.target.value),placeholder:"Enter tax card number"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-phone",children:"Phone *"}),e.jsx($,{id:"sub-phone",value:l.phone,onChange:d=>o("phone",d.target.value),placeholder:"Enter phone number",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"sub-email",children:"Email"}),e.jsx($,{id:"sub-email",type:"email",value:l.email,onChange:d=>o("email",d.target.value),placeholder:"Enter email address"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(D,{type:"submit",className:"flex-1",children:"Create Subcontractor"}),e.jsx(D,{type:"button",variant:"outline",onClick:t,children:"Cancel"})]})]})]})})}function Dt({formData:a,setFormData:t}){const{projects:s,subcontractors:n}=M(),[c,l]=v.useState(!1),[i,r]=v.useState(!1),[o,d]=v.useState(""),[m,b]=v.useState(""),x=s.filter(u=>u.id&&u.name&&u.id.trim()!==""&&u.name.trim()!==""),p=n.filter(u=>u.id&&u.companyName&&u.id.trim()!==""&&u.companyName.trim()!==""),h=v.useMemo(()=>{if(!o.trim())return x;const u=o.toLowerCase().split(/\s+/).filter(Boolean);return x.filter(N=>{const w=`${N.name} ${N.code} ${N.location||""}`.toLowerCase();return u.every(P=>w.includes(P))})},[x,o]),j=v.useMemo(()=>{if(!m.trim())return p;const u=m.toLowerCase().split(/\s+/).filter(Boolean);return p.filter(N=>{const w=`${N.companyName} ${N.representativeName||""} ${N.phone||""} ${N.commercialRegistration||""} ${N.taxCardNo||""}`.toLowerCase();return u.every(P=>w.includes(P))})},[p,m]),C=u=>{const N=x.find(w=>w.name===u);N&&t(w=>({...w,project:N.id}))},f=u=>{const N=p.find(w=>w.companyName===u);N&&t(w=>({...w,subcontractor:N.id}))},g=x.find(u=>u.id===a.project),S=p.find(u=>u.id===a.subcontractor);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(k,{htmlFor:"project",children:"Select Project"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx($,{placeholder:"Search by project name or code...",value:o,onChange:u=>d(u.target.value),className:"pl-10"})]}),e.jsxs(W,{value:a.project,onValueChange:u=>t(N=>({...N,project:u})),children:[e.jsx(H,{children:e.jsx(G,{placeholder:"Choose a project...",children:g?g.name:"Choose a project..."})}),e.jsxs(X,{children:[h.map(u=>e.jsx(K,{value:u.id,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:u.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[u.code," • ",u.location]})]})},u.id)),h.length===0&&o&&e.jsxs("div",{className:"px-2 py-3 text-sm text-muted-foreground",children:['No projects found matching "',o,'"']})]})]}),e.jsxs(D,{type:"button",variant:"outline",size:"sm",onClick:()=>l(!0),className:"w-full flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4"}),"Create New Project"]})]})]}),e.jsxs("div",{children:[e.jsx(k,{htmlFor:"subcontractor",children:"Select Subcontractor"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx($,{placeholder:"Search by name, commercial registration, or tax card...",value:m,onChange:u=>b(u.target.value),className:"pl-10"})]}),e.jsxs(W,{value:a.subcontractor,onValueChange:u=>t(N=>({...N,subcontractor:u})),children:[e.jsx(H,{children:e.jsx(G,{placeholder:"Choose a subcontractor...",children:S?S.companyName:"Choose a subcontractor..."})}),e.jsxs(X,{children:[j.map(u=>e.jsx(K,{value:u.id,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:u.companyName}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[u.representativeName," • ",u.phone,u.commercialRegistration&&` • CR: ${u.commercialRegistration}`,u.taxCardNo&&` • Tax: ${u.taxCardNo}`]})]})},u.id)),j.length===0&&m&&e.jsxs("div",{className:"px-2 py-3 text-sm text-muted-foreground",children:['No subcontractors found matching "',m,'"']})]})]}),e.jsxs(D,{type:"button",variant:"outline",size:"sm",onClick:()=>r(!0),className:"w-full flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4"}),"Create New Subcontractor"]})]})]}),e.jsx(It,{open:c,onClose:()=>l(!1),onProjectCreated:C}),e.jsx(Tt,{open:i,onClose:()=>r(!1),onSubcontractorCreated:f})]})}function Pt({formData:a,setFormData:t,totalAmount:s,renderExtraFields:n}){const{getProjectName:c,getSubcontractorName:l}=J();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(k,{htmlFor:"pdfUrl",children:"Contract PDF Link"}),e.jsx("div",{className:"mt-2",children:e.jsx($,{id:"pdfUrl",type:"url",placeholder:"Paste the SharePoint link to the contract PDF",value:a.pdfUrl||"",onChange:i=>t(r=>({...r,pdfUrl:i.target.value}))})})]}),n&&e.jsx("div",{children:n}),e.jsxs("div",{className:"border rounded-lg p-4 space-y-4",children:[e.jsx("h3",{className:"font-semibold",children:"Contract Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Project:"})," ",c(a.project)]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Subcontractor:"})," ",l(a.subcontractor)]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Total Items:"})," ",a.tradeItems.length]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("strong",{children:"Contract Total:"})," ",e.jsx("span",{className:"text-lg font-semibold text-primary",children:te(s)})]})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Trade Items:"}),e.jsx("div",{className:"mt-2 space-y-1",children:a.tradeItems.map(i=>e.jsxs("div",{className:"text-sm bg-muted p-2 rounded",children:[i.trade," - ",i.item,": ",i.quantity," ",i.unit," × ",te(i.unitPrice)," = ",te(i.total)]},i.id))})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Responsibilities:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:a.responsibilities.map(i=>e.jsx(De,{variant:"outline",className:"text-xs",children:i},i))})]})]})]})}function kt({formData:a,setFormData:t}){const{subcontracts:s,projects:n,subcontractors:c}=M(),l=o=>{var d;return((d=n.find(m=>m.id===o))==null?void 0:d.name)||""},i=o=>{var d;return((d=c.find(m=>m.id===o))==null?void 0:d.companyName)||""},r=()=>{if(a.contractType==="ADD"&&a.parentSubcontractId){const o=Array.isArray(s)?s.find(d=>d.id===a.parentSubcontractId):null;if(o){const m=((Array.isArray(s)?s.filter(b=>b.parentSubcontractId===a.parentSubcontractId&&b.contractType==="ADD"):[]).length+1).toString().padStart(2,"0");return`${o.contractId}-ADD${m}`}}return null};return e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-medium mb-1",children:"Type of Contract"}),e.jsxs("select",{className:"border rounded px-3 py-2 w-full",value:a.contractType,onChange:o=>t(d=>({...d,contractType:o.target.value,...o.target.value==="ADD"?{}:{addendumNumber:"",parentSubcontractId:""}})),children:[e.jsx("option",{value:"subcontract",children:"Subcontract"}),e.jsx("option",{value:"ADD",children:"Addendum"})]})]}),a.contractType==="ADD"&&e.jsxs("div",{children:[e.jsx(Me,{subcontracts:Array.isArray(s)?s:[],value:a.parentSubcontractId||"",onChange:o=>t(d=>({...d,parentSubcontractId:o})),getProjectName:l,getSubcontractorName:i}),r()&&e.jsxs("p",{className:"text-sm text-blue-600 mt-1 font-medium",children:["Generated ID will be: ",r()]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Format: [parent-contract-number]-ADDXX (e.g., ID-0504-0001-ADD01)"})]})]})}function $t({steps:a,currentStep:t}){return e.jsx("div",{className:"flex items-center justify-between mt-4",children:a.map((s,n)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium ${n+1<=t?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"}`,children:n+1}),e.jsx("div",{className:`ml-2 text-sm ${n+1===t?"font-medium":"text-muted-foreground"}`,children:s}),n<a.length-1&&e.jsx("div",{className:`mx-4 h-0.5 w-8 ${n+1<t?"bg-primary":"bg-muted"}`})]},n))})}function Et({currentStep:a,stepsCount:t,isSaving:s,onPrev:n,onNext:c,onSave:l}){return e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[e.jsxs(D,{variant:"outline",onClick:n,disabled:a===1||s,className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4"}),"Previous"]}),a<t?e.jsxs(D,{onClick:c,className:"flex items-center gap-2",disabled:s,children:["Next",e.jsx(Xe,{className:"h-4 w-4"})]}):e.jsx(D,{onClick:l,className:"bg-green-600 hover:bg-green-700",disabled:s,children:s?"Saving...":"Save Subcontract"})]})}function At({formData:a,currentStep:t,steps:s,isSaving:n,onClose:c,onPrev:l,onNext:i,onSave:r,children:o}){return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs(V,{className:"w-full max-w-6xl max-h-[90vh] overflow-auto",children:[e.jsxs(ce,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(le,{children:["Create New ",a.contractType==="ADD"?"Addendum":"Subcontract"]}),e.jsx(D,{variant:"ghost",size:"sm",onClick:c,children:e.jsx(pe,{className:"h-4 w-4"})})]}),e.jsx($t,{steps:s,currentStep:t})]}),e.jsxs(Y,{className:"space-y-6",children:[o,e.jsx(Et,{currentStep:t,stepsCount:s.length,isSaving:n,onPrev:l,onNext:i,onSave:r})]})]})})}function Ft(){const[a,t]=v.useState(1),[s,n]=v.useState({project:"",subcontractor:"",tradeItems:[],responsibilities:[],pdfFile:null,pdfUrl:"",dateOfIssuing:void 0,contractType:"subcontract",addendumNumber:"",parentSubcontractId:""}),[c,l]=v.useState(!1),i=["Project & Subcontractor","Trade & Items","Responsibilities","Documents & Review"];return{currentStep:a,formData:s,setFormData:n,isSaving:c,setIsSaving:l,steps:i,handleNext:m=>{m()&&t(b=>Math.min(b+1,i.length))},handlePrev:()=>{t(m=>Math.max(m-1,1))},getTotalAmount:()=>s.tradeItems.reduce((b,x)=>b+x.total,0)}}function Mt(){const{toast:a}=q();return{validateStep:(n,c)=>{switch(n){case 1:return!c.project||!c.subcontractor?(a({title:"Missing Information",description:"Please select both project and subcontractor",variant:"destructive"}),!1):c.contractType==="ADD"&&!c.parentSubcontractId?(a({title:"Missing Parent Contract",description:"Please select a parent subcontract for this addendum",variant:"destructive"}),!1):!0;case 2:return c.tradeItems.length===0?(a({title:"Missing Information",description:"Please add at least one trade item",variant:"destructive"}),!1):!0;case 3:return!0;default:return!0}},validateFinalSave:n=>!n.project||!n.subcontractor?(a({title:"Invalid Data",description:"Project and subcontractor must be selected",variant:"destructive"}),!1):n.contractType==="ADD"&&!n.parentSubcontractId?(a({title:"Invalid Addendum",description:"Parent subcontract must be selected for addendum",variant:"destructive"}),!1):!0}}function Rt({onClose:a,onSave:t}){const{toast:s}=q(),{trades:n,tradeItems:c,responsibilities:l}=M(),{currentStep:i,formData:r,setFormData:o,isSaving:d,setIsSaving:m,steps:b,handleNext:x,handlePrev:p,getTotalAmount:h}=Ft(),{validateStep:j,validateFinalSave:C}=Mt(),f=async()=>{if(!j(i,r)||!C(r))return;const S={contractId:"",project:r.project,subcontractor:r.subcontractor,tradeItems:r.tradeItems,responsibilities:r.responsibilities,totalValue:h(),status:"draft",startDate:new Date().toISOString().split("T")[0],endDate:new Date(Date.now()+30*24*60*60*1e3).toISOString().split("T")[0],dateOfIssuing:r.dateOfIssuing||new Date().toISOString().split("T")[0],description:`${r.contractType==="ADD"?"Addendum":"Subcontract"} for ${r.project} with ${r.subcontractor}`,pdfUrl:r.pdfUrl||void 0,contractType:r.contractType||"subcontract",addendumNumber:r.contractType==="ADD"&&r.addendumNumber||void 0,parentSubcontractId:r.contractType==="ADD"&&r.parentSubcontractId||void 0};try{m(!0),await t(S),s({title:"Success",description:`${r.contractType==="ADD"?"Addendum":"Subcontract"} saved and will appear in the table.`}),a()}catch(u){s({title:"Save failed",description:(u==null?void 0:u.message)||`Could not save ${r.contractType==="ADD"?"addendum":"subcontract"}.`,variant:"destructive"})}finally{m(!1)}},g=()=>{switch(i){case 1:return e.jsx(Dt,{formData:r,setFormData:o});case 2:return e.jsx(Le,{selectedItems:r.tradeItems,onItemsChange:S=>{o(u=>({...u,tradeItems:S}))},trades:n||[],tradeItems:c||[]});case 3:return e.jsx(Re,{selectedResponsibilities:r.responsibilities,onResponsibilitiesChange:S=>{o(u=>({...u,responsibilities:S}))},responsibilities:l||[]});case 4:return e.jsx(Pt,{formData:r,setFormData:o,totalAmount:h(),renderExtraFields:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block font-medium mb-1",children:"Date of Issuing"}),e.jsx("input",{type:"date",className:"border rounded px-3 py-2 w-full",value:r.dateOfIssuing||"",onChange:S=>{o(u=>({...u,dateOfIssuing:S.target.value}))},required:!0})]}),e.jsx("div",{className:"mt-4",children:e.jsx(kt,{formData:r,setFormData:o})})]})});default:return null}};return e.jsx(At,{formData:r,currentStep:i,steps:b,isSaving:d,onClose:a,onPrev:p,onNext:()=>{x(()=>j(i,r))},onSave:f,children:g()})}function Lt(){const a=$e(),t=Ee(),[s,n]=v.useState(!1),[c,l]=v.useState(null),{addSubcontract:i}=M(),{toast:r}=q(),{profile:o}=Ae(),d=(o==null?void 0:o.role)!=="viewer";v.useEffect(()=>{console.log("Subcontracts page - parsing URL parameters:",t.search),l(null);try{const p=new URLSearchParams(t.search),h={};if(p.get("month")&&(h.month=p.get("month"),console.log("Found month filter:",h.month)),p.get("year")&&(h.year=p.get("year"),console.log("Found year filter:",h.year)),p.get("location")&&(h.location=p.get("location"),console.log("Found location filter:",h.location)),p.get("trades")&&(h.trades=p.get("trades"),console.log("Found trades filter:",h.trades)),p.get("projectName")&&(h.projectName=decodeURIComponent(p.get("projectName")||""),console.log("Found projectName filter:",h.projectName)),p.get("projectCode")&&(h.projectCode=p.get("projectCode"),console.log("Found projectCode filter:",h.projectCode)),p.get("facilities"))try{const j=decodeURIComponent(p.get("facilities")||"");j!=null&&j.startsWith("[")&&j.endsWith("]")?h.facilities=JSON.parse(j):j?h.facilities=j.split(",").filter(C=>C.trim()):h.facilities=[],console.log("Found facilities filter:",h.facilities)}catch(j){console.error("Error parsing facilities parameter:",j),h.facilities=[]}console.log("Final parsed filters:",h),Object.keys(h).length>0?(l(h),console.log("Setting report filters:",h)):console.log("No filters found in URL")}catch(p){console.error("Error parsing URL parameters:",p),l(null)}},[t.search]);const m=()=>{if(console.log("Create new subcontract clicked, canModify:",d),!d){console.log("User cannot modify - showing toast"),r({title:"Access Denied",description:"You don't have permission to create subcontracts",variant:"destructive"});return}console.log("Opening stepper modal"),n(!0)},b=p=>{console.log("Viewing subcontract detail:",p),a(`/subcontracts/${p}`)},x=async p=>{console.log("handleSaveSubcontract called with data:",p);try{console.log("Calling addSubcontract..."),await i(p),console.log("addSubcontract completed successfully"),n(!1)}catch(h){console.error("Error in handleSaveSubcontract:",h)}};return console.log("Subcontracts page render - showStepper:",s,"canModify:",d),s?e.jsx(Rt,{onSave:x,onClose:()=>{console.log("Closing stepper"),n(!1)}}):e.jsx(wt,{onCreateNew:d?m:void 0,onViewDetail:b,reportFilters:c})}function ra(){return e.jsx(ke,{pageName:"Subcontracts",children:e.jsx(Lt,{})})}export{ra as Subcontracts};
