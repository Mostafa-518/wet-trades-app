import{j as e,B as p,F as ae,u as O,R as ne,C as E,a as R,b as B,c as z,I as y,r as d,T as le,d as ce,e as L,f as T,g as oe,h as S,i as U,A as re,L as I,k as ie,l as de,m as me,n as he,o as ue}from"./index-CUi0-ZAd.js";import{I as je}from"./ImportPreviewDialog-CfJ9E-rG.js";import{F as xe}from"./file-down-CfYx5t4c.js";import{S as fe}from"./search-V0kBukTT.js";import{T as $}from"./TableSelectionCheckbox-CyseAzl3.js";import{u as pe,P as ge}from"./PaginationControls-DM1boOLC.js";import{E as Ce}from"./eye-Cc6JYlaG.js";import{S as Pe}from"./square-pen-Dgoysi4y.js";import{T as be}from"./trash-2-D2XXXdCF.js";import{r as Ne,u as ve}from"./xlsx-CKN5doRT.js";import{S as M}from"./switch-j2Nk76Jn.js";import{P as we}from"./PermissionGuard-DBI3Qweg.js";import"./dialog-5aNDVFb2.js";import"./index-CYfJLrVV.js";function Se({onCreateNew:a,onImportClick:s}){return e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Projects"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{variant:"outline",onClick:s,children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Import Excel"]}),a&&e.jsxs(p,{onClick:a,children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Add Project"]})]})]})}function ye({searchFilters:a,onFilterChange:s,onClearFilters:x}){const{formValues:t,resetForm:o,getInputProps:n}=O(a,{customKey:"projects-filters",syncWithUrl:!0,debounceMs:200});ne.useEffect(()=>{Object.entries(t).forEach(([r,i])=>{a[r]!==i&&s(r,i)})},[t,a,s]);const l=()=>{o(),x()};return e.jsxs(E,{children:[e.jsx(R,{children:e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-5 w-5"}),"Search Filters"]})}),e.jsxs(z,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Project Name"}),e.jsx(y,{placeholder:"Search by project name...",...n("name")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Project Code"}),e.jsx(y,{placeholder:"Search by project code...",...n("code")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Location"}),e.jsx(y,{placeholder:"Search by location...",...n("location")})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(p,{variant:"outline",onClick:l,children:"Clear Filters"})})]})]})}function ke({selectedCount:a,onBulkDelete:s}){return a===0?null:e.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[e.jsxs("span",{children:[a," selected"]}),e.jsx(p,{variant:"destructive",size:"sm",onClick:s,className:"ml-2",children:"Delete Selected"})]})}const Fe=d.memo(function({project:s,isSelected:x,onToggleOne:t,onViewDetail:o,onEdit:n,onDelete:l}){const r=d.useCallback(()=>t(s.id),[t,s.id]),i=d.useCallback(()=>o(s.id),[o,s.id]),m=d.useCallback(()=>n==null?void 0:n(s),[n,s]),f=d.useCallback(()=>l==null?void 0:l(s.id),[l,s.id]);return e.jsxs(L,{children:[e.jsx(S,{children:e.jsx($,{checked:x,onCheckedChange:r,ariaLabel:`Select project ${s.name}`})}),e.jsx(S,{className:"font-medium",children:s.name}),e.jsx(S,{children:s.code}),e.jsx(S,{children:s.location}),e.jsx(S,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"outline",size:"sm",onClick:i,className:"h-8 w-8 p-0",children:e.jsx(Ce,{className:"h-4 w-4"})}),n&&e.jsx(p,{variant:"outline",size:"sm",onClick:m,className:"h-8 w-8 p-0",children:e.jsx(Pe,{className:"h-4 w-4"})}),l&&e.jsx(p,{variant:"outline",size:"sm",onClick:f,className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(be,{className:"h-4 w-4"})})]})})]},s.id)}),Te=d.memo(function({filteredProjects:s,selectedIds:x,allSelected:t,onToggleAll:o,onToggleOne:n,onViewDetail:l,onEdit:r,onDelete:i}){const{currentPage:m,totalPages:f,paginatedData:u,goToPage:C,hasNextPage:g,hasPreviousPage:N,totalItems:v,itemsPerPage:w}=pe({data:s,itemsPerPage:5});return e.jsxs(E,{children:[e.jsx(R,{children:e.jsxs(B,{children:["Projects (",s.length,")"]})}),e.jsxs(z,{className:"space-y-4",children:[e.jsx(ge,{currentPage:m,totalPages:f,onPageChange:C,hasNextPage:g,hasPreviousPage:N,totalItems:v,itemsPerPage:w}),e.jsxs(le,{children:[e.jsx(ce,{children:e.jsxs(L,{children:[e.jsx(T,{children:e.jsx($,{checked:t,onCheckedChange:o,ariaLabel:"Select all projects"})}),e.jsx(T,{children:"Project Name"}),e.jsx(T,{children:"Project Code"}),e.jsx(T,{children:"Location"}),e.jsx(T,{className:"text-right",children:"Actions"})]})}),e.jsxs(oe,{children:[u.map(P=>e.jsx(Fe,{project:P,isSelected:x.has(P.id),onToggleOne:n,onViewDetail:l,onEdit:r,onDelete:i},P.id)),u.length===0&&e.jsx(L,{children:e.jsx(S,{colSpan:5,className:"text-center py-8 text-muted-foreground",children:"No projects found."})})]})]})]})]})});function Ie(){const{projects:a,addProject:s,deleteProject:x}=U(),[t,o]=d.useState({name:"",code:"",location:""}),[n,l]=d.useState(new Set),[r,i]=d.useState(null),m=d.useRef(null),f=(c,h)=>{o(b=>({...b,[c]:h}))},u=()=>{o({name:"",code:"",location:""})},C=()=>{m.current&&(m.current.value="",m.current.click())},g=a.filter(c=>c.name.toLowerCase().includes(t.name.toLowerCase())&&c.code.toLowerCase().includes(t.code.toLowerCase())&&c.location.toLowerCase().includes(t.location.toLowerCase())),N=g.length>0&&g.every(c=>n.has(c.id)),v=()=>{l(N?new Set:new Set(g.map(c=>c.id)))},w=c=>{l(h=>{const b=new Set(h);return b.has(c)?b.delete(c):b.add(c),b})},P=async()=>{for(const c of n)await x(c);l(new Set)};function j(c){const h=c.trim().toLowerCase().replace(/[\s_]+/g,"");return h==="projectname"?"name":h==="projectcode"?"code":h==="projectlocation"?"location":{name:"name",code:"code",location:"location"}[h]||h}return{projects:a,searchFilters:t,selectedIds:n,importedData:r,fileInputRef:m,filteredProjects:g,allSelected:N,handleFilterChange:f,clearFilters:u,handleImportClick:C,toggleAll:v,toggleOne:w,handleBulkDelete:P,handleFileChange:async c=>{var q;const h=(q=c.target.files)==null?void 0:q[0];if(!h)return;const b=new FileReader;b.onload=G=>{var _;const W=new Uint8Array((_=G.target)==null?void 0:_.result),V=Ne(W,{type:"array"}),J=V.SheetNames[0],Q=V.Sheets[J],A=ve.sheet_to_json(Q,{header:1});if(!A||A.length<2){i([]);return}let[X,...Y]=A;const Z=X.map(k=>j(k)),ee=["name","code","location"],se=Y.filter(k=>k.some(F=>F!==void 0&&F!=="")).map(k=>{const F={};return Z.forEach((K,te)=>{ee.includes(K)&&(F[K]=k[te]??"")}),F});i(se)},b.readAsArrayBuffer(h)},handleImport:async c=>{for(const h of c)await s({name:h.name||"",code:h.code||"",location:h.location||""});i(null)},setImportedData:i}}const De=d.memo(function({onCreateNew:s,onViewDetail:x,onEdit:t,onDelete:o}){const{searchFilters:n,selectedIds:l,importedData:r,fileInputRef:i,filteredProjects:m,allSelected:f,handleFilterChange:u,clearFilters:C,handleImportClick:g,toggleAll:N,toggleOne:v,handleBulkDelete:w,handleFileChange:P,handleImport:j,setImportedData:D}=Ie(),H=d.useMemo(()=>[{key:"name",label:"Name"},{key:"code",label:"Code"},{key:"location",label:"Location"}],[]),c=d.useCallback(()=>D(null),[D]);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("input",{ref:i,type:"file",accept:".xlsx, .xls",className:"hidden",onChange:P,"data-testid":"import-excel-input"}),!!r&&r.length>0&&e.jsx(je,{open:!!r,data:r,columns:H,onImport:j,onClose:c}),e.jsx(Se,{onCreateNew:s,onImportClick:g}),e.jsx(ye,{searchFilters:n,onFilterChange:u,onClearFilters:C}),e.jsx(ke,{selectedCount:l.size,onBulkDelete:w}),e.jsx(Te,{filteredProjects:m,selectedIds:l,allSelected:f,onToggleAll:N,onToggleOne:v,onViewDetail:x,onEdit:t,onDelete:o})]})});function Ae({project:a,onSubmit:s,onCancel:x}){const t=!!a,{formValues:o,handleChange:n,resetForm:l,getInputProps:r,getSwitchProps:i}=O({name:"",code:"",location:"",saveAsDraft:!1,notifications:!0},{customKey:t?`project-edit-${a==null?void 0:a.id}`:"project-create",excludeFields:t?["saveAsDraft"]:[]});d.useEffect(()=>{a&&t&&(n("name",a.name),n("code",a.code),n("location",a.location))},[a,t,n]);const m=u=>{u.preventDefault();const C={name:o.name,code:o.code,location:o.location};s(C),t||l()},f=()=>{t||l(),x()};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(p,{variant:"outline",onClick:f,children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Back"]}),e.jsx("h1",{className:"text-3xl font-bold",children:t?"Edit Project":"Add New Project"})]}),e.jsxs(E,{children:[e.jsx(R,{children:e.jsxs(B,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Project Information"}),!t&&e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{...i("saveAsDraft")}),e.jsx(I,{children:"Save as Draft"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{...i("notifications")}),e.jsx(I,{children:"Enable Notifications"})]})]})]})}),e.jsx(z,{children:e.jsxs("form",{onSubmit:m,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"name",children:"Project Name *"}),e.jsx(y,{id:"name",placeholder:"Enter project name",required:!0,...r("name")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"code",children:"Project Code *"}),e.jsx(y,{id:"code",placeholder:"Enter project code",required:!0,...r("code")})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(I,{htmlFor:"location",children:"Location *"}),e.jsx(y,{id:"location",placeholder:"Enter project location",required:!0,...r("location")})]})]}),e.jsxs("div",{className:"flex gap-2 pt-6",children:[e.jsx(p,{type:"submit",children:t?"Update Project":o.saveAsDraft?"Save as Draft":"Create Project"}),e.jsx(p,{type:"button",variant:"outline",onClick:f,children:"Cancel"}),!t&&e.jsx(p,{type:"button",variant:"ghost",onClick:l,children:"Clear Form"})]})]})})]})]})}function Ge(){const a=ie(),s=de(),[x,t]=d.useState(!1),[o,n]=d.useState(null),{addProject:l,updateProject:r,deleteProject:i}=U(),{toast:m}=me(),{profile:f}=he(),{canModify:u}=ue();d.useEffect(()=>{var j;(j=s.state)!=null&&j.editProject&&(n(s.state.editProject),t(!0),a("/projects",{replace:!0}))},[s.state,a]);const C=()=>{u&&(n(null),t(!0))},g=j=>{a(`/projects/${j}`)},N=j=>{u&&(n(j),t(!0))},v=j=>{u&&(i(j),m({title:"Project deleted",description:"The project has been removed successfully."}))},w=j=>{o?(r(o.id,j),m({title:"Project updated",description:"The project has been updated successfully."})):(l(j),m({title:"Project created",description:"A new project has been created successfully."})),t(!1),n(null)},P=()=>{t(!1),n(null)};return x?e.jsx(Ae,{project:o,onSubmit:w,onCancel:P}):e.jsx(we,{permission:"manage_projects",children:e.jsx(De,{onCreateNew:u?C:void 0,onViewDetail:g,onEdit:u?N:void 0,onDelete:u?v:void 0})})}export{Ge as Projects};
