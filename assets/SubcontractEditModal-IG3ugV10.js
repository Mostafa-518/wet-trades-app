import{r as b,j as e,L as h,I as y,C as D,c as V,a as q,b as A,B as E,s as G,i as M,X as Y}from"./index-D134uT4X.js";import{T as H,a as Q,b as L,c as R}from"./tabs-B7wxapOa.js";import{u as W}from"./useSubcontractHelpers-D3m9CLlu.js";import{S as w,a as I,b as T,c as P,d as v}from"./select-DQMYkc78.js";import{T as _}from"./textarea-B4v8eKDD.js";import{S as $}from"./search-BISWe2fj.js";import{P as X}from"./plus-BxmlYX69.js";import{T as J}from"./trash-2-BlhGJAaj.js";const U=s=>new Intl.NumberFormat("en-US",{style:"currency",currency:"EGP",minimumFractionDigits:0}).format(s);function K({subcontracts:s,value:c,onChange:u,getProjectName:o,getSubcontractorName:a,className:x=""}){const[m,r]=b.useState(""),[l,S]=b.useState(!1),f=b.useMemo(()=>s.filter(n=>n.contractType==="subcontract"||!n.contractType),[s]),t=b.useMemo(()=>{if(!m.trim())return f;const n=m.toLowerCase();return f.filter(p=>{var g,N,z,B;const C=((g=p.contractId)==null?void 0:g.toLowerCase())||"",F=((N=a(p.subcontractor))==null?void 0:N.toLowerCase())||"",O=((z=o(p.project))==null?void 0:z.toLowerCase())||"",k=p.dateOfIssuing||"",d=((B=p.totalValue)==null?void 0:B.toString())||"";return C.includes(n)||F.includes(n)||O.includes(n)||k.includes(n)||d.includes(n)})},[f,m,o,a]),i=f.find(n=>n.id===c),j=n=>{if(!n)return"-";try{return new Date(n).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return n}};return e.jsxs("div",{className:`relative ${x}`,children:[e.jsx(h,{htmlFor:"parent-contract",children:"Parent Subcontract"}),e.jsxs("div",{className:"relative",children:[e.jsx(y,{id:"parent-contract",placeholder:"Search by contract number, supplier, project, date, or amount...",value:m,onChange:n=>{r(n.target.value),S(!0)},onFocus:()=>S(!0),className:"pr-10"}),e.jsx($,{className:"absolute right-3 top-3 h-4 w-4 text-muted-foreground"})]}),i&&e.jsx(D,{className:"mt-2 bg-blue-50 border-blue-200",children:e.jsx(V,{className:"p-3",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-blue-900",children:i.contractId}),e.jsxs("div",{className:"text-sm text-blue-700",children:[a(i.subcontractor)," • ",o(i.project)]}),e.jsxs("div",{className:"text-sm text-blue-600",children:[j(i.dateOfIssuing)," • ",U(i.totalValue||0)]})]}),e.jsx("button",{type:"button",onClick:()=>{u(""),r("")},className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"Change"})]})})}),l&&m&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto",children:t.length===0?e.jsx("div",{className:"p-3 text-center text-muted-foreground",children:"No matching contracts found"}):t.map(n=>e.jsxs("button",{type:"button",className:"w-full text-left p-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0",onClick:()=>{u(n.id),S(!1),r("")},children:[e.jsx("div",{className:"font-medium",children:n.contractId}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[a(n.subcontractor)," • ",o(n.project)]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[j(n.dateOfIssuing)," • ",U(n.totalValue||0)]})]},n.id))})]})}function Z({formData:s,setFormData:c,validProjects:u,validSubcontractors:o,subcontracts:a,getProjectName:x,getSubcontractorName:m}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"contractId",children:"Contract ID"}),e.jsx(y,{id:"contractId",value:s.contractId,onChange:r=>c(l=>({...l,contractId:r.target.value})),placeholder:"Enter contract ID"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"contractType",children:"Contract Type"}),e.jsxs(w,{value:s.contractType,onValueChange:r=>c(l=>({...l,contractType:r})),children:[e.jsx(I,{children:e.jsx(T,{})}),e.jsxs(P,{children:[e.jsx(v,{value:"subcontract",children:"Subcontract"}),e.jsx(v,{value:"ADD",children:"Addendum"})]})]})]}),s.contractType==="ADD"&&e.jsx(K,{subcontracts:a,value:s.parentSubcontractId,onChange:r=>c(l=>({...l,parentSubcontractId:r})),getProjectName:x,getSubcontractorName:m}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"project",children:"Project"}),e.jsxs(w,{value:s.project,onValueChange:r=>c(l=>({...l,project:r})),children:[e.jsx(I,{children:e.jsx(T,{placeholder:"Select project"})}),e.jsx(P,{children:u.map(r=>e.jsxs(v,{value:r.id,children:[r.name," - ",r.code]},r.id))})]})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"subcontractor",children:"Subcontractor"}),e.jsxs(w,{value:s.subcontractor,onValueChange:r=>c(l=>({...l,subcontractor:r})),children:[e.jsx(I,{children:e.jsx(T,{placeholder:"Select subcontractor"})}),e.jsx(P,{children:o.map(r=>e.jsx(v,{value:r.id,children:r.companyName},r.id))})]})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"status",children:"Status"}),e.jsxs(w,{value:s.status,onValueChange:r=>c(l=>({...l,status:r})),children:[e.jsx(I,{children:e.jsx(T,{})}),e.jsxs(P,{children:[e.jsx(v,{value:"draft",children:"Draft"}),e.jsx(v,{value:"pending",children:"Pending"}),e.jsx(v,{value:"active",children:"Active"}),e.jsx(v,{value:"completed",children:"Completed"}),e.jsx(v,{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"totalValue",children:"Total Value (Calculated without wastage)"}),e.jsx(y,{id:"totalValue",type:"number",value:s.totalValue,readOnly:!0,className:"bg-gray-50",placeholder:"Auto-calculated from trade items"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"This value is calculated as QTY × Rate for all trade items (excluding wastage)"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"startDate",children:"Start Date"}),e.jsx(y,{id:"startDate",type:"date",value:s.startDate,onChange:r=>c(l=>({...l,startDate:r.target.value}))})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"endDate",children:"End Date"}),e.jsx(y,{id:"endDate",type:"date",value:s.endDate,onChange:r=>c(l=>({...l,endDate:r.target.value}))})]})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"dateOfIssuing",children:"Date of Issuing"}),e.jsx(y,{id:"dateOfIssuing",type:"date",value:s.dateOfIssuing,onChange:r=>c(l=>({...l,dateOfIssuing:r.target.value}))})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"description",children:"Description"}),e.jsx(_,{id:"description",value:s.description,onChange:r=>c(l=>({...l,description:r.target.value})),placeholder:"Enter description",rows:3})]})]})}function ee({selectedItems:s,onItemsChange:c,trades:u,tradeItems:o}){const[a,x]=b.useState({trade:"",item:"",quantity:"",unitPrice:"",wastagePercentage:"0"}),m=t=>(o==null?void 0:o.filter(i=>i.trade_id===t))||[],r=()=>!a.trade||!a.item?null:(o==null?void 0:o.find(t=>t.trade_id===a.trade&&t.name===a.item))||null,l=()=>{const t=r(),i=u==null?void 0:u.find(O=>O.id===a.trade),j=parseFloat(a.quantity),n=parseFloat(a.unitPrice),p=parseFloat(a.wastagePercentage)||0;if(!t||!i||j<=0||n<=0)return;const C=j*n,F={id:`temp-${Date.now()}`,trade:i.name,item:t.name,unit:t.unit||"",quantity:j,unitPrice:n,total:C,wastagePercentage:p};c([...s||[],F]),x({trade:"",item:"",quantity:"",unitPrice:"",wastagePercentage:"0"})},S=t=>{c((s||[]).filter(i=>i.id!==t))},f=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"EGP",minimumFractionDigits:0}).format(t);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(D,{children:[e.jsx(q,{children:e.jsx(A,{children:"Add Trade Item"})}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{children:"Trade"}),e.jsxs(w,{value:a.trade,onValueChange:t=>x(i=>({...i,trade:t,item:""})),children:[e.jsx(I,{children:e.jsx(T,{placeholder:"Select trade"})}),e.jsx(P,{children:(u||[]).map(t=>e.jsx(v,{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{children:[e.jsx(h,{children:"Item"}),e.jsxs(w,{value:a.item,onValueChange:t=>x(i=>({...i,item:t})),disabled:!a.trade,children:[e.jsx(I,{children:e.jsx(T,{placeholder:"Select item"})}),e.jsx(P,{children:m(a.trade).map(t=>e.jsxs(v,{value:t.name,children:[t.name," (",t.unit,")"]},t.id))})]})]}),e.jsxs("div",{children:[e.jsx(h,{children:"Quantity"}),e.jsx(y,{type:"number",value:a.quantity,onChange:t=>x(i=>({...i,quantity:t.target.value})),placeholder:"Enter quantity"})]}),e.jsxs("div",{children:[e.jsx(h,{children:"Unit Price (EGP)"}),e.jsx(y,{type:"number",value:a.unitPrice,onChange:t=>x(i=>({...i,unitPrice:t.target.value})),placeholder:"Enter unit price"})]}),e.jsxs("div",{children:[e.jsx(h,{children:"Wastage %"}),e.jsx(y,{type:"number",value:a.wastagePercentage,onChange:t=>x(i=>({...i,wastagePercentage:t.target.value})),placeholder:"Enter wastage percentage",min:"0"})]})]}),e.jsxs(E,{onClick:l,className:"w-full",disabled:!a.trade||!a.item||!a.quantity||!a.unitPrice,children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Add Item"]})]})]}),(s||[]).length>0&&e.jsxs(D,{children:[e.jsx(q,{children:e.jsxs(A,{children:["Selected Items (",(s||[]).length,")"]})}),e.jsxs(V,{children:[e.jsx("div",{className:"space-y-3",children:(s||[]).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium",children:[t.trade," - ",t.item]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[t.quantity," ",t.unit," × ",f(t.unitPrice),(t.wastagePercentage||0)>0&&e.jsxs("span",{className:"ml-2 text-orange-600",children:["(Wastage: ",t.wastagePercentage,"%)"]})]}),e.jsxs("div",{className:"text-sm font-medium text-green-600",children:["Total: ",f(t.total)]})]}),e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>S(t.id),className:"text-red-600 hover:text-red-700",children:e.jsx(J,{className:"h-4 w-4"})})]},t.id))}),e.jsx("div",{className:"mt-4 p-4 bg-green-50 rounded-lg border border-green-200",children:e.jsxs("div",{className:"text-lg font-bold text-green-800",children:["Contract Total: ",f((s||[]).reduce((t,i)=>t+i.total,0))]})})]})]})]})}function te({selectedResponsibilities:s,onResponsibilitiesChange:c,responsibilities:u}){const o=a=>{const x=s||[],m=x.includes(a)?x.filter(r=>r!==a):[...x,a];c(m)};return e.jsxs(D,{children:[e.jsx(q,{children:e.jsx(A,{children:"Assign Responsibilities"})}),e.jsx(V,{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(h,{children:"Select Responsibilities (Optional)"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Select responsibilities that apply to this subcontract. You can skip this step if no specific responsibilities are needed."}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:(u||[]).map(a=>e.jsx(E,{variant:(s||[]).includes(a.name)?"default":"outline",size:"sm",onClick:()=>o(a.name),className:"justify-start",children:a.name},a.id))}),(s||[]).length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-3",children:(s||[]).map(a=>e.jsx(G,{variant:"secondary",children:a},a))}),(s||[]).length===0&&e.jsx("p",{className:"text-sm text-gray-500 mt-3 italic",children:"No responsibilities selected. You can proceed without selecting any responsibilities."})]})})]})}function se({subcontract:s,onSave:c,onClose:u}){const{projects:o,subcontractors:a,subcontracts:x,trades:m,tradeItems:r,responsibilities:l}=M(),{getProjectName:S,getSubcontractorName:f}=W(),[t,i]=b.useState({contractId:"",project:"",subcontractor:"",status:"draft",totalValue:0,startDate:"",endDate:"",dateOfIssuing:"",description:"",contractType:"subcontract",parentSubcontractId:""}),[j,n]=b.useState([]),[p,C]=b.useState([]),F=(o||[]).filter(d=>d.id&&d.name&&d.id.trim()!==""&&d.name.trim()!==""),O=(a||[]).filter(d=>d.id&&d.companyName&&d.id.trim()!==""&&d.companyName.trim()!=="");b.useEffect(()=>{if(s){const d=(s.tradeItems||[]).reduce((g,N)=>g+(N.quantity||0)*(N.unitPrice||0),0);i({contractId:s.contractId||"",project:s.project||"",subcontractor:s.subcontractor||"",status:s.status||"draft",totalValue:d,startDate:s.startDate||"",endDate:s.endDate||"",dateOfIssuing:s.dateOfIssuing||"",description:s.description||"",contractType:s.contractType||"subcontract",parentSubcontractId:s.parentSubcontractId||""}),n(s.tradeItems||[]),C(s.responsibilities||[])}},[s]),b.useEffect(()=>{const d=(j||[]).reduce((g,N)=>g+(N.quantity||0)*(N.unitPrice||0),0);i(g=>({...g,totalValue:d}))},[j]);const k=async d=>{d.preventDefault();try{const g={...t,tradeItems:j||[],responsibilities:p||[]};await c(s.id,g),u()}catch{}};return e.jsxs("form",{onSubmit:k,className:"space-y-6",children:[e.jsxs(H,{defaultValue:"basic",className:"w-full",children:[e.jsxs(Q,{className:"grid w-full grid-cols-3",children:[e.jsx(L,{value:"basic",children:"Basic Info"}),e.jsxs(L,{value:"trades",children:["Trade Items (",(j||[]).length,")"]}),e.jsxs(L,{value:"responsibilities",children:["Responsibilities (",(p||[]).length,")"]})]}),e.jsx(R,{value:"basic",className:"space-y-4",children:e.jsxs(D,{children:[e.jsx(q,{children:e.jsx(A,{children:"Basic Information"})}),e.jsx(V,{children:e.jsx(Z,{formData:t,setFormData:i,validProjects:F,validSubcontractors:O,subcontracts:x||[],getProjectName:S,getSubcontractorName:f})})]})}),e.jsx(R,{value:"trades",className:"space-y-4",children:e.jsx(ee,{selectedItems:j||[],onItemsChange:d=>{n(d)},trades:m||[],tradeItems:r||[]})}),e.jsx(R,{value:"responsibilities",className:"space-y-4",children:e.jsx(te,{selectedResponsibilities:p||[],onResponsibilitiesChange:d=>{C(d)},responsibilities:l||[]})})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx(E,{type:"button",variant:"outline",onClick:u,children:"Cancel"}),e.jsx(E,{type:"submit",children:"Save Changes"})]})]})}function ue({subcontract:s,open:c,onClose:u,onSave:o}){return c?e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs(D,{className:"w-full max-w-2xl max-h-[90vh] overflow-auto",children:[e.jsx(q,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{children:"Edit Subcontract"}),e.jsx(E,{variant:"ghost",size:"sm",onClick:u,children:e.jsx(Y,{className:"h-4 w-4"})})]})}),e.jsx(V,{children:e.jsx(se,{subcontract:s,onSave:o,onClose:u})})]})}):null}export{te as R,ue as S,ee as T,U as f};
